<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.269">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Galen Holt">

<title>Using the WERP toolkit - Scaling functions</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Using the WERP toolkit</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../scenario_creation/scenario_creation_overview.html">
 <span class="menu-text">Scenario creation</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../causal_networks/causal_overview.html">
 <span class="menu-text">Causal networks</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../controller/controller_overview.html">
 <span class="menu-text">Controller</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../aggregator/aggregation_overview.html">
 <span class="menu-text">Aggregator</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../comparer/comparer_overview.html">
 <span class="menu-text">Comparer</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../full_toolkit/full_toolkit_overview.html">
 <span class="menu-text">Full toolkit</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/MDBAuth/WERP_toolkit_demo"><i class="bi bi-github" role="img" aria-label="GitHub">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
              <div class="quarto-toggle-container">
                  <a href="" class="quarto-color-scheme-toggle nav-link" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
              </div>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#setting-up-the-scaling-functions" id="toc-setting-up-the-scaling-functions" class="nav-link active" data-scroll-target="#setting-up-the-scaling-functions">Setting up the scaling functions</a></li>
  <li><a href="#background-and-definitions" id="toc-background-and-definitions" class="nav-link" data-scroll-target="#background-and-definitions">Background and definitions</a>
  <ul class="collapse">
  <li><a href="#make-numeric-metadata" id="toc-make-numeric-metadata" class="nav-link" data-scroll-target="#make-numeric-metadata">Make numeric metadata</a></li>
  </ul></li>
  <li><a href="#bring-in-the-data" id="toc-bring-in-the-data" class="nav-link" data-scroll-target="#bring-in-the-data">Bring in the data</a></li>
  <li><a href="#scale" id="toc-scale" class="nav-link" data-scroll-target="#scale">Scale</a></li>
  <li><a href="#testing" id="toc-testing" class="nav-link" data-scroll-target="#testing">Testing</a>
  <ul class="collapse">
  <li><a href="#rank" id="toc-rank" class="nav-link" data-scroll-target="#rank">Rank</a></li>
  <li><a href="#prob-dists" id="toc-prob-dists" class="nav-link" data-scroll-target="#prob-dists">Prob dists</a></li>
  <li><a href="#rank-replacement" id="toc-rank-replacement" class="nav-link" data-scroll-target="#rank-replacement">Rank-replacement</a></li>
  <li><a href="#re-build-data-cleanly" id="toc-re-build-data-cleanly" class="nav-link" data-scroll-target="#re-build-data-cleanly">Re-build data cleanly</a></li>
  <li><a href="#check-plots" id="toc-check-plots" class="nav-link" data-scroll-target="#check-plots">Check plots</a></li>
  </ul></li>
  <li><a href="#regression-bias-correction" id="toc-regression-bias-correction" class="nav-link" data-scroll-target="#regression-bias-correction">Regression bias correction</a></li>
  <li><a href="#distribution-shifting" id="toc-distribution-shifting" class="nav-link" data-scroll-target="#distribution-shifting">Distribution shifting</a>
  <ul class="collapse">
  <li><a href="#the-model-distributions" id="toc-the-model-distributions" class="nav-link" data-scroll-target="#the-model-distributions">The model distributions</a>
  <ul class="collapse">
  <li><a href="#fitting-censored-data" id="toc-fitting-censored-data" class="nav-link" data-scroll-target="#fitting-censored-data">Fitting censored data</a></li>
  <li><a href="#shifting-up" id="toc-shifting-up" class="nav-link" data-scroll-target="#shifting-up">Shifting up</a></li>
  <li><a href="#optimized-upshifts" id="toc-optimized-upshifts" class="nav-link" data-scroll-target="#optimized-upshifts">Optimized upshifts</a></li>
  </ul></li>
  <li><a href="#shifting-between-distributions" id="toc-shifting-between-distributions" class="nav-link" data-scroll-target="#shifting-between-distributions">Shifting between distributions</a></li>
  </ul></li>
  <li><a href="#scaling-dists" id="toc-scaling-dists" class="nav-link" data-scroll-target="#scaling-dists">Scaling dists</a></li>
  <li><a href="#additional-approaches" id="toc-additional-approaches" class="nav-link" data-scroll-target="#additional-approaches">Additional approaches</a>
  <ul class="collapse">
  <li><a href="#fit-dists-but-different-function" id="toc-fit-dists-but-different-function" class="nav-link" data-scroll-target="#fit-dists-but-different-function">Fit dists, but different function</a></li>
  <li><a href="#linearize-part-of-the-model-data-relationship-not-all-of-it" id="toc-linearize-part-of-the-model-data-relationship-not-all-of-it" class="nav-link" data-scroll-target="#linearize-part-of-the-model-data-relationship-not-all-of-it">Linearize part of the model-data relationship, not all of it</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Scaling functions</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Galen Holt </p>
          </div>
  </div>
    
  
    
  </div>
  

</header>

<section id="setting-up-the-scaling-functions" class="level2">
<h2 class="anchored" data-anchor-id="setting-up-the-scaling-functions">Setting up the scaling functions</h2>
<p>I’m using <a href="flow_scaling.qmd">flow_scaling.qmd</a> to pull the gauges and scale them, but actually getting the scaling relationships is independent, and so doesn’t need to happen in the same script. I’ll do that here.</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-1_e96156907243b2f3f142dc3058b25a47">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(werptoolkitr)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'dplyr'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:stats':

    filter, lag</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:base':

    intersect, setdiff, setequal, union</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: timechange</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'lubridate'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:base':

    date, intersect, setdiff, union</code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(vicwater)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(fitdistrplus)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'fitdistrplus' was built under R version 4.2.3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: MASS</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'MASS'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:patchwork':

    area</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:dplyr':

    select</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: survival</code></pre>
</div>
</div>
<p>Set up some directories. Once we move to MDBA, these will be easier to point at in a shared way.</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-2_6c71a517abd75018e61c5923c7774a5e">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>scenario_dir <span class="ot">&lt;-</span> <span class="st">'../flow_scaling_data'</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>hydro_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(scenario_dir, <span class="st">'hydrographs'</span>)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>scaling_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(scenario_dir, <span class="st">'CC_Scenarios_WRPs'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="background-and-definitions" class="level2">
<h2 class="anchored" data-anchor-id="background-and-definitions">Background and definitions</h2>
<p>Bring in David’s climate scenarios NOTE: Only go to 31-Jan-2019.</p>
<p>Prec and ETp (PE) are historical (not needed here)</p>
<p>SimR0 is simulated historical runnoff using actual historical Prec and ETp (PE)</p>
<p>SimR1 - SimR7 are simulated with +7% PE but different Rainfall:</p>
<ol type="1">
<li><p>-20%</p></li>
<li><p>-15% (“High change scenario”)</p></li>
<li><p>-10%</p></li>
<li><p>-5% (“Moderate change scenario”)</p></li>
<li><p>+0%</p></li>
<li><p>+5% (“Low change scenario”)</p></li>
<li><p>+10%</p></li>
</ol>
<section id="make-numeric-metadata" class="level3">
<h3 class="anchored" data-anchor-id="make-numeric-metadata">Make numeric metadata</h3>
<p>The format of this may change, but we’re going to want something. Lists are going to be easier to yaml than dataframes (though a dataframe is easier to construct).</p>
<p>Though it sounds like the scenario yamls are likely to <em>not</em> be lists, but single values, ie each one gets their own value to create it, and that’s it (which makes sense).</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-3_3910e18846d8f87e01fa15e333199712">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>rain_multiplier <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="fl">0.8</span>, <span class="at">to =</span> <span class="fl">1.1</span>, <span class="at">by =</span> <span class="fl">0.05</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setNames</span>(<span class="fu">paste0</span>(<span class="st">'R'</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>))</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>scenario_meta <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">PE_multiplier =</span> <span class="fl">1.07</span>,</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">rain_multiplier =</span> rain_multiplier,</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">scenario_name =</span> <span class="fu">names</span>(rain_multiplier)</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Don't run yet, since I don't know the format we'll be using, but this works to create yaml metadata</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="co"># yaml::write_yaml(scenario_meta, file = 'path/to/file.yml')</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Suggestion is to compare each scenario to simulated historic baseline, work out the ratio and apply the difference to the gauge records… Would be good to get ‘cease to flow’ events for the scenarios.</p>
</section>
</section>
<section id="bring-in-the-data" class="level2">
<h2 class="anchored" data-anchor-id="bring-in-the-data">Bring in the data</h2>
<p>Get the list of files and read them in (to a list of dfs)</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-4_dec495c28383b0d788a558c1ed91b969">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>CCSc_FileList <span class="ot">&lt;-</span> <span class="fu">list.files</span>(scaling_dir, <span class="at">pattern =</span> <span class="st">'.csv'</span>, </span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>                            <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>scenario_list <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map</span>(CCSc_FileList,</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>                            \(x) <span class="fu">read_csv</span>(<span class="at">file =</span> x, <span class="at">id =</span> <span class="st">'path'</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setNames</span>(stringr<span class="sc">::</span><span class="fu">str_extract</span>(CCSc_FileList, <span class="st">"SS[0-9]+"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="scale" class="level2">
<h2 class="anchored" data-anchor-id="scale">Scale</h2>
<p>David’s email</p>
<p>Have given this some thought and think I’ve come up with a practical solution.</p>
<p>I think the easiest way will be to</p>
<ol type="a">
<li><p>Compute ranks/percentiles for both the observed and modelled future time series</p></li>
<li><p>Construct a new time series based on the observed ranks and replaces the observed values with the corresponding value for the same rank in the future time series.</p></li>
</ol>
<p>This will give us a new future time series but if the distributions of the historical modelled and observed time series are different then the time series will not be a realistic representation of the future observations. So then my suggestion is to bias-correct the new future time series to make it look like a future observations time series.</p>
<p>To do the bias correction my thought is to set up a regression model between the observations and historical time series where we fudge it to deal with the zero-value problem.</p>
<p>Assuming that the flow time series are roughly log-normally distributed, we can set up a regression between the values of corresponding ranks Log(obs<sub>r</sub> + delta) = a + b*log(model<sub>r</sub> + delta)</p>
<p>Where:</p>
<p>obs<sub>r</sub> is the observation for rank r</p>
<p>model<sub>r</sub> is the modelled value of rank r</p>
<p>delta is a small non-zero value 0.1 or 0.01, probably the latter</p>
<p>a and b are the regression coefficients.</p>
<p>When fitting the regression to the observations and historical (no change) streamflow we set all the values where obs = 0 to missing.&nbsp; I don’t think that the model output will have zero values given they are area-weighted averages of gridded data</p>
<p>When applying the regression to correct bias in the new future time series, then we are likely to generate negative values that can just be reset to zero.</p>
<p>I think that the above will also allow for the probability of zero values to increase or decrease, as the modelled time series shouldn’t have zero values in it…</p>
</section>
<section id="testing" class="level1">
<h1>Testing</h1>
<p>I’m going to figure out how to do this with a single hydrograph and scenario to make sure it works and then roll it out how I already rolled out the q-q version</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-5_ef375b0c71a947e3bf09b1b833cf5c8b">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>test_model <span class="ot">&lt;-</span> scenario_list<span class="sc">$</span>SS20</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>orig_hydro <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">file.path</span>(hydro_dir, <span class="st">'extracted_flows.rds'</span>))</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>test_hydro <span class="ot">&lt;-</span> orig_hydro[[<span class="dv">20</span>]]</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co"># save that so we don't have to pass this around as we clean things up</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(test_hydro, test_model, </span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>     <span class="at">file =</span> <span class="fu">file.path</span>(<span class="st">'scenario_creation'</span>, <span class="st">'test_scaling.rdata'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I’m going to continue with monthly binning, but we could just drop the binning if it gets too complicated or we don’t have the data to support it But we know the hydrographs will behave differently throughout the year, so might as well let them. Months will introduce artificial discontinuities, but we aren’t trying to be perfect.Month-matching makes more sense to create statistics that are at least partially reflective of the major changes through the water year- e.g.&nbsp;it is useful to know the 90th percentile for the low points of the year too, and we’d never see that if we just pooled the data.</p>
<p>I think I’ll ignore monthly binning while sorting out the method though</p>
<section id="rank" class="level3">
<h3 class="anchored" data-anchor-id="rank">Rank</h3>
<p>Model</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-6_b0e58772de9f1a926ea3e5bfca0a7662">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>test_model <span class="ot">&lt;-</span> test_model <span class="sc">%&gt;%</span> </span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">histrank =</span> <span class="fu">rank</span>(SimR0)) <span class="sc">%&gt;%</span> </span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date =</span> lubridate<span class="sc">::</span><span class="fu">make_date</span>(Year, Month, Day))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Double check runoff timeseries</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-7_e2d95cb4e2a1ee51c94decf331463c40">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>test_model <span class="sc">%&gt;%</span> </span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> SimR0)) <span class="sc">+</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="scaling_zeros_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>and the ranking</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-8_07bef563f593884c2c2e8788f2f17150">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>test_model <span class="sc">%&gt;%</span> </span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> histrank, <span class="at">y =</span> SimR0)) <span class="sc">+</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="scaling_zeros_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Hydrograph</p>
<p>Drop bad codes</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-9_fc0de713210d0821d2937effec289b3e">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>qc_limit <span class="ot">&lt;-</span> <span class="dv">150</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>test_hydro <span class="ot">&lt;-</span> test_hydro <span class="sc">%&gt;%</span> </span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">hyd_vals =</span> <span class="fu">ifelse</span>(quality_codes_id <span class="sc">&gt;</span> qc_limit, <span class="cn">NA</span>, value)) <span class="sc">%&gt;%</span> </span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">hydrank =</span> <span class="fu">rank</span>(hyd_vals))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Are there zeros?</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-10_fcc9cefe5bc21f472368f2d5dd8631f9">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(test_hydro<span class="sc">$</span>hyd_vals <span class="sc">==</span> <span class="dv">0</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2820</code></pre>
</div>
</div>
<p>Check hydrograph and show where the 0 are.</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-11_a190decd377ec3824b8eb52f8a0bd2c3">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(test_hydro, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> hyd_vals)) <span class="sc">+</span> <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> <span class="fu">filter</span>(test_hydro, hyd_vals <span class="sc">==</span> <span class="dv">0</span>), <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">color =</span> hyd_vals <span class="sc">==</span> <span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1 row containing missing values (`geom_line()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="scaling_zeros_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>and the ranking</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-12_77e49d62fd64c8d5a09b26a85d0e00d2">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>test_hydro <span class="sc">%&gt;%</span> </span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> hydrank, <span class="at">y =</span> hyd_vals)) <span class="sc">+</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1564 rows containing missing values (`geom_line()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="scaling_zeros_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="prob-dists" class="level2">
<h2 class="anchored" data-anchor-id="prob-dists">Prob dists</h2>
<p>Before we even get to the replacing and unbiasing, what do those probability distributions look like? Are they remotely similar? Logging the data- loses the 0s but this is just a quick look</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-13_33d5dd34cb568a90023a0428d4f79eeb">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># hyddens &lt;- test_hydro %&gt;% </span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="co"># ggplot(aes(x = log(hyd_vals))) +</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="co">#   geom_density()</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="co"># scenedens &lt;- test_model %&gt;% </span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="co">#   ggplot(aes(x = log(SimR0))) +</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="co">#   geom_density()</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a><span class="co"># hyddens + scenedens</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a><span class="fu">geom_density</span>(<span class="at">data =</span> test_model, </span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>             <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(SimR0)), <span class="at">color =</span> <span class="st">'dodgerblue'</span>) <span class="sc">+</span> </span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">data =</span> test_hydro, </span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>               <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(hyd_vals)), <span class="at">color =</span> <span class="st">'forestgreen'</span>) <span class="sc">+</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">'log(value)'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 4384 rows containing non-finite values (`stat_density()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="scaling_zeros_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>And the cdfs</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-14_3e531f4a888cd4918f54dbab2c39bb6a">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="fu">stat_ecdf</span>(<span class="at">data =</span> test_model, </span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>             <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(SimR0)), <span class="at">color =</span> <span class="st">'dodgerblue'</span>) <span class="sc">+</span> </span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ecdf</span>(<span class="at">data =</span> test_hydro, </span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(hyd_vals)), <span class="at">color =</span> <span class="st">'forestgreen'</span>) <span class="sc">+</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">'log(value)'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 4384 rows containing non-finite values (`stat_ecdf()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="scaling_zeros_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Quite a bit different. And slightly trimodal, though not nearly as pronounced as orig_hydros[[25]].</p>
</section>
<section id="rank-replacement" class="level2">
<h2 class="anchored" data-anchor-id="rank-replacement">Rank-replacement</h2>
<p>This replaces the values of rank x in the past hydro with values of rank x in modelled. It therefore gets the <em>sequence</em> of the real hydrograph, but the <em>distribution</em> of the modelled runoff.</p>
<p>We need to deal with duplicate ranks. The most common will be zeros in the hydrograph, but they could occur in the modelled data too.</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-15_60958a5468d1d0114bb11c08201228ae">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(<span class="fu">duplicated</span>(test_hydro<span class="sc">$</span>hydrank))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 14473</code></pre>
</div>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(<span class="fu">duplicated</span>(test_model<span class="sc">$</span>histrank))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 178</code></pre>
</div>
</div>
<p>The modelled data is not duplicated on 0, necessarily</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-16_53996f0b3b2bf368a3a2928a0d56ea18">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>test_model <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(histrank) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">nr =</span> <span class="fu">n</span>(), <span class="at">val =</span> <span class="fu">first</span>(SimR0)) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(nr <span class="sc">&gt;</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 177 × 3
   histrank    nr     val
      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt;
 1     380.     2 0.00394
 2     394.     2 0.00395
 3    1534.     2 0.00512
 4    1546.     2 0.00514
 5    1608.     2 0.00519
 6    2130.     2 0.00567
 7    2240.     2 0.00577
 8    2362.     2 0.00588
 9    3106.     2 0.00649
10    3118.     2 0.00649
# … with 167 more rows</code></pre>
</div>
</div>
<p>The hydrographs are usually 0 duplication, but not always</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-17_1bf1bc874308ae2c6cda0015b01074e0">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>test_hydro <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(hydrank) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">nr =</span> <span class="fu">n</span>(), <span class="at">val =</span> <span class="fu">first</span>(hyd_vals)) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(nr <span class="sc">&gt;</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2,574 × 3
   hydrank    nr   val
     &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt;
 1   1410.  2820 0    
 2   2824.     6 0.001
 3   2830.     6 0.002
 4   2834.     2 0.004
 5   2838      5 0.011
 6   2848.     2 0.33 
 7   2852      3 0.799
 8   2856.     2 1.18 
 9   2862.     4 1.37 
10   2868.     2 1.67 
# … with 2,564 more rows</code></pre>
</div>
</div>
<p>Is this fundamentally the same issue as the data length issue below? We have x ranks in the hydrograph, and x + z ranks in the model. So all the data with rank d (duplicated) should get the same value, which is the same issue as if there were only one value of d and just fewer datapoints in the hydrograph than the data. One argument against the median for the ranks as I suggest is that when 0 is duplicated, we would end up pushing the median of several ranks to it instead of the minimum.</p>
<p>And we need to deal with two situations of data length- hydrographs longer than model, and model longer than hydrograph (more typical). In the first, we need to duplicately assign model rank-values. In the second, we need to assign multiple ranks to a single rank. Maybe the median. Or we can use quantiles instead of ranks to break it up into the same size chunks.</p>
<p>Simple code for rank-replacing. will need to modify</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-18_84f5315c216fc14fa2ec6743534cd648">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">vals =</span> <span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">1</span>,<span class="dv">3</span>), <span class="at">ranks =</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">vals =</span> <span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">3</span>,<span class="dv">8</span>), <span class="at">ranks =</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">3</span>))</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>bina <span class="ot">&lt;-</span> <span class="fu">match</span>(b<span class="sc">$</span>ranks, a<span class="sc">$</span>ranks)</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>b<span class="sc">$</span>vala <span class="ot">&lt;-</span> a<span class="sc">$</span>vals[bina]</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>b</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 3
   vals ranks  vala
  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1     4     2     3
2     3     1     1
3     8     3     5</code></pre>
</div>
</div>
<p>And the duplication issues. I’m going to move away from tibbles, we can do this with <code>$</code> and <code>[]</code> more generally to end up with a function. We might still apply that with a mutate to do the grouping though.</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-19_9bf05649c9205e2cb416b6f1dc5aa412">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>h <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">4</span>,<span class="dv">8</span>,<span class="dv">5</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>, <span class="cn">NA</span>)</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">6</span>,<span class="dv">10</span>,<span class="dv">9</span>,<span class="dv">9</span>,<span class="dv">4</span>,<span class="dv">7</span>,<span class="dv">2</span>,<span class="dv">5</span>,<span class="cn">NA</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">6</span>,<span class="dv">9</span>,<span class="dv">5</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">10</span>,<span class="dv">9</span>,<span class="dv">4</span>)</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>rankh <span class="ot">&lt;-</span> <span class="fu">rank</span>(h, <span class="at">na.last =</span> <span class="st">'keep'</span>)</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>rankm <span class="ot">&lt;-</span> <span class="fu">rank</span>(m, <span class="at">na.last =</span> <span class="st">'keep'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There’s not actually a clean way to get rankings that aren’t affected by duplication- <code>ties.method</code> first, last, min and max all end up giving each value a different rank and skipping numbers depending on how many dups there are at a given level, and average gives all duplicated values the same rank (good), but skips ranks based on how many duplicates there are. Which isn’t good- we will have different numbers of duplicates in the two datasets.</p>
<p>So, we need to cut to unique values, rank them, and use those rankings. Use <code>na.last = 'keep'</code> to not give NAs unique rankings. Though it would also work to drop NA when we get the unique values.</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-20_6c932b41c8e6f5c35ca6de9d53c5aba5">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>hu <span class="ot">&lt;-</span> <span class="fu">unique</span>(h)</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>mu <span class="ot">&lt;-</span> <span class="fu">unique</span>(m)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>rhu <span class="ot">&lt;-</span> <span class="fu">rank</span>(hu, <span class="at">na.last =</span> <span class="st">'keep'</span>)</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>rmu <span class="ot">&lt;-</span> <span class="fu">rank</span>(mu, <span class="at">na.last =</span> <span class="st">'keep'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, I was thinking I would map those ranks back to the original data, so we have, for example, 7 rank 1s in h (the zeros). But then we run up against the issue of different lengths. Rank 8 in <code>hu</code> is the highest value, while <code>mu</code> goes to 10.</p>
<p>So, do we actually want to go back to <code>findInterval</code>, with the number of intervals being <code>min(length(h), length(m))</code>? I think so (though those should probably be hu and mu. That quickly suggests we could just get back to q-q scaling too, and skip the straight replacements. Maybe- if the debiasing requires replaced values, that won’t work. Get there and see.</p>
<p>A general quantile function I developed earlier. The trick will be to make q_perc right to give as many values as possible (rankings) instead of quantiles. e.g each value should be in its own quantile for the smallest data. Again, is this necessary? Or can we q-q scale (instead of value-replace) and then debias the zeros?</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-21_53364c150fc05a007666c55c66764690">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>get_q <span class="ot">&lt;-</span> <span class="cf">function</span>(vals, q_perc) {</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  qs <span class="ot">&lt;-</span> <span class="fu">quantile</span>(vals, <span class="at">probs =</span> <span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">1</span>, q_perc), <span class="at">type =</span> <span class="dv">5</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># cut fails with lots of zeros (well, any duplicate bins)</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># binvec &lt;- cut(vals, qs, include.lowest = TRUE, labels = FALSE)</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># findInterval is OK with duplicate bins, but combines them, eg. if there are 10 bins that are all 0, it will call them all q10. </span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>  binvec <span class="ot">&lt;-</span> <span class="fu">findInterval</span>(vals, qs, <span class="at">rightmost.closed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(binvec)</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-22_744c36ffcc5d808a8666ca8e4b6a28e2">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>fewest <span class="ot">&lt;-</span> <span class="fu">min</span>(<span class="fu">length</span>(<span class="fu">unique</span>(h)), <span class="fu">length</span>(<span class="fu">unique</span>(m)))</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>hi <span class="ot">&lt;-</span> <span class="fu">get_q</span>(h, <span class="at">q_perc =</span> <span class="dv">1</span><span class="sc">/</span>fewest)</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>mi <span class="ot">&lt;-</span> <span class="fu">get_q</span>(m, <span class="at">q_perc =</span> <span class="dv">1</span><span class="sc">/</span>fewest)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>That doesn’t actually work though- the quantiles goof it up because the duplicates necessarily shift the distribution. Instead, to get as close to a ranking as we can, we need to use the unique values for quantiles, but then findInterval on the full vectors. I think.</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-23_9355b9c872ea0046c5686f9c0c9883a3">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>qsh <span class="ot">&lt;-</span> <span class="fu">quantile</span>(hu, <span class="at">probs =</span> <span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">1</span>, <span class="dv">1</span><span class="sc">/</span>fewest), <span class="at">type =</span> <span class="dv">5</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>qsm <span class="ot">&lt;-</span> <span class="fu">quantile</span>(mu, <span class="at">probs =</span> <span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">1</span>, <span class="dv">1</span><span class="sc">/</span>fewest), <span class="at">type =</span> <span class="dv">5</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>hi <span class="ot">&lt;-</span> <span class="fu">findInterval</span>(h, qsh, <span class="at">rightmost.closed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>mi <span class="ot">&lt;-</span> <span class="fu">findInterval</span>(m, qsm, <span class="at">rightmost.closed =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There are still some funny issues there (some quantiles can go missing), though that is primarily because of small test data.</p>
<p>Now, let’s do the replacement. Use the median (or mean?) of the modelled data? In this dummy case, q4 has both 5 and 6 in it, so we should end up with somethign happening here.</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-24_17d4ddcab96ba1e898162ca2766bb489">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(mi, m)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   m
mi  2 3 4 5 6 7 9 10
  1 3 0 0 0 0 0 0  0
  2 0 2 0 0 0 0 0  0
  3 0 0 2 0 0 0 0  0
  4 0 0 0 2 2 0 0  0
  5 0 0 0 0 0 1 0  0
  6 0 0 0 0 0 0 4  0
  7 0 0 0 0 0 0 0  2</code></pre>
</div>
</div>
<p>Aggregate produces a df, so at this point I probably should switch to dplyr since it’s easier.</p>
<p>We need the summary of the ranks for the modelled data, but not for the hydrology- we need a single value to replace for each rank, but we can put it in many rows for the replacement.</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-25_d0529436846fb1fa53487d0eb52e04bf">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># mm &lt;- aggregate(m, by = list(mi), FUN = median)</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>mdf <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">mod_vals =</span> m, <span class="at">ranks =</span> mi) <span class="sc">%&gt;%</span> </span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ranks) <span class="sc">%&gt;%</span> </span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mod_vals =</span> <span class="fu">median</span>(mod_vals))</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>hdf <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">hyd_vals =</span> h, <span class="at">ranks =</span> hi)</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a><span class="co"># we could use `match` and indexing, but we're already in dplyr so</span></span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>hdf <span class="ot">&lt;-</span> <span class="fu">left_join</span>(hdf, mdf, <span class="at">by =</span> <span class="st">'ranks'</span>)</span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(hdf, <span class="fu">aes</span>(<span class="at">x =</span> hyd_vals, <span class="at">y =</span> mod_vals)) <span class="sc">+</span> <span class="fu">geom_point</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1 rows containing missing values (`geom_point()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="scaling_zeros_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Make all that a function so we can apply it to the actual data. The binning is very similar to before, it just uses unique values instead of all values to approximate a ranking.</p>
</section>
<section id="re-build-data-cleanly" class="level2">
<h2 class="anchored" data-anchor-id="re-build-data-cleanly">Re-build data cleanly</h2>
<p>we had ranks in above, we want to do that differently now, so start from scratch</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-26_88dadd3701611c9b442346dda692eeac">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>qc_limit <span class="ot">&lt;-</span> <span class="dv">150</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>test_model <span class="ot">&lt;-</span> scenario_list<span class="sc">$</span>SS20</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>test_hydro <span class="ot">&lt;-</span> orig_hydro[[<span class="dv">20</span>]]</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>test_hydro <span class="ot">&lt;-</span> test_hydro <span class="sc">%&gt;%</span> </span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">hyd_vals =</span> <span class="fu">ifelse</span>(quality_codes_id <span class="sc">&gt;</span> qc_limit, <span class="cn">NA</span>, value))</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>test_model <span class="ot">&lt;-</span> test_model <span class="sc">%&gt;%</span></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date =</span> lubridate<span class="sc">::</span><span class="fu">make_date</span>(Year, Month, Day))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The simple binning function</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-27_2ce118ef8960ead3711fc4f81e4fe4c8">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>get_q <span class="ot">&lt;-</span> <span class="cf">function</span>(vals, q_perc) {</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>  qs <span class="ot">&lt;-</span> <span class="fu">quantile</span>(<span class="fu">unique</span>(vals), <span class="at">probs =</span> <span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">1</span>, q_perc), <span class="at">type =</span> <span class="dv">5</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>  binvec <span class="ot">&lt;-</span> <span class="fu">findInterval</span>(vals, qs, <span class="at">rightmost.closed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(binvec)</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Data arrangement functions- actually, sort this out later, I think we can probably roll in the regression and apply across the sims, and so we want to sort it out here</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-28_a8e589db088f2f102405658914208fa3">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the number of 'ranks' (bins)</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>fewest <span class="ot">&lt;-</span> <span class="fu">min</span>(<span class="fu">length</span>(<span class="fu">unique</span>(test_hydro<span class="sc">$</span>hyd_vals)), <span class="fu">length</span>(<span class="fu">unique</span>(test_model<span class="sc">$</span>SimR0)))</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Rank the hydrograph</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>test_hydro <span class="ot">&lt;-</span> test_hydro <span class="sc">%&gt;%</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ranks =</span> <span class="fu">get_q</span>(hyd_vals, <span class="dv">1</span><span class="sc">/</span>fewest))</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Rank the model outputs</span></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>model_rankvals <span class="ot">&lt;-</span> test_model <span class="sc">%&gt;%</span></span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ranks =</span> <span class="fu">get_q</span>(SimR0, <span class="dv">1</span><span class="sc">/</span>fewest)) <span class="sc">%&gt;%</span> </span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ranks) <span class="sc">%&gt;%</span> </span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># tempting to apply this `across(stars_with('Sim'))`, but the ranks will differ and so we need to be careful. Might be as easy as `across` in the ranks too?</span></span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mod_vals =</span> <span class="fu">median</span>(SimR0))</span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a><span class="co"># replace (really, add another column)</span></span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a>test_hydro <span class="ot">&lt;-</span> <span class="fu">left_join</span>(test_hydro, model_rankvals, <span class="at">by =</span> <span class="st">'ranks'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="check-plots" class="level2">
<h2 class="anchored" data-anchor-id="check-plots">Check plots</h2>
<p>Do the rankings seem to work?</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-29_ab770508bfcb965134345d665af3c185">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(test_hydro, <span class="fu">aes</span>(<span class="at">x =</span> hyd_vals, <span class="at">y =</span> mod_vals)) <span class="sc">+</span> <span class="fu">geom_line</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1564 rows containing missing values (`geom_line()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="scaling_zeros_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Funny steps, but that’s likely to be expected.</p>
<p>What does the timeseries look like?</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-30_f5fc5feb915d41a83c87a107d72c496a">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(test_hydro, <span class="fu">aes</span>(<span class="at">x =</span> time)) <span class="sc">+</span> <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> hyd_vals), <span class="at">color =</span> <span class="st">'forestgreen'</span>) <span class="sc">+</span> <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> mod_vals<span class="sc">*</span><span class="dv">500</span>), <span class="at">color =</span> <span class="st">'dodgerblue'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1 row containing missing values (`geom_line()`).
Removed 1 row containing missing values (`geom_line()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="scaling_zeros_files/figure-html/unnamed-chunk-30-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The variance is quite obviously different here, and that’s potentially an issue.</p>
<p>We already know the distributions look different from above. How do they look relative to rankings?Those are very different distributions, even when rescaled. Which is not surprising.</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-31_24c169b928b77a487c16bebba09f6b3f">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co"># yes, I should pivot longer but i want to go quick.</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(test_hydro, <span class="fu">aes</span>(<span class="at">x =</span> ranks)) <span class="sc">+</span> <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> hyd_vals), <span class="at">color =</span> <span class="st">'forestgreen'</span>) <span class="sc">+</span> <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> mod_vals<span class="sc">*</span><span class="dv">500</span>), <span class="at">color =</span> <span class="st">'dodgerblue'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1564 rows containing missing values (`geom_line()`).
Removed 1564 rows containing missing values (`geom_line()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="scaling_zeros_files/figure-html/unnamed-chunk-31-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>So, now the question is whether we can get the bias-correction regression to make the blue look like the green.</p>
</section>
</section>
<section id="regression-bias-correction" class="level1">
<h1>Regression bias correction</h1>
<p>What are we regressing? Rank-matched hydrograph and model data</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-32_3f75265167bf9c9f40b590881e0dcc73">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(test_hydro, <span class="fu">aes</span>(<span class="at">x =</span> mod_vals, <span class="at">y =</span> hyd_vals)) <span class="sc">+</span> <span class="fu">geom_point</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1564 rows containing missing values (`geom_point()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="scaling_zeros_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We know we need to log</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-33_155f1d6d1dc647e87a455568a5ff57d5">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>bump0 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(test_hydro, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(mod_vals <span class="sc">+</span> <span class="fl">0.01</span>), <span class="at">y =</span> <span class="fu">log</span>(hyd_vals <span class="sc">+</span> <span class="fl">0.01</span>))) <span class="sc">+</span> </span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">'lm'</span>)</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>drop0 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(test_hydro, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(mod_vals), <span class="at">y =</span> <span class="fu">log</span>(hyd_vals))) <span class="sc">+</span> </span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">'lm'</span>)</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>bump0 <span class="sc">+</span> drop0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1564 rows containing non-finite values (`stat_smooth()`).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1564 rows containing missing values (`geom_point()`).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 4384 rows containing non-finite values (`stat_smooth()`).
Removed 1564 rows containing missing values (`geom_point()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="scaling_zeros_files/figure-html/unnamed-chunk-33-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>There’s quite clearly no way that we will get reasonable estimates of hyd_vals from predictions from mod_vals- we’d get the line, and that’s obviously wrong. Doesn’t matter if we bump zeros or drop them, both are terrible fits.</p>
<p>As a check, let’s go ahead and make those distributions, and see just how terrible they are.</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-34_b1ae4ff04a4a2b95ea4926f86036ef25">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>test_log <span class="ot">&lt;-</span> test_hydro <span class="sc">%&gt;%</span> </span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">log_hyd =</span> <span class="fu">log</span>(hyd_vals),</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">log_mod =</span> <span class="fu">log</span>(mod_vals)) <span class="sc">%&gt;%</span> </span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.infinite</span>(log_hyd))</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>logregression <span class="ot">&lt;-</span> <span class="fu">lm</span>(log_hyd <span class="sc">~</span> log_mod, <span class="at">data =</span> test_log)</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>test_log<span class="sc">$</span>pred_log_hyd <span class="ot">&lt;-</span> <span class="fu">predict</span>(logregression, <span class="at">newdata =</span> <span class="fu">tibble</span>(<span class="at">log_mod =</span> test_log<span class="sc">$</span>log_mod))</span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>test_log<span class="sc">$</span>pred_hyd <span class="ot">&lt;-</span> <span class="fu">exp</span>(test_log<span class="sc">$</span>pred_log_hyd)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>How does that distribution compare to the data? Note that this has dropped zeros in both sets of data, because we’ve logged.</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-35_40d24c9f69f7b556ab63b510facdfbb1">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(test_log) <span class="sc">+</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ecdf</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> pred_log_hyd), <span class="at">color =</span> <span class="st">'dodgerblue'</span>) <span class="sc">+</span> </span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ecdf</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(hyd_vals)), <span class="at">color =</span> <span class="st">'forestgreen'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1564 rows containing non-finite values (`stat_ecdf()`).
Removed 1564 rows containing non-finite values (`stat_ecdf()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="scaling_zeros_files/figure-html/unnamed-chunk-35-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>And the PDF</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-36_d3798cb6457173056c1fd18637818d2f">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(test_log) <span class="sc">+</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> pred_log_hyd), <span class="at">color =</span> <span class="st">'dodgerblue'</span>) <span class="sc">+</span> </span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(hyd_vals)), <span class="at">color =</span> <span class="st">'forestgreen'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1564 rows containing non-finite values (`stat_density()`).
Removed 1564 rows containing non-finite values (`stat_density()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="scaling_zeros_files/figure-html/unnamed-chunk-36-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We could conceivably do a two-piece regression with only the mod_vals logged (e.g.&nbsp;in this plot, we could clearly throw together a piecewise regression with a knot at about -3)</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-37_02c87db434549200a03a74cd20a8c385">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(test_hydro, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(mod_vals), <span class="at">y =</span> hyd_vals)) <span class="sc">+</span> </span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">'lm'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1564 rows containing non-finite values (`stat_smooth()`).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1564 rows containing missing values (`geom_point()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="scaling_zeros_files/figure-html/unnamed-chunk-37-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>But that isn’t going to be general across gauges. It seems like a better plan will be to actually operate on the distributions themselves. Which potentially brings us back to the original approach.</p>
</section>
<section id="distribution-shifting" class="level1">
<h1>Distribution shifting</h1>
<p>I think there are two ways to go here-</p>
<ol type="1">
<li><p>as we’ve done, replace flow with rank-matched model data. Then shift that distribution to re-match flow.</p>
<ol type="1">
<li>For other scenarios, use that same distributional shift to get from model to flow</li>
</ol></li>
<li><p>Get the distributional shifts for the different model data, and apply these to the flow distribution</p>
<ol type="1">
<li><p>This is the q-q scaling, if we were to stop here</p></li>
<li><p>Use parametric dists for the flow, so those shifts can bring the data up and down across 0.</p></li>
</ol></li>
<li><p>Will either of those ever bring zeros up? I’m still not seeing how that happens.</p></li>
</ol>
<section id="the-model-distributions" class="level2">
<h2 class="anchored" data-anchor-id="the-model-distributions">The model distributions</h2>
<p>Above we compared the ecdfs for the SimR0 and the flow, but let’s look at how consistent the distributions are for the other Sims. We don’t care about time, so just let it fall off in the pivot. The green line is the hydrograph values.</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-38_1f9a6ec3290c33c475349d4dfd11d0cb">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>simpivot <span class="ot">&lt;-</span> test_model <span class="sc">%&gt;%</span> </span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">'Sim'</span>), </span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">'Sim'</span>, <span class="at">values_to =</span> <span class="st">'value'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-39_702d4a6637dd805e36169edb81e02a3c">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(simpivot) <span class="sc">+</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ecdf</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(value), <span class="at">color =</span> Sim)) <span class="sc">+</span> </span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ecdf</span>(<span class="at">data =</span> test_hydro, </span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(hyd_vals)), <span class="at">color =</span> <span class="st">'forestgreen'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 4384 rows containing non-finite values (`stat_ecdf()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="scaling_zeros_files/figure-html/unnamed-chunk-39-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Can we fit those distributions?</p>
<p>Try hydrograph first</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-40_8339f784637f1db721c4ec8614362d39">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>cleanhydro <span class="ot">&lt;-</span> test_hydro<span class="sc">$</span>hyd_vals[<span class="sc">!</span><span class="fu">is.na</span>(test_hydro<span class="sc">$</span>hyd_vals) <span class="sc">&amp;</span> </span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>                                    test_hydro<span class="sc">$</span>hyd_vals <span class="sc">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>fit_hydro <span class="ot">&lt;-</span> MASS<span class="sc">::</span><span class="fu">fitdistr</span>(cleanhydro, <span class="at">densfun =</span> <span class="st">'lognormal'</span>)</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>xvals <span class="ot">&lt;-</span> <span class="fu">min</span>(test_hydro<span class="sc">$</span>hyd_vals, <span class="at">na.rm =</span> T)<span class="sc">:</span><span class="fu">round</span>(<span class="fu">max</span>(test_hydro<span class="sc">$</span>hyd_vals, <span class="at">na.rm =</span> T))</span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>pfit <span class="ot">&lt;-</span> <span class="fu">plnorm</span>(xvals, fit_hydro<span class="sc">$</span>estimate[<span class="dv">1</span>], fit_hydro<span class="sc">$</span>estimate[<span class="dv">2</span>])</span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a>dfit <span class="ot">&lt;-</span> <span class="fu">dlnorm</span>(xvals, fit_hydro<span class="sc">$</span>estimate[<span class="dv">1</span>], fit_hydro<span class="sc">$</span>estimate[<span class="dv">2</span>])</span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a>logfit <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">xval =</span> xvals, <span class="at">fitcdf =</span> pfit, <span class="at">fitpdf =</span> dfit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Not perfect, but that’s not going to be possible.</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-41_eaa44fe908e44bec68a871a65f9f2e39">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(test_hydro) <span class="sc">+</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ecdf</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(hyd_vals)), <span class="at">color =</span> <span class="st">'forestgreen'</span>) <span class="sc">+</span></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> logfit, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(xval), <span class="at">y =</span> fitcdf), </span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">'firebrick'</span>) <span class="sc">+</span> </span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ecdf</span>(<span class="at">data =</span> test_log, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> pred_log_hyd), <span class="at">color =</span> <span class="st">'dodgerblue'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 4384 rows containing non-finite values (`stat_ecdf()`).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1564 rows containing non-finite values (`stat_ecdf()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="scaling_zeros_files/figure-html/unnamed-chunk-41-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>PDF. It doesn’t look super great, really.</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-42_abbd4c54a64df54e2d6e70f59bfe2584">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(test_hydro) <span class="sc">+</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> hyd_vals), <span class="at">color =</span> <span class="st">'forestgreen'</span>) <span class="sc">+</span></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> logfit, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> xval, <span class="at">y =</span> fitpdf), </span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">'firebrick'</span>) <span class="sc">+</span> </span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1000</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1564 rows containing non-finite values (`stat_density()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="scaling_zeros_files/figure-html/unnamed-chunk-42-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We can’t just log(x) for the lognorm pdf because of the nonlinear transform. But we can look at it by directly building a normal pdf on the lognorm scale.</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-43_c87487c7262131043193127b3668aa33">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>cleanhydrolog <span class="ot">&lt;-</span> <span class="fu">log</span>(cleanhydro)</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>fit_hydrolog <span class="ot">&lt;-</span> MASS<span class="sc">::</span><span class="fu">fitdistr</span>(cleanhydrolog, <span class="at">densfun =</span> <span class="st">'normal'</span>)</span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>xvals2 <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">min</span>(cleanhydrolog, <span class="at">na.rm =</span> T), </span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a>              <span class="fu">round</span>(<span class="fu">max</span>(cleanhydrolog, <span class="at">na.rm =</span> T)), </span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">by =</span> <span class="fl">0.1</span>)</span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a>pfitlog <span class="ot">&lt;-</span> <span class="fu">pnorm</span>(xvals2, fit_hydrolog<span class="sc">$</span>estimate[<span class="dv">1</span>], fit_hydrolog<span class="sc">$</span>estimate[<span class="dv">2</span>])</span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a>dfitlog <span class="ot">&lt;-</span> <span class="fu">dnorm</span>(xvals2, fit_hydrolog<span class="sc">$</span>estimate[<span class="dv">1</span>], fit_hydrolog<span class="sc">$</span>estimate[<span class="dv">2</span>])</span>
<span id="cb88-11"><a href="#cb88-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-12"><a href="#cb88-12" aria-hidden="true" tabindex="-1"></a>logfitlog <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">xval =</span> xvals2, <span class="at">fitcdf =</span> pfitlog, <span class="at">fitpdf =</span> dfitlog)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-44_e98a0f0f650694294f733303052750e4">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">data =</span> <span class="fu">tibble</span>(<span class="at">hydro =</span> cleanhydrolog), <span class="fu">aes</span>(<span class="at">x =</span> hydro), <span class="at">color =</span> <span class="st">'forestgreen'</span>) <span class="sc">+</span></span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> logfitlog, <span class="fu">aes</span>(<span class="at">x =</span> xvals2, <span class="at">y =</span> fitpdf), <span class="at">color =</span> <span class="st">'firebrick'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="scaling_zeros_files/figure-html/unnamed-chunk-44-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>That’s much better. So why isn’t it working for the unlogged with lognormal. Is it because truncated?</p>
<p>The rnorm with those dims works/matches. SO what’s up with the lognormal? Truncated doesn’t really make sense. Will need to look into it a bit more.</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-45_bc6070bbf3cf93cbad8c0ade1377bacb">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>testcurve <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="fu">length</span>(cleanhydrolog), </span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>                   fit_hydrolog<span class="sc">$</span>estimate[<span class="dv">1</span>], fit_hydrolog<span class="sc">$</span>estimate[<span class="dv">2</span>])</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">data =</span> <span class="fu">tibble</span>(<span class="at">hydro =</span> cleanhydrolog), <span class="fu">aes</span>(<span class="at">x =</span> hydro), <span class="at">color =</span> <span class="st">'forestgreen'</span>) <span class="sc">+</span></span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_density</span>(<span class="at">data =</span> <span class="fu">tibble</span>(<span class="at">testdist =</span> testcurve), <span class="fu">aes</span>(<span class="at">x =</span> testdist), <span class="at">color =</span> <span class="st">'purple'</span>) <span class="sc">+</span></span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> logfitlog, <span class="fu">aes</span>(<span class="at">x =</span> xvals2, <span class="at">y =</span> fitpdf), <span class="at">color =</span> <span class="st">'firebrick'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="scaling_zeros_files/figure-html/unnamed-chunk-45-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Now, how abot sim0</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-46_202a8ff81eb901c98d13f07d41e1b685">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>cleansim <span class="ot">&lt;-</span> test_model<span class="sc">$</span>SimR0[<span class="sc">!</span><span class="fu">is.na</span>(test_model<span class="sc">$</span>SimR0) <span class="sc">&amp;</span> </span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>                                    test_model<span class="sc">$</span>SimR0 <span class="sc">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>fit_sim <span class="ot">&lt;-</span> MASS<span class="sc">::</span><span class="fu">fitdistr</span>(cleansim, <span class="at">densfun =</span> <span class="st">'lognormal'</span>)</span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a>xvalsim <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="fu">seq</span>(<span class="sc">-</span><span class="fl">6.5</span>, <span class="dv">3</span>, <span class="at">by =</span> <span class="fl">0.01</span>))</span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a>pfitsim <span class="ot">&lt;-</span> <span class="fu">plnorm</span>(xvalsim, fit_sim<span class="sc">$</span>estimate[<span class="dv">1</span>], fit_sim<span class="sc">$</span>estimate[<span class="dv">2</span>])</span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a>logfitsim <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">xval =</span> xvalsim, <span class="at">fitcdf =</span> pfitsim)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Interesting. Thats a worse fit to the lognormal than the hydrographs were.</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-47_413dad024001a98a498d80a37549edac">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(test_model) <span class="sc">+</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ecdf</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(SimR0)), <span class="at">color =</span> <span class="st">'dodgerblue'</span>) <span class="sc">+</span></span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> logfitsim, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(xval), <span class="at">y =</span> fitcdf), <span class="at">color =</span> <span class="st">'firebrick'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="scaling_zeros_files/figure-html/unnamed-chunk-47-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<section id="fitting-censored-data" class="level3">
<h3 class="anchored" data-anchor-id="fitting-censored-data">Fitting censored data</h3>
<p>Let’s assume the hydrograph data is left-censored (essentially a detection limit, below which data is zero). That should yield better distributional fits than above where we just threw the zeros out and fit what was left. We can get the estimates with <code>fitdistrplus::fitdistcens</code>. I’ll do this with <code>test_hydro</code> directly (and compare with other fits to check it makes sense).</p>
<p>First, we need a new dataframe to define the censoring. We use <code>hyd_vals</code> because that has dropped the values that are just bad. What do we want to say the ‘detection limit’ is? I guess the smallest nonzero value</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-48_68880bac5a1c161125f18bdd411d0078">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>detectionlimit <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co">#min(test_hydro$hyd_vals[test_hydro$hyd_vals &gt; 0], na.rm = TRUE)</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(test_hydro<span class="sc">$</span>hyd_vals <span class="sc">&lt;</span> detectionlimit, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2854</code></pre>
</div>
</div>
<p>Create the needed dataframe</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-49_2aca8b51f3ad9e7638c3607338a63750">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>censframe <span class="ot">&lt;-</span> test_hydro <span class="sc">|&gt;</span> </span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(hyd_vals)) <span class="sc">|&gt;</span> <span class="co"># Throw out the NAs, we want a distribution</span></span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">left =</span> <span class="fu">ifelse</span>(hyd_vals <span class="sc">==</span> <span class="dv">0</span>, <span class="cn">NA</span>, hyd_vals),</span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">right =</span> <span class="fu">ifelse</span>(hyd_vals <span class="sc">==</span> <span class="dv">0</span>, detectionlimit, hyd_vals)) <span class="sc">|&gt;</span> </span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(left, right) <span class="sc">|&gt;</span> </span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="co"># annoyingly tibbles break fitdistcens</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Fit and get the parameters. Get the naive version too, to see how different it is. This is the same as above, but I’m trying to keep this self-contained.</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-50_f7a0078c0b26ed6eb0638dffc640d227">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>fit_cens <span class="ot">&lt;-</span> fitdistrplus<span class="sc">::</span><span class="fu">fitdistcens</span>(<span class="at">censdata =</span> censframe, <span class="at">distr =</span> <span class="st">'lnorm'</span>)</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>fit_censW <span class="ot">&lt;-</span> fitdistrplus<span class="sc">::</span><span class="fu">fitdistcens</span>(<span class="at">censdata =</span> censframe, <span class="at">distr =</span> <span class="st">'weibull'</span>)</span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a><span class="co"># fitdistr just needs the vector</span></span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a>fit_naive <span class="ot">&lt;-</span> test_hydro <span class="sc">|&gt;</span> </span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(hyd_vals) <span class="sc">&amp;</span> hyd_vals <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">|&gt;</span> </span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(hyd_vals) <span class="sc">|&gt;</span> </span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>() <span class="sc">|&gt;</span> </span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a>  MASS<span class="sc">::</span><span class="fu">fitdistr</span>(<span class="at">densfun =</span> <span class="st">'lognormal'</span>)</span>
<span id="cb96-11"><a href="#cb96-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-12"><a href="#cb96-12" aria-hidden="true" tabindex="-1"></a>fit_cens</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Fitting of the distribution ' lnorm ' on censored data by maximum likelihood 
Parameters:
        estimate
meanlog 5.205442
sdlog   2.041805</code></pre>
</div>
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>fit_naive</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     meanlog        sdlog   
  5.664658806   1.251399081 
 (0.006598844) (0.004666087)</code></pre>
</div>
</div>
<p>Those are really very different. Let’s make some plots to compare the distributions. Get the pdf and cdf we’d get for both those distributions.</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-51_8d101b00ca4b813876efa51fa283de8b">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>df_dists <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">x =</span> <span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">10000</span>, <span class="at">by =</span> <span class="fl">0.1</span>), </span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">cdf_cens =</span> <span class="fu">plnorm</span>(x, </span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>                             fit_cens<span class="sc">$</span>estimate[<span class="st">'meanlog'</span>],</span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>                             fit_cens<span class="sc">$</span>estimate[<span class="st">'sdlog'</span>]),</span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>                 <span class="at">cdf_naive =</span> <span class="fu">plnorm</span>(x, </span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a>                             fit_naive<span class="sc">$</span>estimate[<span class="st">'meanlog'</span>],</span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a>                             fit_naive<span class="sc">$</span>estimate[<span class="st">'sdlog'</span>]),</span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a>                 <span class="at">cdf_weib =</span> <span class="fu">pweibull</span>(x, </span>
<span id="cb100-9"><a href="#cb100-9" aria-hidden="true" tabindex="-1"></a>                             fit_censW<span class="sc">$</span>estimate[<span class="st">'shape'</span>],</span>
<span id="cb100-10"><a href="#cb100-10" aria-hidden="true" tabindex="-1"></a>                             fit_censW<span class="sc">$</span>estimate[<span class="st">'scale'</span>]),</span>
<span id="cb100-11"><a href="#cb100-11" aria-hidden="true" tabindex="-1"></a>                 <span class="at">pdf_cens =</span> <span class="fu">dlnorm</span>(x, </span>
<span id="cb100-12"><a href="#cb100-12" aria-hidden="true" tabindex="-1"></a>                             fit_cens<span class="sc">$</span>estimate[<span class="st">'meanlog'</span>],</span>
<span id="cb100-13"><a href="#cb100-13" aria-hidden="true" tabindex="-1"></a>                             fit_cens<span class="sc">$</span>estimate[<span class="st">'sdlog'</span>]),</span>
<span id="cb100-14"><a href="#cb100-14" aria-hidden="true" tabindex="-1"></a>                 <span class="at">pdf_naive =</span> <span class="fu">dlnorm</span>(x, </span>
<span id="cb100-15"><a href="#cb100-15" aria-hidden="true" tabindex="-1"></a>                             fit_naive<span class="sc">$</span>estimate[<span class="st">'meanlog'</span>],</span>
<span id="cb100-16"><a href="#cb100-16" aria-hidden="true" tabindex="-1"></a>                             fit_naive<span class="sc">$</span>estimate[<span class="st">'sdlog'</span>]),</span>
<span id="cb100-17"><a href="#cb100-17" aria-hidden="true" tabindex="-1"></a>                 <span class="co"># And random data</span></span>
<span id="cb100-18"><a href="#cb100-18" aria-hidden="true" tabindex="-1"></a>                 <span class="at">rand_cens =</span> <span class="fu">rlnorm</span>(<span class="fu">length</span>(x), </span>
<span id="cb100-19"><a href="#cb100-19" aria-hidden="true" tabindex="-1"></a>                             fit_cens<span class="sc">$</span>estimate[<span class="st">'meanlog'</span>],</span>
<span id="cb100-20"><a href="#cb100-20" aria-hidden="true" tabindex="-1"></a>                             fit_cens<span class="sc">$</span>estimate[<span class="st">'sdlog'</span>]),</span>
<span id="cb100-21"><a href="#cb100-21" aria-hidden="true" tabindex="-1"></a>                 <span class="at">rand_naive =</span> <span class="fu">rlnorm</span>(<span class="fu">length</span>(x), </span>
<span id="cb100-22"><a href="#cb100-22" aria-hidden="true" tabindex="-1"></a>                             fit_naive<span class="sc">$</span>estimate[<span class="st">'meanlog'</span>],</span>
<span id="cb100-23"><a href="#cb100-23" aria-hidden="true" tabindex="-1"></a>                             fit_naive<span class="sc">$</span>estimate[<span class="st">'sdlog'</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Plot CDFs. The censored fit is terrible.</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-52_10d84577effa3f49c8084969a00a52bb">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ecdf</span>(<span class="at">data =</span> test_hydro, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> hyd_vals),</span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">'black'</span>) <span class="sc">+</span> </span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># stat_ecdf(data = df_dists, mapping = aes(x = rand_cens), </span></span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">#           color = 'darkseagreen') +</span></span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> df_dists, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> cdf_cens),</span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">'darkgreen'</span>) <span class="sc">+</span></span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># stat_ecdf(data = df_dists, mapping = aes(x = rand_naive), </span></span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">#           color = 'cyan') +</span></span>
<span id="cb101-10"><a href="#cb101-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> df_dists, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> cdf_naive),</span>
<span id="cb101-11"><a href="#cb101-11" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">'dodgerblue'</span>) <span class="sc">+</span></span>
<span id="cb101-12"><a href="#cb101-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">data =</span> df_dists, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> cdf_weib),</span>
<span id="cb101-13"><a href="#cb101-13" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">'firebrick'</span>) <span class="sc">+</span></span>
<span id="cb101-14"><a href="#cb101-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> detectionlimit) <span class="sc">+</span></span>
<span id="cb101-15"><a href="#cb101-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1000</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1564 rows containing non-finite values (`stat_ecdf()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="scaling_zeros_files/figure-html/unnamed-chunk-52-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Wait, this is always going to be crap if fit with plnorm (or weibull). Because those distributions are <em>actually</em> limited at 0, but the data is levelling off and wants to go <em>below</em> zero. So, we <em>do</em> need to go normal manually first. Or shift up, or something.</p>
</section>
<section id="shifting-up" class="level3">
<h3 class="anchored" data-anchor-id="shifting-up">Shifting up</h3>
<p>Does it work to just shift up?</p>
<p>First, we need a new dataframe to define the censoring. We use <code>hyd_vals</code> because that has dropped the values that are just bad. What do we want to say the ‘detection limit’ is? I guess the smallest nonzero value</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-53_d03d78b1d874b6e7825daebca5964438">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>detectionlimit <span class="ot">&lt;-</span> <span class="dv">5000</span></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>test_hydro<span class="sc">$</span>hyd_vals_shift <span class="ot">&lt;-</span> test_hydro<span class="sc">$</span>hyd_vals <span class="sc">+</span> detectionlimit</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Create the needed dataframe</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-54_2a2f1f54d65881fa898810eaf8376eba">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>censframe <span class="ot">&lt;-</span> test_hydro <span class="sc">|&gt;</span> </span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(hyd_vals)) <span class="sc">|&gt;</span> <span class="co"># Throw out the NAs, we want a distribution</span></span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">left =</span> <span class="fu">ifelse</span>(hyd_vals_shift <span class="sc">==</span> detectionlimit, <span class="cn">NA</span>, hyd_vals_shift),</span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">right =</span> <span class="fu">ifelse</span>(hyd_vals_shift <span class="sc">==</span> detectionlimit, detectionlimit, hyd_vals_shift)) <span class="sc">|&gt;</span> </span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(left, right) <span class="sc">|&gt;</span> </span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="co"># annoyingly tibbles break fitdistcens</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Fit and get the parameters. Get the naive version too, to see how different it is. This is the same as above, but I’m trying to keep this self-contained.</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-55_f596d734381465068ea0e597fe5c8917">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>fit_cens <span class="ot">&lt;-</span> fitdistrplus<span class="sc">::</span><span class="fu">fitdistcens</span>(<span class="at">censdata =</span> censframe, <span class="at">distr =</span> <span class="st">'lnorm'</span>)</span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>fit_censW <span class="ot">&lt;-</span> fitdistrplus<span class="sc">::</span><span class="fu">fitdistcens</span>(<span class="at">censdata =</span> censframe, <span class="at">distr =</span> <span class="st">'weibull'</span>)</span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a><span class="co"># fitdistr just needs the vector</span></span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a>fit_naive <span class="ot">&lt;-</span> test_hydro <span class="sc">|&gt;</span> </span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(hyd_vals_shift) <span class="sc">&amp;</span> hyd_vals_shift <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">|&gt;</span> </span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(hyd_vals_shift) <span class="sc">|&gt;</span> </span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>() <span class="sc">|&gt;</span> </span>
<span id="cb105-10"><a href="#cb105-10" aria-hidden="true" tabindex="-1"></a>  MASS<span class="sc">::</span><span class="fu">fitdistr</span>(<span class="at">densfun =</span> <span class="st">'lognormal'</span>)</span>
<span id="cb105-11"><a href="#cb105-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-12"><a href="#cb105-12" aria-hidden="true" tabindex="-1"></a>fit_cens</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Fitting of the distribution ' lnorm ' on censored data by maximum likelihood 
Parameters:
         estimate
meanlog 8.6085499
sdlog   0.1512424</code></pre>
</div>
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>fit_censW</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Fitting of the distribution ' weibull ' on censored data by maximum likelihood 
Parameters:
         estimate
shape    4.138743
scale 5956.796003</code></pre>
</div>
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>fit_naive</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     meanlog         sdlog    
  8.6152940284   0.1433097510 
 (0.0007277045) (0.0005145648)</code></pre>
</div>
</div>
<p>Those are really very different. Let’s make some plots to compare the distributions. Get the pdf and cdf we’d get for both those distributions.</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-56_a7bf43f1ad3068d301959303997afe2d">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>df_dists <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">x =</span> <span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">10000</span>, <span class="at">by =</span> <span class="fl">0.1</span>), </span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">cdf_cens =</span> <span class="fu">plnorm</span>(x, </span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>                             fit_cens<span class="sc">$</span>estimate[<span class="st">'meanlog'</span>],</span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a>                             fit_cens<span class="sc">$</span>estimate[<span class="st">'sdlog'</span>]),</span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a>                 <span class="at">cdf_naive =</span> <span class="fu">plnorm</span>(x, </span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a>                             fit_naive<span class="sc">$</span>estimate[<span class="st">'meanlog'</span>],</span>
<span id="cb111-7"><a href="#cb111-7" aria-hidden="true" tabindex="-1"></a>                             fit_naive<span class="sc">$</span>estimate[<span class="st">'sdlog'</span>]),</span>
<span id="cb111-8"><a href="#cb111-8" aria-hidden="true" tabindex="-1"></a>                 <span class="at">cdf_weib =</span> <span class="fu">pweibull</span>(x, </span>
<span id="cb111-9"><a href="#cb111-9" aria-hidden="true" tabindex="-1"></a>                             fit_censW<span class="sc">$</span>estimate[<span class="st">'shape'</span>],</span>
<span id="cb111-10"><a href="#cb111-10" aria-hidden="true" tabindex="-1"></a>                             fit_censW<span class="sc">$</span>estimate[<span class="st">'scale'</span>]),</span>
<span id="cb111-11"><a href="#cb111-11" aria-hidden="true" tabindex="-1"></a>                 <span class="at">pdf_cens =</span> <span class="fu">dlnorm</span>(x, </span>
<span id="cb111-12"><a href="#cb111-12" aria-hidden="true" tabindex="-1"></a>                             fit_cens<span class="sc">$</span>estimate[<span class="st">'meanlog'</span>],</span>
<span id="cb111-13"><a href="#cb111-13" aria-hidden="true" tabindex="-1"></a>                             fit_cens<span class="sc">$</span>estimate[<span class="st">'sdlog'</span>]),</span>
<span id="cb111-14"><a href="#cb111-14" aria-hidden="true" tabindex="-1"></a>                 <span class="at">pdf_naive =</span> <span class="fu">dlnorm</span>(x, </span>
<span id="cb111-15"><a href="#cb111-15" aria-hidden="true" tabindex="-1"></a>                             fit_naive<span class="sc">$</span>estimate[<span class="st">'meanlog'</span>],</span>
<span id="cb111-16"><a href="#cb111-16" aria-hidden="true" tabindex="-1"></a>                             fit_naive<span class="sc">$</span>estimate[<span class="st">'sdlog'</span>]),</span>
<span id="cb111-17"><a href="#cb111-17" aria-hidden="true" tabindex="-1"></a>                 <span class="co"># And random data</span></span>
<span id="cb111-18"><a href="#cb111-18" aria-hidden="true" tabindex="-1"></a>                 <span class="at">rand_cens =</span> <span class="fu">rlnorm</span>(<span class="fu">length</span>(x), </span>
<span id="cb111-19"><a href="#cb111-19" aria-hidden="true" tabindex="-1"></a>                             fit_cens<span class="sc">$</span>estimate[<span class="st">'meanlog'</span>],</span>
<span id="cb111-20"><a href="#cb111-20" aria-hidden="true" tabindex="-1"></a>                             fit_cens<span class="sc">$</span>estimate[<span class="st">'sdlog'</span>]),</span>
<span id="cb111-21"><a href="#cb111-21" aria-hidden="true" tabindex="-1"></a>                 <span class="at">rand_naive =</span> <span class="fu">rlnorm</span>(<span class="fu">length</span>(x), </span>
<span id="cb111-22"><a href="#cb111-22" aria-hidden="true" tabindex="-1"></a>                             fit_naive<span class="sc">$</span>estimate[<span class="st">'meanlog'</span>],</span>
<span id="cb111-23"><a href="#cb111-23" aria-hidden="true" tabindex="-1"></a>                             fit_naive<span class="sc">$</span>estimate[<span class="st">'sdlog'</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Plot CDFs. The censored fit is terrible.</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-57_b4ce877f0531645eaa4cb38eb09b20ed">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ecdf</span>(<span class="at">data =</span> test_hydro, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> hyd_vals_shift),</span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">'black'</span>) <span class="sc">+</span> </span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># stat_ecdf(data = df_dists, mapping = aes(x = rand_cens), </span></span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">#           color = 'darkseagreen') +</span></span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> df_dists, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> cdf_cens),</span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">'darkgreen'</span>) <span class="sc">+</span></span>
<span id="cb112-8"><a href="#cb112-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># stat_ecdf(data = df_dists, mapping = aes(x = rand_naive), </span></span>
<span id="cb112-9"><a href="#cb112-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">#           color = 'cyan') +</span></span>
<span id="cb112-10"><a href="#cb112-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> df_dists, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> cdf_naive),</span>
<span id="cb112-11"><a href="#cb112-11" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">'dodgerblue'</span>) <span class="sc">+</span></span>
<span id="cb112-12"><a href="#cb112-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">data =</span> df_dists, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> cdf_weib),</span>
<span id="cb112-13"><a href="#cb112-13" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">'firebrick'</span>) <span class="sc">+</span></span>
<span id="cb112-14"><a href="#cb112-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> detectionlimit) <span class="sc">+</span></span>
<span id="cb112-15"><a href="#cb112-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">10000</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1564 rows containing non-finite values (`stat_ecdf()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="scaling_zeros_files/figure-html/unnamed-chunk-57-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Those are actually a lot better. Does this actually work? Or should we do it on the logged scale and normal dists? How much to shift?</p>
</section>
<section id="optimized-upshifts" class="level3">
<h3 class="anchored" data-anchor-id="optimized-upshifts">Optimized upshifts</h3>
<p>I’ve done a bunch of testing elsewhere with known distributions, and come up with a set of functions to determine the shift (and spit out a dataframe for diagnostic plots).</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-58_78a2e3674fea4104e2175e0d0355fc8e">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>fitshift <span class="ot">&lt;-</span> <span class="cf">function</span>(cleandata, shift_up) {</span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Handle the zero case- we just use the next value up</span></span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (shift_up <span class="sc">==</span> <span class="dv">0</span>) {rightlim <span class="ot">&lt;-</span> <span class="fu">min</span>(cleandata[cleandata<span class="sc">&gt;</span><span class="dv">0</span>])</span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a>      rightlim <span class="ot">&lt;-</span> shift_up}</span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb114-7"><a href="#cb114-7" aria-hidden="true" tabindex="-1"></a>  inshift <span class="ot">&lt;-</span> cleandata <span class="sc">+</span> shift_up</span>
<span id="cb114-8"><a href="#cb114-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb114-9"><a href="#cb114-9" aria-hidden="true" tabindex="-1"></a>    upcens <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">left =</span> <span class="fu">ifelse</span>(inshift <span class="sc">&lt;=</span> shift_up, <span class="cn">NA</span>, inshift),</span>
<span id="cb114-10"><a href="#cb114-10" aria-hidden="true" tabindex="-1"></a>                <span class="at">right =</span> <span class="fu">ifelse</span>(inshift <span class="sc">&lt;=</span> shift_up, rightlim, inshift))</span>
<span id="cb114-11"><a href="#cb114-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb114-12"><a href="#cb114-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">suppressWarnings</span>(fit_up <span class="ot">&lt;-</span> <span class="fu">fitdistcens</span>(<span class="at">censdata =</span> <span class="fu">data.frame</span>(upcens),</span>
<span id="cb114-13"><a href="#cb114-13" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">distr =</span> <span class="st">'lnorm'</span>))</span>
<span id="cb114-14"><a href="#cb114-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb114-15"><a href="#cb114-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(fit_up)</span>
<span id="cb114-16"><a href="#cb114-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb114-17"><a href="#cb114-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-18"><a href="#cb114-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-19"><a href="#cb114-19" aria-hidden="true" tabindex="-1"></a>opt_up <span class="ot">&lt;-</span> <span class="cf">function</span>(shift_up, cleandata) {</span>
<span id="cb114-20"><a href="#cb114-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb114-21"><a href="#cb114-21" aria-hidden="true" tabindex="-1"></a>  fit_up <span class="ot">&lt;-</span> <span class="fu">fitshift</span>(cleandata, shift_up)</span>
<span id="cb114-22"><a href="#cb114-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb114-23"><a href="#cb114-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="sc">-</span>fit_up<span class="sc">$</span>loglik)</span>
<span id="cb114-24"><a href="#cb114-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb114-25"><a href="#cb114-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-26"><a href="#cb114-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-27"><a href="#cb114-27" aria-hidden="true" tabindex="-1"></a>optshift <span class="ot">&lt;-</span> <span class="cf">function</span>(rawdata) {</span>
<span id="cb114-28"><a href="#cb114-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb114-29"><a href="#cb114-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This is about distributions, NOT data order, so get rid of NAs</span></span>
<span id="cb114-30"><a href="#cb114-30" aria-hidden="true" tabindex="-1"></a>  rawna <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(rawdata)</span>
<span id="cb114-31"><a href="#cb114-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb114-32"><a href="#cb114-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get the optimal shift</span></span>
<span id="cb114-33"><a href="#cb114-33" aria-hidden="true" tabindex="-1"></a>  shift <span class="ot">&lt;-</span> <span class="fu">optimize</span>(opt_up, <span class="at">interval =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1000</span>), <span class="at">cleandata =</span> rawna)</span>
<span id="cb114-34"><a href="#cb114-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb114-35"><a href="#cb114-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get the fit at that shift (would be nice to kick this out of opt_up somehow)</span></span>
<span id="cb114-36"><a href="#cb114-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb114-37"><a href="#cb114-37" aria-hidden="true" tabindex="-1"></a>  fit_up <span class="ot">&lt;-</span> <span class="fu">fitshift</span>(rawna, shift<span class="sc">$</span>minimum)</span>
<span id="cb114-38"><a href="#cb114-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb114-39"><a href="#cb114-39" aria-hidden="true" tabindex="-1"></a> <span class="co"># Create a df for output</span></span>
<span id="cb114-40"><a href="#cb114-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># The shifted data</span></span>
<span id="cb114-41"><a href="#cb114-41" aria-hidden="true" tabindex="-1"></a>  shiftdf <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">orig_data =</span> rawdata, </span>
<span id="cb114-42"><a href="#cb114-42" aria-hidden="true" tabindex="-1"></a>                    <span class="at">shift_data =</span> rawdata <span class="sc">+</span> shift<span class="sc">$</span>minimum, </span>
<span id="cb114-43"><a href="#cb114-43" aria-hidden="true" tabindex="-1"></a>                    <span class="at">optimum_shift =</span> shift<span class="sc">$</span>minimum)</span>
<span id="cb114-44"><a href="#cb114-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb114-45"><a href="#cb114-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-46"><a href="#cb114-46" aria-hidden="true" tabindex="-1"></a>   <span class="co"># This isn't ideal, but we can shove the cdf on here too, it just has rows that don't mean the same thing. prevents us saving a list though.</span></span>
<span id="cb114-47"><a href="#cb114-47" aria-hidden="true" tabindex="-1"></a>  shiftdf <span class="ot">&lt;-</span> shiftdf <span class="sc">|&gt;</span> </span>
<span id="cb114-48"><a href="#cb114-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">x =</span> <span class="fu">row_number</span>()<span class="sc">/</span><span class="dv">10</span>,</span>
<span id="cb114-49"><a href="#cb114-49" aria-hidden="true" tabindex="-1"></a>           <span class="at">meanlog =</span> fit_up<span class="sc">$</span>estimate[<span class="st">'meanlog'</span>],</span>
<span id="cb114-50"><a href="#cb114-50" aria-hidden="true" tabindex="-1"></a>           <span class="at">sdlog =</span> fit_up<span class="sc">$</span>estimate[<span class="st">'sdlog'</span>],</span>
<span id="cb114-51"><a href="#cb114-51" aria-hidden="true" tabindex="-1"></a>           <span class="at">cdf_up =</span> <span class="fu">plnorm</span>(x, </span>
<span id="cb114-52"><a href="#cb114-52" aria-hidden="true" tabindex="-1"></a>                             fit_up<span class="sc">$</span>estimate[<span class="st">'meanlog'</span>],</span>
<span id="cb114-53"><a href="#cb114-53" aria-hidden="true" tabindex="-1"></a>                             fit_up<span class="sc">$</span>estimate[<span class="st">'sdlog'</span>]),</span>
<span id="cb114-54"><a href="#cb114-54" aria-hidden="true" tabindex="-1"></a>           <span class="at">pdf_up =</span> <span class="fu">dlnorm</span>(x, </span>
<span id="cb114-55"><a href="#cb114-55" aria-hidden="true" tabindex="-1"></a>                             fit_up<span class="sc">$</span>estimate[<span class="st">'meanlog'</span>],</span>
<span id="cb114-56"><a href="#cb114-56" aria-hidden="true" tabindex="-1"></a>                             fit_up<span class="sc">$</span>estimate[<span class="st">'sdlog'</span>]),</span>
<span id="cb114-57"><a href="#cb114-57" aria-hidden="true" tabindex="-1"></a>           <span class="co"># Some diagnostics</span></span>
<span id="cb114-58"><a href="#cb114-58" aria-hidden="true" tabindex="-1"></a>           <span class="at">fitloglik =</span> fit_up<span class="sc">$</span>loglik)</span>
<span id="cb114-59"><a href="#cb114-59" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb114-60"><a href="#cb114-60" aria-hidden="true" tabindex="-1"></a>  <span class="co"># and a shifted-back version of the cdf/pdf just needs a shifted x. The</span></span>
<span id="cb114-61"><a href="#cb114-61" aria-hidden="true" tabindex="-1"></a>  <span class="co"># backshift of the data is just the original `rawdata`.</span></span>
<span id="cb114-62"><a href="#cb114-62" aria-hidden="true" tabindex="-1"></a>  shiftdf <span class="ot">&lt;-</span> shiftdf <span class="sc">|&gt;</span> </span>
<span id="cb114-63"><a href="#cb114-63" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">x_back =</span> x<span class="sc">-</span>shift<span class="sc">$</span>minimum)</span>
<span id="cb114-64"><a href="#cb114-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-65"><a href="#cb114-65" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, let’s try running that for the data</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-59_fbff6c98c976a5382702c620fe747946">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>optimal_fit <span class="ot">&lt;-</span> <span class="fu">optshift</span>(test_hydro<span class="sc">$</span>hyd_vals)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Plot that- how are we doing? It’s OK, likely is the best fit, the distribution just isn’t lognormal.</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-60_c360a258232d2325a04504292db7cb78">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(optimal_fit) <span class="sc">+</span></span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ecdf</span>(<span class="fu">aes</span>(<span class="at">x =</span> shift_data)) <span class="sc">+</span></span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> cdf_up), <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">2000</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1564 rows containing non-finite values (`stat_ecdf()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="scaling_zeros_files/figure-html/unnamed-chunk-60-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>How does that look compared to the non-shifted fit? I’ll shift this fit back to where it should be. They’re better in different places. But the shifted version is the only one that can possibly handle the truncation. And we know from the optimisation that it has a better log-likelihood, since 0 was an option.</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-61_927e3dce2c4bcae819adedebe4c16505">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(optimal_fit) <span class="sc">+</span></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ecdf</span>(<span class="fu">aes</span>(<span class="at">x =</span> orig_data), </span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">'firebrick'</span>) <span class="sc">+</span></span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> x_back, <span class="at">y =</span> cdf_up), </span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">'firebrick'</span>, <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> logfit, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> xval, <span class="at">y =</span> fitcdf), </span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">'dodgerblue'</span>) <span class="sc">+</span></span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">70</span>,<span class="dv">3000</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1564 rows containing non-finite values (`stat_ecdf()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="scaling_zeros_files/figure-html/unnamed-chunk-61-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<section id="weibull" class="level4">
<h4 class="anchored" data-anchor-id="weibull">Weibull?</h4>
<p>Does a weibull fit better, now that we have the shift? No</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-62_d12dab55b7443c87d2fdb8c6b7ea39b0">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="co"># fitshift_w &lt;- function(rawdata, shift_up) {</span></span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a><span class="co">#   # Handle the zero case- we just use the next value up</span></span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a><span class="co">#     if (shift_up == 0) {rightlim &lt;- min(rawdata[rawdata&gt;0])</span></span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a><span class="co">#     } else {</span></span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a><span class="co">#       rightlim &lt;- shift_up}</span></span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a><span class="co">#   </span></span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a><span class="co">#   inshift &lt;- rawdata + shift_up</span></span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a><span class="co">#     </span></span>
<span id="cb120-9"><a href="#cb120-9" aria-hidden="true" tabindex="-1"></a><span class="co">#     upcens &lt;- tibble(left = ifelse(inshift &lt;= shift_up, NA, inshift),</span></span>
<span id="cb120-10"><a href="#cb120-10" aria-hidden="true" tabindex="-1"></a><span class="co">#                 right = ifelse(inshift &lt;= shift_up, rightlim, inshift))</span></span>
<span id="cb120-11"><a href="#cb120-11" aria-hidden="true" tabindex="-1"></a><span class="co">#     </span></span>
<span id="cb120-12"><a href="#cb120-12" aria-hidden="true" tabindex="-1"></a><span class="co">#     suppressWarnings(fit_up &lt;- fitdistcens(censdata = data.frame(upcens),</span></span>
<span id="cb120-13"><a href="#cb120-13" aria-hidden="true" tabindex="-1"></a><span class="co">#                                            distr = 'weibull'))</span></span>
<span id="cb120-14"><a href="#cb120-14" aria-hidden="true" tabindex="-1"></a><span class="co">#     </span></span>
<span id="cb120-15"><a href="#cb120-15" aria-hidden="true" tabindex="-1"></a><span class="co">#     return(fit_up)</span></span>
<span id="cb120-16"><a href="#cb120-16" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb120-17"><a href="#cb120-17" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb120-18"><a href="#cb120-18" aria-hidden="true" tabindex="-1"></a><span class="co"># opt_up_w &lt;- function(shift_up, rawdata) {</span></span>
<span id="cb120-19"><a href="#cb120-19" aria-hidden="true" tabindex="-1"></a><span class="co">#   </span></span>
<span id="cb120-20"><a href="#cb120-20" aria-hidden="true" tabindex="-1"></a><span class="co">#   fit_up &lt;- fitshift_w(rawdata, shift_up)</span></span>
<span id="cb120-21"><a href="#cb120-21" aria-hidden="true" tabindex="-1"></a><span class="co">#   </span></span>
<span id="cb120-22"><a href="#cb120-22" aria-hidden="true" tabindex="-1"></a><span class="co">#   return(-fit_up$loglik)</span></span>
<span id="cb120-23"><a href="#cb120-23" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb120-24"><a href="#cb120-24" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb120-25"><a href="#cb120-25" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb120-26"><a href="#cb120-26" aria-hidden="true" tabindex="-1"></a><span class="co"># optshift_w &lt;- function(rawdata) {</span></span>
<span id="cb120-27"><a href="#cb120-27" aria-hidden="true" tabindex="-1"></a><span class="co">#   </span></span>
<span id="cb120-28"><a href="#cb120-28" aria-hidden="true" tabindex="-1"></a><span class="co">#   # This is about distributions, NOT data order, so get rid of NAs</span></span>
<span id="cb120-29"><a href="#cb120-29" aria-hidden="true" tabindex="-1"></a><span class="co">#   rawdata &lt;- na.omit(rawdata)</span></span>
<span id="cb120-30"><a href="#cb120-30" aria-hidden="true" tabindex="-1"></a><span class="co">#   </span></span>
<span id="cb120-31"><a href="#cb120-31" aria-hidden="true" tabindex="-1"></a><span class="co">#   # get the optimal shift</span></span>
<span id="cb120-32"><a href="#cb120-32" aria-hidden="true" tabindex="-1"></a><span class="co">#   shift &lt;- optimize(opt_up_w, interval = c(0, 1000), rawdata = rawdata)</span></span>
<span id="cb120-33"><a href="#cb120-33" aria-hidden="true" tabindex="-1"></a><span class="co">#   </span></span>
<span id="cb120-34"><a href="#cb120-34" aria-hidden="true" tabindex="-1"></a><span class="co">#   # Get the fit at that shift (would be nice to kick this out of opt_up somehow)</span></span>
<span id="cb120-35"><a href="#cb120-35" aria-hidden="true" tabindex="-1"></a><span class="co">#   </span></span>
<span id="cb120-36"><a href="#cb120-36" aria-hidden="true" tabindex="-1"></a><span class="co">#   fit_up &lt;- fitshift_w(rawdata, shift$minimum)</span></span>
<span id="cb120-37"><a href="#cb120-37" aria-hidden="true" tabindex="-1"></a><span class="co">#   </span></span>
<span id="cb120-38"><a href="#cb120-38" aria-hidden="true" tabindex="-1"></a><span class="co">#  # Create a df for output</span></span>
<span id="cb120-39"><a href="#cb120-39" aria-hidden="true" tabindex="-1"></a><span class="co">#   # The shifted data</span></span>
<span id="cb120-40"><a href="#cb120-40" aria-hidden="true" tabindex="-1"></a><span class="co">#   shiftdf &lt;- tibble(orig_data = rawdata, </span></span>
<span id="cb120-41"><a href="#cb120-41" aria-hidden="true" tabindex="-1"></a><span class="co">#                     shift_data = rawdata + shift$minimum, </span></span>
<span id="cb120-42"><a href="#cb120-42" aria-hidden="true" tabindex="-1"></a><span class="co">#                     optimum_shift = shift$minimum)</span></span>
<span id="cb120-43"><a href="#cb120-43" aria-hidden="true" tabindex="-1"></a><span class="co">#   </span></span>
<span id="cb120-44"><a href="#cb120-44" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb120-45"><a href="#cb120-45" aria-hidden="true" tabindex="-1"></a><span class="co">#    # This isn't ideal, but we can shove the cdf on here too, it just has rows that don't mean the same thing. prevents us saving a list though.</span></span>
<span id="cb120-46"><a href="#cb120-46" aria-hidden="true" tabindex="-1"></a><span class="co">#   shiftdf &lt;- shiftdf |&gt; </span></span>
<span id="cb120-47"><a href="#cb120-47" aria-hidden="true" tabindex="-1"></a><span class="co">#     mutate(x = row_number()/10,</span></span>
<span id="cb120-48"><a href="#cb120-48" aria-hidden="true" tabindex="-1"></a><span class="co">#            cdf_up = pweibull(x, </span></span>
<span id="cb120-49"><a href="#cb120-49" aria-hidden="true" tabindex="-1"></a><span class="co">#                              fit_up$estimate['shape'],</span></span>
<span id="cb120-50"><a href="#cb120-50" aria-hidden="true" tabindex="-1"></a><span class="co">#                              fit_up$estimate['scale']),</span></span>
<span id="cb120-51"><a href="#cb120-51" aria-hidden="true" tabindex="-1"></a><span class="co">#            pdf_up = dweibull(x, </span></span>
<span id="cb120-52"><a href="#cb120-52" aria-hidden="true" tabindex="-1"></a><span class="co">#                              fit_up$estimate['shape'],</span></span>
<span id="cb120-53"><a href="#cb120-53" aria-hidden="true" tabindex="-1"></a><span class="co">#                              fit_up$estimate['scale']),</span></span>
<span id="cb120-54"><a href="#cb120-54" aria-hidden="true" tabindex="-1"></a><span class="co">#            # Some diagnostics</span></span>
<span id="cb120-55"><a href="#cb120-55" aria-hidden="true" tabindex="-1"></a><span class="co">#            fitloglik = fit_up$loglik)</span></span>
<span id="cb120-56"><a href="#cb120-56" aria-hidden="true" tabindex="-1"></a><span class="co">#   </span></span>
<span id="cb120-57"><a href="#cb120-57" aria-hidden="true" tabindex="-1"></a><span class="co">#   # and a shifted-back version of the cdf/pdf just needs a shifted x. The</span></span>
<span id="cb120-58"><a href="#cb120-58" aria-hidden="true" tabindex="-1"></a><span class="co">#   # backshift of the data is just the original `rawdata`.</span></span>
<span id="cb120-59"><a href="#cb120-59" aria-hidden="true" tabindex="-1"></a><span class="co">#   shiftdf &lt;- shiftdf |&gt; </span></span>
<span id="cb120-60"><a href="#cb120-60" aria-hidden="true" tabindex="-1"></a><span class="co">#     mutate(x_back = x-shift$minimum)</span></span>
<span id="cb120-61"><a href="#cb120-61" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb120-62"><a href="#cb120-62" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-63_4f33bb5cede2e414948319f72a9c4f65">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="co"># optimal_fit_w &lt;- optshift_w(test_hydro$hyd_vals)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-64_db17fde1f3c543a85b972d08338ace38">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ggplot(optimal_fit_w) +</span></span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a><span class="co">#   stat_ecdf(aes(x = shift_data)) +</span></span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a><span class="co">#   geom_line(aes(x = x, y = cdf_up), linetype = 2) +</span></span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a><span class="co">#   coord_cartesian(xlim = c(0,2000))</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
</section>
<section id="shifting-between-distributions" class="level2">
<h2 class="anchored" data-anchor-id="shifting-between-distributions">Shifting between distributions</h2>
<p>Couple questions-</p>
<ol type="1">
<li>if we have data with one distribution, how do we give it another known distribution. I seem to remember somethign about f(g(x)) and g(x)^-1, but conceptually, what are we doing?</li>
<li>Even if we can do that, is there a way to shift them to yield numbers below zero? or above, for that matter? Or are we just re-developing a more complex q-q?</li>
</ol>
<p>We have some x-value (say, flow). We want to shift it to a new distribution. I think conceptually, we go up to its value in the plots above, then over to the corresponding p(x) on the other distribution, then down to get a new value.</p>
<p>So, for the hydrographs, start with <code>cleanhydro</code>, the values of the hydrographs</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-65_996b0e3d63ffa075066e45576aecec1f">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="co"># # Get the probs for each hydrograph value- this is the ecdf, which creates a *function* that takes x as arguments and returns probabilities</span></span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a><span class="co"># phydro &lt;- ecdf(log(cleanhydro))</span></span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a><span class="co"># phydrop &lt;- phydro(log(cleanhydro))</span></span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb123-5"><a href="#cb123-5" aria-hidden="true" tabindex="-1"></a><span class="co"># # Get the hydrograph value for the matching probs for the fit lognormal</span></span>
<span id="cb123-6"><a href="#cb123-6" aria-hidden="true" tabindex="-1"></a><span class="co"># lnh &lt;- qlnorm(phydrop, fit_hydro$estimate[1], fit_hydro$estimate[2])</span></span>
<span id="cb123-7"><a href="#cb123-7" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb123-8"><a href="#cb123-8" aria-hidden="true" tabindex="-1"></a><span class="co"># shifthyd &lt;- tibble(hyd_vals = cleanhydro, fit_val = lnh)</span></span>
<span id="cb123-9"><a href="#cb123-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-10"><a href="#cb123-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the probs for each hydrograph value- this is the ecdf, which creates a *function* that takes x as arguments and returns probabilities</span></span>
<span id="cb123-11"><a href="#cb123-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-12"><a href="#cb123-12" aria-hidden="true" tabindex="-1"></a><span class="co"># This is messy to use the dataframe from above, but I'm tired of re-writing things.</span></span>
<span id="cb123-13"><a href="#cb123-13" aria-hidden="true" tabindex="-1"></a><span class="co"># cleanraw &lt;- test_hydro$hyd_vals %&gt;% na.omit()</span></span>
<span id="cb123-14"><a href="#cb123-14" aria-hidden="true" tabindex="-1"></a>phydro <span class="ot">&lt;-</span> <span class="fu">ecdf</span>(optimal_fit<span class="sc">$</span>shift_data)</span>
<span id="cb123-15"><a href="#cb123-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-16"><a href="#cb123-16" aria-hidden="true" tabindex="-1"></a>optimal_fit <span class="ot">&lt;-</span> optimal_fit <span class="sc">%&gt;%</span> </span>
<span id="cb123-17"><a href="#cb123-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">p_shift =</span> <span class="fu">phydro</span>(shift_data),</span>
<span id="cb123-18"><a href="#cb123-18" aria-hidden="true" tabindex="-1"></a>         <span class="at">q_shiftln =</span> <span class="fu">qlnorm</span>(p_shift, </span>
<span id="cb123-19"><a href="#cb123-19" aria-hidden="true" tabindex="-1"></a>                            meanlog,</span>
<span id="cb123-20"><a href="#cb123-20" aria-hidden="true" tabindex="-1"></a>                            sdlog),</span>
<span id="cb123-21"><a href="#cb123-21" aria-hidden="true" tabindex="-1"></a>         <span class="at">q_back =</span> q_shiftln<span class="sc">-</span>optimum_shift)</span>
<span id="cb123-22"><a href="#cb123-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb123-23"><a href="#cb123-23" aria-hidden="true" tabindex="-1"></a><span class="co"># lnh &lt;- qlnorm(phydrop, fit_up$estimate['meanlog'], fit_hydro$estimate['sdlog'])</span></span>
<span id="cb123-24"><a href="#cb123-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-25"><a href="#cb123-25" aria-hidden="true" tabindex="-1"></a><span class="co"># # Deal with the shift</span></span>
<span id="cb123-26"><a href="#cb123-26" aria-hidden="true" tabindex="-1"></a><span class="co"># lnh &lt;- lnh - shift_by$minimum</span></span>
<span id="cb123-27"><a href="#cb123-27" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb123-28"><a href="#cb123-28" aria-hidden="true" tabindex="-1"></a><span class="co"># shifthyd &lt;- tibble(hyd_vals = cleanraw, fit_val = lnh)</span></span>
<span id="cb123-29"><a href="#cb123-29" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb123-30"><a href="#cb123-30" aria-hidden="true" tabindex="-1"></a><span class="co"># xfit &lt;- seq(0, 1000, by = 0.1)</span></span>
<span id="cb123-31"><a href="#cb123-31" aria-hidden="true" tabindex="-1"></a><span class="co"># shiftfit &lt;- plnorm(xfit, </span></span>
<span id="cb123-32"><a href="#cb123-32" aria-hidden="true" tabindex="-1"></a><span class="co">#                              fit_up$estimate['meanlog'],</span></span>
<span id="cb123-33"><a href="#cb123-33" aria-hidden="true" tabindex="-1"></a><span class="co">#                              fit_up$estimate['sdlog'])</span></span>
<span id="cb123-34"><a href="#cb123-34" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb123-35"><a href="#cb123-35" aria-hidden="true" tabindex="-1"></a><span class="co"># shiftdf &lt;- tibble(x = xfit, cdf = shiftfit, x_back = xfit - shift_by$minimum)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>That looks like a pretty good translation.</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-66_ee5fea603fe3ca278b8bc025d8e5ede0">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(optimal_fit) <span class="sc">+</span></span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ecdf of the hydrograph data</span></span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ecdf</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> orig_data), <span class="at">color =</span> <span class="st">'forestgreen'</span>) <span class="sc">+</span></span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># lognormal cdf</span></span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> x_back, <span class="at">y =</span> cdf_up), </span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">'firebrick'</span>, <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb124-7"><a href="#cb124-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ecdf of the transformed data, should match the lognormal cdf</span></span>
<span id="cb124-8"><a href="#cb124-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ecdf</span>(<span class="fu">aes</span>(<span class="at">x =</span> q_back),</span>
<span id="cb124-9"><a href="#cb124-9" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">'dodgerblue'</span>, <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb124-10"><a href="#cb124-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">10</span>, <span class="dv">1000</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1564 rows containing non-finite values (`stat_ecdf()`).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1565 rows containing non-finite values (`stat_ecdf()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="scaling_zeros_files/figure-html/unnamed-chunk-66-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>So that’s almost dead on. What does it look like as a timeseries next to the real data? This is dangerous to just glue time on, but the order should be preserved.</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-67_6893ae68b1777110e16d9c933778e4da">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a>optimal_fit<span class="sc">$</span>time <span class="ot">&lt;-</span> test_hydro<span class="sc">$</span>time</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-68_40b38230de5406a6a2e594c40fd89f7b">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>newhydro <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(optimal_fit, <span class="fu">aes</span>(<span class="at">x =</span> time)) <span class="sc">+</span> </span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">y =</span> orig_data), <span class="at">color =</span> <span class="st">'forestgreen'</span>) <span class="sc">+</span></span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">y =</span> q_back), <span class="at">color =</span> <span class="st">'dodgerblue'</span>, <span class="at">linetype =</span> <span class="dv">2</span>)</span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a>newhydro</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1 row containing missing values (`geom_line()`).
Removed 1 row containing missing values (`geom_line()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="scaling_zeros_files/figure-html/unnamed-chunk-68-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Yikes. some of those are a bit extreme, huh? Lognormal tails are dangerous.</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-69_bb52c86c58bc999f119b3285646ba289">
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>newhydro <span class="sc">+</span> <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">5000</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1 row containing missing values (`geom_line()`).
Removed 1 row containing missing values (`geom_line()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="scaling_zeros_files/figure-html/unnamed-chunk-69-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-70_bdcfd658e26f359bcbf427a72ec30ed7">
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a>hyddata <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(optimal_fit, <span class="fu">aes</span>(<span class="at">x =</span> time)) <span class="sc">+</span> </span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">y =</span> orig_data), <span class="at">color =</span> <span class="st">'forestgreen'</span>)</span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a>fitdata <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(optimal_fit, <span class="fu">aes</span>(<span class="at">x =</span> time)) <span class="sc">+</span></span>
<span id="cb132-5"><a href="#cb132-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">y =</span> q_back), <span class="at">color =</span> <span class="st">'dodgerblue'</span>)</span>
<span id="cb132-6"><a href="#cb132-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-7"><a href="#cb132-7" aria-hidden="true" tabindex="-1"></a>hyddata <span class="sc">+</span> fitdata</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1 row containing missing values (`geom_line()`).
Removed 1 row containing missing values (`geom_line()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="scaling_zeros_files/figure-html/unnamed-chunk-70-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Yikes. why are we just blowing the top off?</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-71_ff117ebb43c6b855b23bc0401cca8773">
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(optimal_fit, <span class="fu">aes</span>(<span class="at">x =</span> orig_data, <span class="at">y =</span> q_back)) <span class="sc">+</span> </span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1564 rows containing missing values (`geom_point()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="scaling_zeros_files/figure-html/unnamed-chunk-71-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>So, that works OK for low values, but blows up high. Basically because the hydrograph distribution is NOT a lognormal. Is this better or worse than the linear regression method? Not sure. The empirical distribution doesn’t fit a lognormal, and the relationship between runoff models and hydrograph is nonlinear. So in both cases, a direct hydrograph –&gt; transform –&gt; backtransform (even with no shifts in the distribution to reflect the scenarios) yields changes to the distribution. Which is worse/better? Not sure, they cause different sorts of errors. Might come down to which one is able to do the scenario shifts the best.</p>
<p>We could also do something like q-q away from 0, and one of these near it- e.g.&nbsp;fit the linear regression for the lower 10% of the data or only do the probs–&gt;lognormal dist shift for that part of the data.</p>
<p>And we’re still left with the issue of what to do with this if it works- can we ever shift this in a way to give more or less zeros?</p>
</section>
</section>
<section id="scaling-dists" class="level1">
<h1>Scaling dists</h1>
<p>How do we shift these distributions?</p>
<p>Let’s start by fitting the scenarios. I fit the baseline as manually-logged normal above, but I think here I’m trying to stick to just using the <code>lnorm</code> functions for simplicity.</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-72_4c1f4e4b3d1e4a817239dd5af80bdbd6">
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="co"># make a table from the fit</span></span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a>fittabler <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a>  fitout <span class="ot">&lt;-</span> <span class="fu">fitdist</span>(x, <span class="at">distr =</span> <span class="st">'lnorm'</span>)</span>
<span id="cb136-4"><a href="#cb136-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb136-5"><a href="#cb136-5" aria-hidden="true" tabindex="-1"></a>  fittable <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">meanlog =</span> fitout<span class="sc">$</span>estimate[<span class="st">'meanlog'</span>],</span>
<span id="cb136-6"><a href="#cb136-6" aria-hidden="true" tabindex="-1"></a>                     <span class="at">sdlog =</span> fitout<span class="sc">$</span>estimate[<span class="st">'sdlog'</span>],</span>
<span id="cb136-7"><a href="#cb136-7" aria-hidden="true" tabindex="-1"></a>                     <span class="at">loglik =</span> fitout<span class="sc">$</span>loglik)</span>
<span id="cb136-8"><a href="#cb136-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb136-9"><a href="#cb136-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(fittable)</span>
<span id="cb136-10"><a href="#cb136-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb136-11"><a href="#cb136-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-12"><a href="#cb136-12" aria-hidden="true" tabindex="-1"></a>scene_fits <span class="ot">&lt;-</span> test_model <span class="sc">%&gt;%</span> </span>
<span id="cb136-13"><a href="#cb136-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">starts_with</span>(<span class="st">'Sim'</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb136-14"><a href="#cb136-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(name) <span class="sc">%&gt;%</span> </span>
<span id="cb136-15"><a href="#cb136-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">fit_sims =</span> <span class="fu">fittabler</span>(value)) <span class="sc">%&gt;%</span> </span>
<span id="cb136-16"><a href="#cb136-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb136-17"><a href="#cb136-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(fit_sims)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s draw the pdfs. The sims only go to 30</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-73_05e852a078faba5b099ee3dfd9a85520">
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a>makecdf_df <span class="ot">&lt;-</span> <span class="cf">function</span>(name, meanlog, sdlog, loglik, <span class="at">x =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">30</span>, <span class="at">by =</span> <span class="fl">0.01</span>)) {</span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a>  cdf <span class="ot">&lt;-</span> <span class="fu">plnorm</span>(x, meanlog, sdlog)</span>
<span id="cb137-3"><a href="#cb137-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb137-4"><a href="#cb137-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">tibble</span>(<span class="at">x =</span> x, <span class="at">cdf =</span> cdf, <span class="at">scenario =</span> name))</span>
<span id="cb137-5"><a href="#cb137-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb137-6"><a href="#cb137-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-7"><a href="#cb137-7" aria-hidden="true" tabindex="-1"></a>scenecdf <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">pmap</span>(scene_fits, makecdf_df) <span class="sc">%&gt;%</span> </span>
<span id="cb137-8"><a href="#cb137-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And to make things easier for plotting</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-74_ca10c3555a3332695f45f04b0e38426f">
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a>model_long <span class="ot">&lt;-</span> test_model <span class="sc">%&gt;%</span> </span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">starts_with</span>(<span class="st">'Sim'</span>), <span class="at">names_to =</span> <span class="st">'scenario'</span>, <span class="at">values_to =</span> <span class="st">'runoff'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>How do those look?</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-75_0fa31a0903aff1a6aa4fd3300dca012e">
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ecdf</span>(<span class="at">data =</span> model_long, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> runoff, <span class="at">color =</span> scenario)) <span class="sc">+</span></span>
<span id="cb139-3"><a href="#cb139-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> scenecdf, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> cdf, </span>
<span id="cb139-4"><a href="#cb139-4" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">color =</span> scenario),</span>
<span id="cb139-5"><a href="#cb139-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb139-6"><a href="#cb139-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="scaling_zeros_files/figure-html/unnamed-chunk-75-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>That’s really hard to see, what if we just limit it to the lowest and highest?</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-76_2e52124a0a241af5f6d6f38cac08f792">
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ecdf</span>(<span class="at">data =</span> <span class="fu">filter</span>(model_long, scenario <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">'SimR1'</span>, <span class="st">'SimR7'</span>)),</span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> runoff, <span class="at">color =</span> scenario)) <span class="sc">+</span></span>
<span id="cb140-4"><a href="#cb140-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> <span class="fu">filter</span>(scenecdf, scenario <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">'SimR1'</span>, <span class="st">'SimR7'</span>)),</span>
<span id="cb140-5"><a href="#cb140-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> cdf, </span>
<span id="cb140-6"><a href="#cb140-6" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">color =</span> scenario),</span>
<span id="cb140-7"><a href="#cb140-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb140-8"><a href="#cb140-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="scaling_zeros_files/figure-html/unnamed-chunk-76-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Certainly not perfect, but nothing will be.</p>
<p>Now, how do we shift the distributions? The means and sds here are on the log scale, and so can be treated like normal parameters. AND, because they’re on the log scale, arithmetic changes in mean yield multiplicative changes in the data.</p>
<p>So, to shift NORMAL distributions, we just add means and so we need the difference from each scenario mean to the SimR0. And to shift the sds, we use a multiplicative shift.</p>
<p>A simple function I’ve used previously to shift data is</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-77_3eda7ab7721b86961da317d813559684">
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Shift the mean</span></span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a>shift_mean <span class="ot">&lt;-</span> <span class="cf">function</span>(sample_vals, mean_want) {</span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a>  mean_sample <span class="ot">&lt;-</span> <span class="fu">mean</span>(sample_vals)</span>
<span id="cb141-4"><a href="#cb141-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-5"><a href="#cb141-5" aria-hidden="true" tabindex="-1"></a>  mean_shift <span class="ot">&lt;-</span> mean_want <span class="sc">-</span> mean_sample</span>
<span id="cb141-6"><a href="#cb141-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-7"><a href="#cb141-7" aria-hidden="true" tabindex="-1"></a>  shiftsample <span class="ot">&lt;-</span> sample_vals <span class="sc">+</span> mean_shift</span>
<span id="cb141-8"><a href="#cb141-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb141-9"><a href="#cb141-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(shiftsample)</span>
<span id="cb141-10"><a href="#cb141-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb141-11"><a href="#cb141-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-12"><a href="#cb141-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Shift sd</span></span>
<span id="cb141-13"><a href="#cb141-13" aria-hidden="true" tabindex="-1"></a>shift_sd <span class="ot">&lt;-</span> <span class="cf">function</span>(sample_vals, sd_want) {</span>
<span id="cb141-14"><a href="#cb141-14" aria-hidden="true" tabindex="-1"></a>  sd_sample <span class="ot">&lt;-</span> <span class="fu">sd</span>(sample_vals)</span>
<span id="cb141-15"><a href="#cb141-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-16"><a href="#cb141-16" aria-hidden="true" tabindex="-1"></a>  sd_shift <span class="ot">&lt;-</span> sd_want<span class="sc">/</span>sd_sample</span>
<span id="cb141-17"><a href="#cb141-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-18"><a href="#cb141-18" aria-hidden="true" tabindex="-1"></a>  shiftsample <span class="ot">&lt;-</span> sample_vals <span class="sc">*</span> sd_shift</span>
<span id="cb141-19"><a href="#cb141-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb141-20"><a href="#cb141-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(shiftsample)</span>
<span id="cb141-21"><a href="#cb141-21" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb141-22"><a href="#cb141-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-23"><a href="#cb141-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Shift both</span></span>
<span id="cb141-24"><a href="#cb141-24" aria-hidden="true" tabindex="-1"></a>shift_mean_sd <span class="ot">&lt;-</span> <span class="cf">function</span>(sample_vals, </span>
<span id="cb141-25"><a href="#cb141-25" aria-hidden="true" tabindex="-1"></a>                          sd_want, mean_want) {</span>
<span id="cb141-26"><a href="#cb141-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb141-27"><a href="#cb141-27" aria-hidden="true" tabindex="-1"></a>  shiftedsd <span class="ot">&lt;-</span> <span class="fu">shift_sd</span>(sample_vals, sd_want)</span>
<span id="cb141-28"><a href="#cb141-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb141-29"><a href="#cb141-29" aria-hidden="true" tabindex="-1"></a>  shiftedboth <span class="ot">&lt;-</span> <span class="fu">shift_mean</span>(shiftedsd, mean_want)</span>
<span id="cb141-30"><a href="#cb141-30" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>But here, we don’t really want to do that directly to the data, we want to figure out what the shifts need to be based on the shifts between SimR0 and the others and yielding equivalent shifts from <em>arbitrary other distributions</em>. But seeing how the shifts need to work can help with that.</p>
<p>Basically, the mean shift needs to be calculated as the mean_new - mean_reference and the sd shift needs to be sd_new/sd_reference, where <code>*new</code> are the SimR1...7, and <code>*reference</code> are the SimR0. And then to apply them to the hydrograph distribution, the new sd is old_sd*sd_shift and new mean is old_mean + mean_shift.</p>
<p>So, let’s get those shift values for each scenario.</p>
<p><em>I need to fix werptoolkitr to allow extra columns, but need to get this done more</em> so, do the mean and log separately and glue together.</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-78_d377b527ecb723a6db8429a6d06d2f2e">
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a>scene_fits_mean <span class="ot">&lt;-</span> scene_fits <span class="sc">%&gt;%</span> </span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(name, meanlog) <span class="sc">%&gt;%</span> </span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">baseline_compare</span>(<span class="at">compare_col =</span> <span class="st">'name'</span>, </span>
<span id="cb142-4"><a href="#cb142-4" aria-hidden="true" tabindex="-1"></a>                   <span class="at">base_lev =</span> <span class="st">'SimR0'</span>, </span>
<span id="cb142-5"><a href="#cb142-5" aria-hidden="true" tabindex="-1"></a>                   <span class="at">values_col =</span> <span class="st">'meanlog'</span>, </span>
<span id="cb142-6"><a href="#cb142-6" aria-hidden="true" tabindex="-1"></a>                   <span class="at">comp_fun =</span> <span class="st">'difference'</span>)</span>
<span id="cb142-7"><a href="#cb142-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-8"><a href="#cb142-8" aria-hidden="true" tabindex="-1"></a>scene_fits_sd <span class="ot">&lt;-</span> scene_fits <span class="sc">%&gt;%</span> </span>
<span id="cb142-9"><a href="#cb142-9" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(name, sdlog) <span class="sc">%&gt;%</span> </span>
<span id="cb142-10"><a href="#cb142-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">baseline_compare</span>(<span class="at">compare_col =</span> <span class="st">'name'</span>, </span>
<span id="cb142-11"><a href="#cb142-11" aria-hidden="true" tabindex="-1"></a>                   <span class="at">base_lev =</span> <span class="st">'SimR0'</span>, </span>
<span id="cb142-12"><a href="#cb142-12" aria-hidden="true" tabindex="-1"></a>                   <span class="at">values_col =</span> <span class="st">'sdlog'</span>, </span>
<span id="cb142-13"><a href="#cb142-13" aria-hidden="true" tabindex="-1"></a>                   <span class="at">comp_fun =</span> <span class="st">'relative'</span>)</span>
<span id="cb142-14"><a href="#cb142-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-15"><a href="#cb142-15" aria-hidden="true" tabindex="-1"></a>scene_fits_shift <span class="ot">&lt;-</span> scene_fits <span class="sc">%&gt;%</span> </span>
<span id="cb142-16"><a href="#cb142-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(scene_fits_mean) <span class="sc">%&gt;%</span> </span>
<span id="cb142-17"><a href="#cb142-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(scene_fits_sd)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Joining, by = c("name", "meanlog")
Joining, by = c("name", "sdlog")</code></pre>
</div>
</div>
<p>I don’t really want to be operating out of a dataframe just to get single numbers, but I think I will for the moment to keep things consistent and clean up later.</p>
<p>Shift the <em>hydrograph</em> parameters to match the shifts in the <em>runoff</em> parameters</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-79_b3e7f544c18a93c4d588e8e40dc5fe2c">
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a>hydro_shift <span class="ot">&lt;-</span> scene_fits_shift <span class="sc">%&gt;%</span> </span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">hydro_meanlog =</span> optimal_fit<span class="sc">$</span>meanlog[<span class="dv">1</span>] <span class="sc">+</span> difference_meanlog,</span>
<span id="cb144-3"><a href="#cb144-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">hydro_sdlog =</span> optimal_fit<span class="sc">$</span>sdlog[<span class="dv">1</span>] <span class="sc">*</span> relative_sdlog,</span>
<span id="cb144-4"><a href="#cb144-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">hydro_shift =</span> optimal_fit<span class="sc">$</span>optimum_shift[<span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, generate the cdfs and look at them. Again, need to clean this up. Using the same function as above, so drop and rename some columns</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-80_30a33162c6c331918c340f21315b1b22">
<div class="sourceCode cell-code" id="cb145"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a>hydro_shift_cdf <span class="ot">&lt;-</span> hydro_shift <span class="sc">%&gt;%</span> </span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(name, loglik, <span class="at">meanlog =</span> hydro_meanlog, <span class="at">sdlog =</span> hydro_sdlog) <span class="sc">%&gt;%</span></span>
<span id="cb145-3"><a href="#cb145-3" aria-hidden="true" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">pmap</span>(makecdf_df, <span class="at">x =</span> <span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">10000</span>, <span class="at">by =</span> <span class="fl">0.1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb145-4"><a href="#cb145-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>() <span class="sc">|&gt;</span> </span>
<span id="cb145-5"><a href="#cb145-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">x_back =</span> x<span class="sc">-</span>hydro_shift<span class="sc">$</span>hydro_shift)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-81_ff5eb9f47c26346664970f22a6faf360">
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> hydro_shift_cdf, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> x_back, <span class="at">y =</span> cdf, </span>
<span id="cb146-3"><a href="#cb146-3" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">color =</span> scenario)) <span class="sc">+</span></span>
<span id="cb146-4"><a href="#cb146-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ecdf</span>(<span class="at">data =</span> test_hydro, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> value), <span class="at">color =</span> <span class="st">'black'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="scaling_zeros_files/figure-html/unnamed-chunk-81-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Ugh, that really isn’t very good. It crosses almost all of the lines- e.g.&nbsp;the difference between the scenarios is less than the difference between the data and a lognormal distribution.</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-82_6e54d81c952328266ad2a441863a95f7">
<div class="sourceCode cell-code" id="cb147"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> hydro_shift_cdf, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> x_back, <span class="at">y =</span> cdf, </span>
<span id="cb147-3"><a href="#cb147-3" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">color =</span> scenario)) <span class="sc">+</span></span>
<span id="cb147-4"><a href="#cb147-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ecdf</span>(<span class="at">data =</span> test_hydro, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> value), <span class="at">color =</span> <span class="st">'black'</span>) <span class="sc">+</span></span>
<span id="cb147-5"><a href="#cb147-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">50</span>, <span class="dv">1000</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="scaling_zeros_files/figure-html/unnamed-chunk-82-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Log scale</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-83_56430d927613b0eab3bdfad8973cf422">
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> hydro_shift_cdf, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> x_back, <span class="at">y =</span> cdf, </span>
<span id="cb148-3"><a href="#cb148-3" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">color =</span> scenario)) <span class="sc">+</span></span>
<span id="cb148-4"><a href="#cb148-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ecdf</span>(<span class="at">data =</span> test_hydro, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> value), <span class="at">color =</span> <span class="st">'black'</span>) <span class="sc">+</span></span>
<span id="cb148-5"><a href="#cb148-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">trans =</span> <span class="st">'log'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in self$trans$transform(x): NaNs produced</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Transformation introduced infinite values in continuous x-axis
Transformation introduced infinite values in continuous x-axis</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 4140 rows containing non-finite values (`stat_ecdf()`).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 4808 rows containing missing values (`geom_line()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="scaling_zeros_files/figure-html/unnamed-chunk-83-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Let’s look at the fits on the normal scale</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-84_25a87b00724cbc0321d5a63bd420ec44">
<div class="sourceCode cell-code" id="cb153"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a>make_norm_dfs <span class="ot">&lt;-</span> <span class="cf">function</span>(name, meanlog, sdlog, </span>
<span id="cb153-2"><a href="#cb153-2" aria-hidden="true" tabindex="-1"></a>                         <span class="at">x =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">5</span>, <span class="dv">10</span>, <span class="at">by =</span> <span class="fl">0.01</span>)) {</span>
<span id="cb153-3"><a href="#cb153-3" aria-hidden="true" tabindex="-1"></a>  cdf <span class="ot">&lt;-</span> <span class="fu">pnorm</span>(x, meanlog, sdlog)</span>
<span id="cb153-4"><a href="#cb153-4" aria-hidden="true" tabindex="-1"></a>  pdf <span class="ot">&lt;-</span> <span class="fu">dnorm</span>(x, meanlog, sdlog)</span>
<span id="cb153-5"><a href="#cb153-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb153-6"><a href="#cb153-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">tibble</span>(<span class="at">x =</span> x, <span class="at">cdf =</span> cdf, <span class="at">pdf =</span> pdf, <span class="at">scenario =</span> name))</span>
<span id="cb153-7"><a href="#cb153-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb153-8"><a href="#cb153-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-9"><a href="#cb153-9" aria-hidden="true" tabindex="-1"></a>hydro_shift_norm <span class="ot">&lt;-</span> hydro_shift <span class="sc">%&gt;%</span> </span>
<span id="cb153-10"><a href="#cb153-10" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(name, <span class="at">meanlog =</span> hydro_meanlog, <span class="at">sdlog =</span> hydro_sdlog) <span class="sc">%&gt;%</span></span>
<span id="cb153-11"><a href="#cb153-11" aria-hidden="true" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">pmap</span>(make_norm_dfs) <span class="sc">%&gt;%</span> </span>
<span id="cb153-12"><a href="#cb153-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The shifts are going to make things wonky, because they were done on the base scale, and so don’t directly translate to a shift in x on the log scale. But hopefully we can see whether the shapes are way off. If we want to fit things on the log scale as normals, we should just do it directly (and not sure what we’d do about the shifts, then)- would need a different censoring assessment- maybe we <em>could</em> just fit them as truncated in that case, since the distribution won’t be bounded. The cdfs shouldn’t really tell us much new here- they’re just a rescaling.</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-85_eff5852995a406be7ac54360d6b3542e">
<div class="sourceCode cell-code" id="cb154"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb154-2"><a href="#cb154-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> hydro_shift_norm, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> cdf, </span>
<span id="cb154-3"><a href="#cb154-3" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">color =</span> scenario)) <span class="sc">+</span></span>
<span id="cb154-4"><a href="#cb154-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ecdf</span>(<span class="at">data =</span> test_hydro, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(value)), <span class="at">color =</span> <span class="st">'black'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 4140 rows containing non-finite values (`stat_ecdf()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="scaling_zeros_files/figure-html/unnamed-chunk-85-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>And the pdfs.</p>
<div class="cell" data-hash="scaling_zeros_cache/html/unnamed-chunk-86_ffb76abc84a80b9aee8a399dcc1f5502">
<div class="sourceCode cell-code" id="cb156"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> hydro_shift_norm, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> pdf, </span>
<span id="cb156-3"><a href="#cb156-3" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">color =</span> scenario)) <span class="sc">+</span></span>
<span id="cb156-4"><a href="#cb156-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">data =</span> test_hydro, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(value)), <span class="at">color =</span> <span class="st">'black'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 4140 rows containing non-finite values (`stat_density()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="scaling_zeros_files/figure-html/unnamed-chunk-86-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>That’s just not normal, and so the fits will always be janky.</p>
</section>
<section id="additional-approaches" class="level1">
<h1>Additional approaches</h1>
<section id="fit-dists-but-different-function" class="level2">
<h2 class="anchored" data-anchor-id="fit-dists-but-different-function">Fit dists, but different function</h2>
<p>Is there any advantage to trying to manually log the data and then fit? Not sure. Since we’re fitting to minimize loglikelihood, the fits should be the same. But it might let us do a better job of the shifts, because we could then treat it as a truncated distribution, rather than a shift and backshift. I think I should try this- once I get everything set up for the lognormal, it should be OK.</p>
<p>Could try other distributions, but Weibull sure was terrible. Not sure what else that’s parametric.</p>
</section>
<section id="linearize-part-of-the-model-data-relationship-not-all-of-it" class="level2">
<h2 class="anchored" data-anchor-id="linearize-part-of-the-model-data-relationship-not-all-of-it">Linearize part of the model-data relationship, not all of it</h2>
<p>Could I do the regression method for the bottom 10%, and then the other 90% use q-q (probably, since it’s the least parametric) or the distribution fits?</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">Website, documentation, and toolkit work in progress. Not to be distributed outside QAEL, MDBA, CSIRO</div>   
  </div>
</footer>



</body></html>