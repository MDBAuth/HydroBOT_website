<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.269">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Galen Holt">

<title>Using the WERP toolkit - Flow scaling demonstration</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

<link href="../site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet">
<script src="../site_libs/pagedtable-1.1/js/pagedtable.js"></script>


</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Using the WERP toolkit</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="../scenario_creation/scenario_creation_overview.html" aria-current="page">
 <span class="menu-text">Scenario creation</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../causal_networks/causal_overview.html">
 <span class="menu-text">Causal networks</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../controller/controller_overview.html">
 <span class="menu-text">Controller</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../aggregator/aggregation_overview.html">
 <span class="menu-text">Aggregator</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../comparer/comparer_overview.html">
 <span class="menu-text">Comparer</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../full_toolkit/full_toolkit_overview.html">
 <span class="menu-text">Full toolkit</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/MDBAuth/WERP_toolkit_demo"><i class="bi bi-github" role="img" aria-label="GitHub">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
              <div class="quarto-toggle-container">
                  <a href="" class="quarto-color-scheme-toggle nav-link" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
              </div>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">Flow scaling demonstration</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../scenario_creation/scenario_creation_overview.html" class="sidebar-item-text sidebar-link">Scenario creation</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">Simple</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../scenario_creation/scenario_creation_demo_R.html" class="sidebar-item-text sidebar-link">Simple scenarios for demonstration</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../scenario_creation/scenario_creation_demo_py.qmd" class="sidebar-item-text sidebar-link">Python version (old)</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">Flow scaling and climate scenarios</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../scenario_creation/flow_scaling.html" class="sidebar-item-text sidebar-link active">Pulling historical gauges</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../scenario_creation/scaling_scenarios.qmd" class="sidebar-item-text sidebar-link">Flow scaling to climate models</a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#creating-scaled-hydrographs" id="toc-creating-scaled-hydrographs" class="nav-link active" data-scroll-target="#creating-scaled-hydrographs">Creating scaled hydrographs</a>
  <ul class="collapse">
  <li><a href="#process" id="toc-process" class="nav-link" data-scroll-target="#process">Process</a></li>
  <li><a href="#toolkit-relevance" id="toc-toolkit-relevance" class="nav-link" data-scroll-target="#toolkit-relevance">Toolkit relevance</a></li>
  <li><a href="#set-up-paths" id="toc-set-up-paths" class="nav-link" data-scroll-target="#set-up-paths">Set up paths</a></li>
  </ul></li>
  <li><a href="#identify-relevant-gauges" id="toc-identify-relevant-gauges" class="nav-link" data-scroll-target="#identify-relevant-gauges">Identify relevant gauges</a>
  <ul class="collapse">
  <li><a href="#gauges-in-ewr" id="toc-gauges-in-ewr" class="nav-link" data-scroll-target="#gauges-in-ewr">Gauges in EWR</a></li>
  <li><a href="#map-gauges" id="toc-map-gauges" class="nav-link" data-scroll-target="#map-gauges">Map gauges</a></li>
  <li><a href="#mapping-gauges-to-sdl-unit" id="toc-mapping-gauges-to-sdl-unit" class="nav-link" data-scroll-target="#mapping-gauges-to-sdl-unit">Mapping gauges to SDL unit</a></li>
  </ul></li>
  <li><a href="#pull-the-gauges" id="toc-pull-the-gauges" class="nav-link" data-scroll-target="#pull-the-gauges">Pull the gauges</a>
  <ul class="collapse">
  <li><a href="#set-up-for-the-pull" id="toc-set-up-for-the-pull" class="nav-link" data-scroll-target="#set-up-for-the-pull">Set up for the pull</a></li>
  <li><a href="#cleanup" id="toc-cleanup" class="nav-link" data-scroll-target="#cleanup">Cleanup</a>
  <ul class="collapse">
  <li><a href="#drop-to-just-ewr-columns" id="toc-drop-to-just-ewr-columns" class="nav-link" data-scroll-target="#drop-to-just-ewr-columns">Drop to just EWR columns</a></li>
  </ul></li>
  <li><a href="#todo" id="toc-todo" class="nav-link" data-scroll-target="#todo">TODO</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">Flow scaling demonstration</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Galen Holt </p>
          </div>
  </div>
    
  
    
  </div>
  

</header>

<div class="cell" data-hash="flow_scaling_cache/html/unnamed-chunk-1_99c1bc1846d378f80b6d8bb82f73e96b">

</div>
<div class="cell" data-hash="flow_scaling_cache/html/unnamed-chunk-2_727fae5c1d22228b067e61e21190ef86">

</div>
<section id="creating-scaled-hydrographs" class="level1">
<h1>Creating scaled hydrographs</h1>
<p>Here, we want to grab historical gauge data from across the basin, match it to its catchment so we can use catchment-specific scaling factors, and then create scaled scenarios. These will then be run through the toolkit to</p>
<ol type="1">
<li><p>Demonstrate how the toolkit works and its capabilities</p></li>
<li><p>Identify needed improvements</p></li>
<li><p>Identify our ability to detect changes in outcomes (sensitivity analysis of the available response model– EWR module).</p></li>
</ol>
<p>What this <em>isn’t</em> is the best model of climate change. Instead, it uses simple scaling to come up with a reasonable range of changes, and uses them to assess the tools available.</p>
<section id="process" class="level2">
<h2 class="anchored" data-anchor-id="process">Process</h2>
<p>To create the scenario hydrographs, we need to</p>
<ol type="1">
<li><p>Identify gauges in the EWR tool, since that’s the module that currently exists</p></li>
<li><p>Pull their historical data</p></li>
<li><p>Map them to SDL units, because the scaling simulations are done at that scale</p>
<ol type="1">
<li>This document stops at this point, along with some visualisations</li>
</ol></li>
<li><p>Scale them. This is done in <a href="scaling_scenarios.qmd">scaling_scenarios.qmd</a>.</p></li>
</ol>
<p>At that point, the scenario hydrographs will be created, and we can then run them through the toolkit.</p>
</section>
<section id="toolkit-relevance" class="level2">
<h2 class="anchored" data-anchor-id="toolkit-relevance">Toolkit relevance</h2>
<p>The creation of flow scenarios is not part of the toolkit proper. Instead, the toolkit expects to ingest hydrographs and then handles the ongoing response models, aggregation, and analyses. Thus, hydrographs are an essential input to the toolkit. The point of this code is to generate those hydrographs.</p>
</section>
<section id="set-up-paths" class="level2">
<h2 class="anchored" data-anchor-id="set-up-paths">Set up paths</h2>
<p>For the <a href="../scenario_creation/scenario_creation_demo_R.html">smaller demo</a> the data inside the repo so users can see what’s being produced. For this, we’ll follow a more typical use-case where both the input and output data are external, and so we need their path. This will likely end up on MDBA blob, but for now, I’ll just send it up a level locally. We’ll create an internal directory for the hydrographs, since the other output goes in the <code>scenario_dir</code> as well.</p>
<div class="cell" data-hash="flow_scaling_cache/html/unnamed-chunk-3_a3c4a2675020939e9ce8dbd8cc4cc09e">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>scenario_dir <span class="ot">&lt;-</span> <span class="st">'../flow_scaling_data'</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>hydro_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(scenario_dir, <span class="st">'hydrographs'</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>scaling_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(scenario_dir, <span class="st">'CC_Scenarios_WRPs'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="flow_scaling_cache/html/unnamed-chunk-4_a42c2370d71adb7ee1f8c3788bcb3232">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(hydro_dir)) {<span class="fu">dir.create</span>(hydro_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="identify-relevant-gauges" class="level1">
<h1>Identify relevant gauges</h1>
<p>We want <em>all</em> the gauges in the EWR tool (i.e.&nbsp;all the gauges we can assess).</p>
<section id="gauges-in-ewr" class="level2">
<h2 class="anchored" data-anchor-id="gauges-in-ewr">Gauges in EWR</h2>
<p>Which gauges are actually in the EWR tool? The EWR tool has a function, so use that. <em>Use python to access the EWR table</em>. <em>Access the python objects with</em> <code>py$objname</code>.</p>
<div id="ewr_update">
<p><strong>TODO</strong> THIS FAILS AS OF 1.0.4. I have rolled back to ewr version 1.0.1, since the necessary file just doesn’t exist in 1.0.4 (and in about half the branches on github). This needs to be updated and tested.</p>
<p>Error messages:</p>
<pre><code>FileNotFoundError: [Errno 2] No such file or directory: 'py_ewr/parameter_metadata/NSWEWR.csv'

Error in py_get_attr_impl(x, name, silent) : 
  AttributeError: module '__main__' has no attribute 'ewrs'</code></pre>
</div>
<div class="cell" data-hash="flow_scaling_cache/html/unnamed-chunk-5_f0385ab2281293dca7414a67c736683d">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> py_ewr.data_inputs <span class="im">import</span> get_EWR_table</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> py_ewr.observed_handling <span class="im">import</span> categorise_gauges</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>ewrs, badewrs <span class="op">=</span> get_EWR_table()</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>distinctgauges <span class="op">=</span> ewrs[<span class="st">'Gauge'</span>].unique()</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Separate into flow gauges, level gauges, and stage gauges</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>catgauges <span class="op">=</span> categorise_gauges(distinctgauges)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Get those gauge numbers into an R object, and ask how many. <code>py$ewrs</code>is the full EWR table. So we have made them unique, and then used <code>py_ewe.observed_handling.categorise_gauges</code> to separate them into flow, level, and stage gauges (as documented in that function).</p>
<p>Pull the full list into R to use for things like mapping, and then categorized list too.</p>
<div class="cell" data-hash="flow_scaling_cache/html/unnamed-chunk-6_57c8f674b0f4dfbc58fb59db66180edb">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>ewrgauges <span class="ot">=</span> <span class="fu">unique</span>(py<span class="sc">$</span>ewrs<span class="sc">$</span>Gauge)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(ewrgauges)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 149</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>gauge_cats <span class="ot">&lt;-</span> py<span class="sc">$</span>catgauges <span class="sc">%&gt;%</span> </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setNames</span>(<span class="fu">c</span>(<span class="st">'flow'</span>, <span class="st">'level'</span>, <span class="st">'stage'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I could leave that as a list, but a dataframe ends up helping later on with other arguments (e.g.&nbsp;state and variable) and is easier to map.</p>
<div class="cell" data-hash="flow_scaling_cache/html/unnamed-chunk-7_dc07050413f6501d07a8b23360777372">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>cat_gauges <span class="ot">&lt;-</span> gauge_cats <span class="sc">%&gt;%</span> </span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stack</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">gauge =</span> values, <span class="at">type =</span> ind) <span class="sc">%&gt;%</span> </span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">var_to =</span> <span class="fu">case_when</span>(</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    type <span class="sc">==</span> <span class="st">'flow'</span> <span class="sc">~</span> <span class="dv">141</span>,</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    type <span class="sc">==</span> <span class="st">'level'</span> <span class="sc">~</span> <span class="dv">130</span>,</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    type <span class="sc">==</span> <span class="st">'stage'</span> <span class="sc">~</span> <span class="dv">100</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  ))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>149 gauges doesn’t seem too bad.</p>
</section>
<section id="map-gauges" class="level2">
<h2 class="anchored" data-anchor-id="map-gauges">Map gauges</h2>
<p>The gauges with their locations as an <code>sf</code> object are in <code>werptoolkitr::bom_basin_gauges</code>.</p>
<p>Join to the categorized table. <code>right_join</code> maintains the <code>sf</code> object but only has rows for cat_gauges.</p>
<div class="cell" data-hash="flow_scaling_cache/html/unnamed-chunk-8_472c640c8704fdae275d4d1e00544bf1">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>geo_gauges <span class="ot">&lt;-</span> <span class="fu">right_join</span>(bom_basin_gauges, cat_gauges)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Joining with `by = join_by(gauge)`</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(geo_gauges  <span class="sc">%&gt;%</span> </span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">st_is_empty</span>(geometry)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 141</code></pre>
</div>
</div>
<p>The <code>st_is_empty</code> filter is because some of the gauges are things like ‘Bills Pipe’ and ‘Pump direct from river’, and so don’t actually have locations. They aren’t pullable from NSW, but we can leave them in for now.</p>
<p>Note that this contains level gauges (and stage). I include the stage gauges in the flow scaling, but not the level. All three types are likely to respond to runoff, with flow being the most directly related, and stage more nonlinear. Level changes will be much more difficult to translate, and so we drop them, at least for the moment.</p>
<div class="cell" data-hash="flow_scaling_cache/html/unnamed-chunk-9_4c9760a641bd95f74f64671917ad8efb">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The commented out code labels the SDL units, but it's too busy.</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> sdl_units, </span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>          <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">fill =</span> SWSDLName), </span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>          <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># geom_sf_label(data = sdl_units, </span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">#               mapping = aes(label = SWSDLName), </span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">#               size = 3, </span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">#               label.padding = unit(0.1, 'lines')) +</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> geo_gauges, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">color=</span> type)) <span class="sc">+</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  colorspace<span class="sc">::</span><span class="fu">scale_fill_discrete_qualitative</span>(<span class="at">palette =</span> <span class="st">'Harmonic'</span>) <span class="sc">+</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>  colorspace<span class="sc">::</span><span class="fu">scale_color_discrete_diverging</span>(<span class="at">palette =</span> <span class="st">'Lisbon'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="flow_scaling_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="mapping-gauges-to-sdl-unit" class="level2">
<h2 class="anchored" data-anchor-id="mapping-gauges-to-sdl-unit">Mapping gauges to SDL unit</h2>
<p>To do the flow-scaling, we’ll need to know the SDL unit. While we’re here working with both, let’s add that on to <code>geo_gauges</code> (though we end up doing it a bit differently in the <a href="scaling_scenarios.qmd">scaling notebook</a>.</p>
<div class="cell" data-hash="flow_scaling_cache/html/unnamed-chunk-10_a56300f7957c43c753f9894c30a22786">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>geo_gauges <span class="ot">&lt;-</span> <span class="fu">st_intersection</span>(geo_gauges, sdl_units)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: attribute variables are assumed to be spatially constant throughout all
geometries</code></pre>
</div>
</div>
</section>
</section>
<section id="pull-the-gauges" class="level1">
<h1>Pull the gauges</h1>
<p>We get the gauge data with <a href="https://github.com/galenholt/vicwater">{vicwater}</a> (now), so we feed <code>geo_gauges$gauge</code> to that, broken into groups by <code>type</code>, e.g.&nbsp;level, flow, stage, because these affect the <code>var_from</code> and <code>var_to</code> we have to ask for. And, despite the EWRs all being in NSW at present, some of the <em>gauges</em> are run by Victoria, so we also need to get the <code>state</code> argument.</p>
<p>We want to pull the full period of record. David’s scenarios go 1 Jan 1890 to 31 Jan 2019. Most gauges start after 1890, and go past 2019. We can still scale the full period of record though because we use q-q scaling, which does not depend on date-matching.</p>
<p>::: {#Aside- gauge puller} I use <code>mdba_gauge_getter</code> to pull gauges in <a href="../scenario_creation/scenario_creation_demo_R.html">scenario_creation_demo_R.qmd</a>, but there are a couple issues with it- if I pull data from both before and after the gauge start date, it fills the first section with zeros. This is an issue with the API itself. I’ve switched to my <a href="https://github.com/galenholt/vicwater">{vicwater}</a> package in R, because it’s able to automatically find the period of record and only pull available data for a site (and despite the name, works for Vic, NSW, and QLD).</p>
<p>We can do this two ways- using <code>get_variable_list</code>, extracting the start and end, and then passing those to <code>get_ts_traces</code>. Or we can use <code>get_ts_traces2</code>, which can do the timeperiod extraction internally. Some speed testing shows they’re equivalent, so I’ll use the automated and cleaner <code>get_ts_traces2</code>. :::</p>
<section id="set-up-for-the-pull" class="level2">
<h2 class="anchored" data-anchor-id="set-up-for-the-pull">Set up for the pull</h2>
<p>I’m being explicit about daily means and <code>var_to</code> arguments to match those used internally by <code>mdba_gauge_getter</code> in the EWR tool, since that’s what the EWR expects. I’m using <code>returnformat = sitelist</code> to return a list of gauges instead of a long dataframe because that makes it easier to find (and bypass) site failures.</p>
<p>If we didn’t need a state argument, we could use the <code>gauge_cats</code> list as <code>site_list</code>, with a length-3 vector of the <code>var_to</code> values, since that list is already set up. But we also need the state argument, and that’s on a gauge-by-gauge basis. So instead I call <code>get_ts_traces2</code> for each combination of gauge type and state, since there are gauges in Vic, Qld, and NSW.</p>
<div class="cell" data-hash="flow_scaling_cache/html/unnamed-chunk-11_d5c6b4a2ad8819d6db29d898fa931620">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(geo_gauges<span class="sc">$</span>owner, geo_gauges<span class="sc">$</span>type)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                           
                                                            flow level stage
  NSW - NSW Department of Industry – Lands and Water         133     4     0
  QLD - Department of Natural Resources, Mines and Energy      1     0     0
  VIC - Department of Environment, Land, Water and Planning    2     0     1</code></pre>
</div>
</div>
<p>After lots of testing, I’ve decided to use <code>datasource = A</code> because <code>CP</code> gives unstable 504 Gateway timeouts. It’s tempting to just <code>furrr::future_pmap</code> over the rows of <code>geo_gauges</code>, but that takes about 20x as long, likely a combination of data-passing with <code>furrr</code> and additional API calls to get periods of record. We shouldn’t need to do this much, but still, it’s likely we’ll need to more than once.</p>
<p>We create a dataframe with the arguments to use with <code>purrr::pmap</code>. The <code>gauge</code> column is a list of tibbles, and for each one we need to unlist it to make it a character vector- <code>get_ts_traces</code> doesn’t accept tibbles of gauge numbers.</p>
<div class="cell" data-hash="flow_scaling_cache/html/unnamed-chunk-12_4bccf08d04fa8b01e920a29fe04fcc9f">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>gauges_to_pull <span class="ot">&lt;-</span> geo_gauges <span class="sc">%&gt;%</span> </span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(gauge, owner, var_to) <span class="sc">%&gt;%</span> </span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest_by</span>(owner, var_to, <span class="at">.key =</span> <span class="st">'gauge'</span>)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>gauges_to_pull</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["owner"],"name":[1],"type":["chr"],"align":["left"]},{"label":["var_to"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["gauge"],"name":[3],"type":["list<tibble[,1]>"],"align":["right"]}],"data":[{"1":"NSW - NSW Department of Industry – Lands and Water","2":"130","3":"<list<tibble[,1]>>"},{"1":"NSW - NSW Department of Industry – Lands and Water","2":"141","3":"<list<tibble[,1]>>"},{"1":"QLD - Department of Natural Resources, Mines and Energy","2":"141","3":"<list<tibble[,1]>>"},{"1":"VIC - Department of Environment, Land, Water and Planning","2":"100","3":"<list<tibble[,1]>>"},{"1":"VIC - Department of Environment, Land, Water and Planning","2":"141","3":"<list<tibble[,1]>>"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>Use a simple wrapper with matching names to make calling the main function easier by feeding defaults.</p>
<div class="cell" data-hash="flow_scaling_cache/html/unnamed-chunk-13_29448aa760c35c9ed015c89b32ca0223">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>wrap_traces <span class="ot">&lt;-</span> <span class="cf">function</span>(owner,var_to,gauge) {</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  traces <span class="ot">&lt;-</span> <span class="fu">get_ts_traces2</span>(<span class="at">state =</span> owner, </span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>                            <span class="at">site_list =</span> <span class="fu">unlist</span>(gauge, <span class="at">use.names =</span> <span class="cn">FALSE</span>), </span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>                            <span class="at">var_list =</span> var_to,</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>                            <span class="at">start_time =</span> <span class="st">'all'</span>,</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>                            <span class="at">end_time =</span> <span class="st">'all'</span>,</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>                            <span class="at">interval =</span> <span class="st">'day'</span>,</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>                            <span class="at">data_type =</span> <span class="st">'mean'</span>,</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>                           <span class="at">datasource =</span> <span class="st">'A'</span>,</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>                            <span class="at">returnformat =</span> <span class="st">'sitelist'</span>,</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>                            <span class="at">.errorhandling =</span> <span class="st">'pass'</span>)</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This <code>purrr::pmap</code> works most of the time, but occasionally hits a 504 Gateway Timeout, which seem to happen much more frequently with <code>datasource = 'CP</code>, but are also just haphazard. The <code>safely</code> lets it finish, but still annoying to have to re-do any missing pieces. Takes about 2 minutes.</p>
<div class="cell" data-hash="flow_scaling_cache/html/unnamed-chunk-14_1c6432d7cd88c3a24a7a341fe0cb6eb9">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(all_gauges <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">pmap</span>(gauges_to_pull, purrr<span class="sc">::</span><span class="fu">safely</span>(wrap_traces)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   user  system elapsed 
   8.45    1.07  115.62 </code></pre>
</div>
</div>
<p>That produces a list with 141 gauges that’s 494.3 MB (on 13 Mar 2023) in 125 seconds. Surprisingly fast, really. I’m going to save it though, both to avoid doing it every time and to have a fixed set of data to work with for reproducibility.</p>
</section>
<section id="cleanup" class="level2">
<h2 class="anchored" data-anchor-id="cleanup">Cleanup</h2>
<p>Because we used <code>safely</code>, we need to parse out errors. First, are there any?</p>
<div class="cell" data-hash="flow_scaling_cache/html/unnamed-chunk-15_8e75f0240add4768d094206caab8f1f9">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">which</span>(purrr<span class="sc">::</span><span class="fu">map_lgl</span>(all_gauges, \(x) <span class="sc">!</span><span class="fu">is.null</span>(x<span class="sc">$</span>error)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>integer(0)</code></pre>
</div>
</div>
<p>Extract just the <code>$result</code>. I could re-map this to all_gauges so I don’t have so much in memory, but not going to bother.</p>
<div class="cell" data-hash="flow_scaling_cache/html/unnamed-chunk-16_8e7c42fc991bcd1bd60924a95e6443a6">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>all_results <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map</span>(all_gauges,</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>                          \(x) purrr<span class="sc">::</span><span class="fu">pluck</span>(x, <span class="st">'result'</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">flatten</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Use <code>is.null</code> to catch those that errored and didn’t return.</p>
<div class="cell" data-hash="flow_scaling_cache/html/unnamed-chunk-17_7e0276c5e0b9b0399690c55d0cd78165">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>datarows <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map_int</span>(all_results, </span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>                           \(x) <span class="cf">if</span> (<span class="fu">is.null</span>(x)) {<span class="dv">0</span>} <span class="cf">else</span> {<span class="fu">nrow</span>(x)})</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>datarows</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> 412107  425020  425022  425023  409003  409017  409019  409020  409023  409024 
  17278   15967   19924   15969   48659   34075   31778   31778   31777   34071 
 409025  409048  410001  410005  410006  410007  410008  410014  410015  410016 
  22747   14415   56435   47925   19286   16126   22402   16088   16685   40347 
 410021  410033  410040  410093  410130  410134  412002  412004  412005  412011 
  18960   39033   17581   17030   15741   16379   47826   47402   47360   41155 
 412012  412016  412033  412036  412038  412039  412042  412046  412122  412124 
  42384   38909   31148   43806   47286   30069   27735   38721    7182    7182 
 412163  412188  412189  416001  416003  416006  416007  416008  416010  416011 
   7013    7650    5746   18212   37248   19379   18918   19420   18358   18698 
 416012  416020  416027  416032  416037  416039  416040  416047  416048  416050 
  18977   16398   15912   19770   17773   18345    9976   14104   13084   12915 
 416052  416072  417001  418002  418004  418011  418013  418026  418037  418048 
  13042    4212   19060   31288   34196   16010   24878   20085   19974   14924 
 418049  418052  418053  418055  418063  418066  418068  418070  418074  418076 
  13225   15479   14757   15589   13594   12670   12427   10550    9442    9413 
 418078  418079  418085  419001  419006  419007  419012  419015  419016  419020 
   9382    9388    7292   19846   18258   18122   24894   15993   18096   16835 
 419021  419022  419026  419027  419028  419032  419039  419045  419049  419091 
  18815   19222   18817   18765   14768   16543   18290   18543   18317    9396 
 420020  421001  421004  421011  421012  421019  421022  421023  421088  421090 
   7741   65924   40243   19998   30769   24522   24847   29326   17374   13481 
 421146  422001  422002  422003  422004  422005  422013  422015  422016  422025 
  12916   18262   47596   15448   15590   28732   21260   23023   21257    8567 
 422026  422027  422028  423001  423002  423004  423005  425003  425004  425007 
   8442    8443    8600   36931   36931   10818   10817   46729   43390   30313 
 425008  425010  425012  425013  425019  425039  425900 416201A  414209  409207 
  33035   13216   17929   18804   22208    8599   10149   38418    1590   17622 
 414203 
  17361 </code></pre>
</div>
</div>
<p>Check missing data</p>
<div class="cell" data-hash="flow_scaling_cache/html/unnamed-chunk-18_ea858a19b214d6e1af6766e746a95308">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">any</span>(datarows <span class="sc">==</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] FALSE</code></pre>
</div>
</div>
<p>Check error_num</p>
<div class="cell" data-hash="flow_scaling_cache/html/unnamed-chunk-19_946c50d4196f4a6205502039649160d2">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">any</span>(purrr<span class="sc">::</span><span class="fu">map</span>(all_results, \(x) <span class="fu">sum</span>(x<span class="sc">$</span>error_num <span class="sc">&gt;</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span> <span class="fu">unlist</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] FALSE</code></pre>
</div>
</div>
<div id="data-note">
<p>Gauge 412036 returns duplicate entries for every day from 1990-2004. The actual flow values differ for each pair and it’s not clear which to use. It seems to be an issue straight from the API- they come in that way, no matter the datasource or subset of the period. I’ve left them in here, but need to cut out one or both when we use the data. See <a href="scaling_functions.qmd">scaling notebook</a>.</p>
</div>
<section id="drop-to-just-ewr-columns" class="level3">
<h3 class="anchored" data-anchor-id="drop-to-just-ewr-columns">Drop to just EWR columns</h3>
<p>All we really need for the EWR tool is date and value, but we also keep the quality code id and variable on the data too so it’s clear what we have until the data gets used.</p>
<div class="cell" data-hash="flow_scaling_cache/html/unnamed-chunk-20_dacdb2ed7a2f1e5b48e49afc7619b870">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>just_values <span class="ot">&lt;-</span> all_results <span class="sc">%&gt;%</span> </span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">map</span>(\(x) dplyr<span class="sc">::</span><span class="fu">select</span>(x, time, site, value, variable, </span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>                                quality_codes_id, quality_codes))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Save the data</p>
<div class="cell" data-hash="flow_scaling_cache/html/unnamed-chunk-21_5e5b6cd26a8c81d34e5cbc807f49a1e1">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (REBUILD_DATA) {</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">saveRDS</span>(just_values, <span class="at">file =</span> <span class="fu">file.path</span>(hydro_dir, <span class="st">'extracted_flows.rds'</span>))</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="todo" class="level2">
<h2 class="anchored" data-anchor-id="todo">TODO</h2>
<ul>
<li><p>save format</p>
<ul>
<li><p>Currently separate files since each sequence has a different date range</p></li>
<li><p>Could have one file per scenario with cols for gauges, but would have lots of empty cells when dates don’t match</p></li>
<li><p>whatever the standard netcdf format is, once we know what it is</p></li>
</ul></li>
</ul>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">Website, documentation, and toolkit work in progress. Not to be distributed outside QAEL, MDBA, CSIRO</div>   
  </div>
</footer>



</body></html>