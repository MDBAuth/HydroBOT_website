<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.269">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Galen Holt">

<title>Using the WERP toolkit - Flow scaling methods</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Using the WERP toolkit</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="../scenario_creation/scenario_creation_overview.html" aria-current="page">
 <span class="menu-text">Scenario creation</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../causal_networks/causal_overview.html">
 <span class="menu-text">Causal networks</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../controller/controller_overview.html">
 <span class="menu-text">Controller</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../aggregator/aggregation_overview.html">
 <span class="menu-text">Aggregator</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../comparer/comparer_overview.html">
 <span class="menu-text">Comparer</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../full_toolkit/full_toolkit_overview.html">
 <span class="menu-text">Full toolkit</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/MDBAuth/WERP_toolkit_demo"><i class="bi bi-github" role="img" aria-label="GitHub">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
              <div class="quarto-toggle-container">
                  <a href="" class="quarto-color-scheme-toggle nav-link" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
              </div>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">Flow scaling methods</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../scenario_creation/scenario_creation_overview.html" class="sidebar-item-text sidebar-link">Scenario creation</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">Simple</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../scenario_creation/scenario_creation_demo_R.html" class="sidebar-item-text sidebar-link">Simple scenarios for demonstration</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../scenario_creation/scenario_creation_demo_py.qmd" class="sidebar-item-text sidebar-link">Python version (old)</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">Flow scaling and climate scenarios</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../scenario_creation/flow_scaling.html" class="sidebar-item-text sidebar-link">Pulling historical gauges</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../scenario_creation/scaling_scenarios.qmd" class="sidebar-item-text sidebar-link">Flow scaling to climate models</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../scenario_creation/flow_scaling_methods.html" class="sidebar-item-text sidebar-link active">Exploring flow scaling methods</a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#goal-and-approaches" id="toc-goal-and-approaches" class="nav-link active" data-scroll-target="#goal-and-approaches">Goal and approaches</a></li>
  <li><a href="#q-q-scaling" id="toc-q-q-scaling" class="nav-link" data-scroll-target="#q-q-scaling">Q-Q scaling</a>
  <ul class="collapse">
  <li><a href="#do-the-scaling" id="toc-do-the-scaling" class="nav-link" data-scroll-target="#do-the-scaling">Do the scaling</a></li>
  <li><a href="#outcome-distributions" id="toc-outcome-distributions" class="nav-link" data-scroll-target="#outcome-distributions">Outcome distributions</a>
  <ul class="collapse">
  <li><a href="#compare-baselines" id="toc-compare-baselines" class="nav-link" data-scroll-target="#compare-baselines">Compare baselines</a></li>
  <li><a href="#compare-scenario-shifts" id="toc-compare-scenario-shifts" class="nav-link" data-scroll-target="#compare-scenario-shifts">Compare scenario shifts</a></li>
  <li><a href="#zeros" id="toc-zeros" class="nav-link" data-scroll-target="#zeros">Zeros</a></li>
  </ul></li>
  <li><a href="#conclusions" id="toc-conclusions" class="nav-link" data-scroll-target="#conclusions">Conclusions</a></li>
  </ul></li>
  <li><a href="#ranked-regression" id="toc-ranked-regression" class="nav-link" data-scroll-target="#ranked-regression">Ranked regression</a>
  <ul class="collapse">
  <li><a href="#do-the-scaling-1" id="toc-do-the-scaling-1" class="nav-link" data-scroll-target="#do-the-scaling-1">Do the scaling</a>
  <ul class="collapse">
  <li><a href="#brief-diagnostics-of-the-hydro-model-replacement" id="toc-brief-diagnostics-of-the-hydro-model-replacement" class="nav-link" data-scroll-target="#brief-diagnostics-of-the-hydro-model-replacement">Brief diagnostics of the hydro-model replacement</a></li>
  <li><a href="#get-the-relationship" id="toc-get-the-relationship" class="nav-link" data-scroll-target="#get-the-relationship">Get the relationship</a></li>
  </ul></li>
  <li><a href="#outcome-distributions-1" id="toc-outcome-distributions-1" class="nav-link" data-scroll-target="#outcome-distributions-1">Outcome distributions</a>
  <ul class="collapse">
  <li><a href="#compare-baselines-1" id="toc-compare-baselines-1" class="nav-link" data-scroll-target="#compare-baselines-1">Compare baselines</a></li>
  <li><a href="#compare-scenario-shifts-1" id="toc-compare-scenario-shifts-1" class="nav-link" data-scroll-target="#compare-scenario-shifts-1">Compare scenario shifts</a></li>
  <li><a href="#zeros-1" id="toc-zeros-1" class="nav-link" data-scroll-target="#zeros-1">Zeros</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#parametric-distributions" id="toc-parametric-distributions" class="nav-link" data-scroll-target="#parametric-distributions">Parametric distributions</a>
  <ul class="collapse">
  <li><a href="#do-the-scaling-2" id="toc-do-the-scaling-2" class="nav-link" data-scroll-target="#do-the-scaling-2">Do the scaling</a>
  <ul class="collapse">
  <li><a href="#brief-diagnostics--how-are-the-fits" id="toc-brief-diagnostics--how-are-the-fits" class="nav-link" data-scroll-target="#brief-diagnostics--how-are-the-fits">Brief diagnostics- how are the fits?</a></li>
  <li><a href="#shift-the-distributions" id="toc-shift-the-distributions" class="nav-link" data-scroll-target="#shift-the-distributions">Shift the distributions</a></li>
  </ul></li>
  <li><a href="#outcome-distributions-2" id="toc-outcome-distributions-2" class="nav-link" data-scroll-target="#outcome-distributions-2">Outcome distributions</a>
  <ul class="collapse">
  <li><a href="#compare-baselines-2" id="toc-compare-baselines-2" class="nav-link" data-scroll-target="#compare-baselines-2">Compare baselines</a></li>
  <li><a href="#compare-scenario-shifts-2" id="toc-compare-scenario-shifts-2" class="nav-link" data-scroll-target="#compare-scenario-shifts-2">Compare scenario shifts</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#conclusions-1" id="toc-conclusions-1" class="nav-link" data-scroll-target="#conclusions-1">Conclusions</a></li>
  <li><a href="#further-approaches" id="toc-further-approaches" class="nav-link" data-scroll-target="#further-approaches">Further approaches</a></li>
  <li><a href="#q-q-regression" id="toc-q-q-regression" class="nav-link" data-scroll-target="#q-q-regression">Q-Q + regression</a>
  <ul class="collapse">
  <li><a href="#compare-scenarios" id="toc-compare-scenarios" class="nav-link" data-scroll-target="#compare-scenarios">Compare scenarios</a></li>
  <li><a href="#zeros-2" id="toc-zeros-2" class="nav-link" data-scroll-target="#zeros-2">Zeros</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">Flow scaling methods</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Galen Holt </p>
          </div>
  </div>
    
  
    
  </div>
  

</header>

<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-1_645e4c43deb3f561cb9851cfc899afad">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'dplyr'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:stats':

    filter, lag</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:base':

    intersect, setdiff, setequal, union</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tibble)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="goal-and-approaches" class="level1">
<h1>Goal and approaches</h1>
<p>We are working on flow scaling to capture the changes in David’s flow scenarios. I’ve gone through 3 (and a half) methods so far, and each has issues. I’ll go through that here and then we can discuss a way forward. The key thing we’re trying to do is shift historical hydrographs according to modelled runoff simulation scenarios. There are fundamentally two characteristics we need to target-</p>
<ol type="1">
<li>The <em>sequence</em> of flows should match the historical hydrograph, though their values may change</li>
<li>The <em>distribution</em> of flow values should have the same shape as the hydrograph, but shift to reflect changes in the runoff scenarios</li>
</ol>
<p>In each case, where appropriate, I’ve looked at how the transform affects the baseline data, as that is the best check of how the transforms themselves are working, and how they alter the properties of the sequence and distributions. And then I look at the differences among shifted hydrographs according to scenarios, to capture how the scenario shifts alter the distributions.</p>
<p>The main issues that arise are that the zeros (cease to flow) don’t change properly, and that two of the approaches (regression and parametric fits) yield distributions that look much different than the hydrograph distribution. The regression and parametric fits can change zeros, but this works better increasing zeros (decreasing runoff) than decreasing them- when runoff increases, everything that was zero becomes the same number.</p>
<p>I <em>think</em> the best approach will be a combination- see the end section Q-Q and regression, using q-q scaling for most of the hydrograph to get the distribution right, and a regression on the bottom 5% to change the zeros. And likely we should only look at the scenarios with reduced runoff to avoid the issue of making all zeros some positive number. The other solution there would be getting into the weeds with autoregressive sequences.</p>
<p>I’ve chosen a gauge with a reasonably long record (410016) in SS20, and saved its hydrograph and the SS20 scenarios into an Rdata file to avoid read-in and selection issues in this notebook. This notebook should run, though not if you don’t have the werptoolkitr package installed (depends on a single function).</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-2_23f16c2a168969c6b7ff92741f65b0d1">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="fu">file.path</span>(<span class="st">'scenario_creation'</span>, <span class="st">'test_scaling.rdata'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Some minor data cleanup</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-3_0ad1395abf21898f92cde2fc5b817b31">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>test_model <span class="ot">&lt;-</span> test_model <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">time =</span> lubridate<span class="sc">::</span><span class="fu">make_date</span>(Year, Month, Day))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-4_42e527b0147bebd1f7ee1e642e610157">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>qc_limit <span class="ot">&lt;-</span> <span class="dv">150</span> </span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>test_hydro <span class="ot">&lt;-</span> test_hydro <span class="sc">%&gt;%</span> </span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">hyd_vals =</span> <span class="fu">ifelse</span>(quality_codes_id <span class="sc">&gt;</span> qc_limit, <span class="cn">NA</span>, value))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="q-q-scaling" class="level1">
<h1>Q-Q scaling</h1>
<p>The first option is q-q scaling, which was the original plan.</p>
<p>The issue with it is that the zeros never change- 0s in the hydrographs will remain 0, so we can never increase flow from 0, and the model never has zeros, so we can never increase the number of zeros.</p>
<section id="do-the-scaling" class="level2">
<h2 class="anchored" data-anchor-id="do-the-scaling">Do the scaling</h2>
<p>This was set up to <code>purrr::map</code> over all the sdl units and gauges, so has some functions that we can just bring over here, but are overkill for single gauge and sdl unit.</p>
<p>First, some quantile-finding functions</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-5_3548090dd6d637cefa331117ed976e61">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># identify quantiles</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>get_q <span class="ot">&lt;-</span> <span class="cf">function</span>(vals, q_perc) {</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  qs <span class="ot">&lt;-</span> <span class="fu">quantile</span>(vals, <span class="at">probs =</span> <span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">1</span>, q_perc), <span class="at">type =</span> <span class="dv">5</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  binvec <span class="ot">&lt;-</span> <span class="fu">findInterval</span>(vals, qs, <span class="at">rightmost.closed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(binvec)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="co"># get the mean of a quantile</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>get_qmean <span class="ot">&lt;-</span> <span class="cf">function</span>(vals, <span class="at">q_perc =</span> <span class="fl">0.02</span>) {</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  binvec <span class="ot">&lt;-</span> <span class="fu">get_q</span>(vals, q_perc)</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>  qmean <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(<span class="at">x =</span> vals, <span class="at">by =</span> <span class="fu">list</span>(binvec), <span class="at">FUN =</span> mean) <span class="sc">%&gt;%</span> </span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">setNames</span>(<span class="fu">c</span>(<span class="st">'quantile'</span>, <span class="st">'mean'</span>))</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>} </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then a set of functions to scale the models. This groups by month, though that could be changed.</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-6_1e4721299649dcb6dbf2f709e293d3de">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get the scalings from a dataframe of scenarios</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>get_scalings <span class="ot">&lt;-</span> <span class="cf">function</span>(unitdf) {</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Stack</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  stackdf <span class="ot">&lt;-</span> unitdf <span class="sc">%&gt;%</span> </span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sdl =</span> stringr<span class="sc">::</span><span class="fu">str_extract</span>(path, <span class="st">"SS[0-9]+"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sdl, Year, Month, Day, <span class="fu">starts_with</span>(<span class="st">'Sim'</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">'Sim'</span>), </span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">'scenario'</span>, <span class="at">values_to =</span> <span class="st">'runoff'</span>)</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Quantile means</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>  q_s <span class="ot">&lt;-</span> stackdf <span class="sc">%&gt;%</span> </span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(scenario, Month) <span class="sc">%&gt;%</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(<span class="at">qmean =</span> <span class="fu">get_qmean</span>(runoff)) <span class="sc">%&gt;%</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># reframe is the new way, but needs dplyr 1.1 which breaks lots of the functions</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a> <span class="co"># reframe(qmean = get_qmean(runoff)) %&gt;%</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">unnest</span>(<span class="at">cols =</span> qmean)</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get the relative change</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>  q_s <span class="ot">&lt;-</span> q_s <span class="sc">%&gt;%</span> </span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(scenario, Month) <span class="sc">%&gt;%</span> </span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>  werptoolkitr<span class="sc">::</span><span class="fu">baseline_compare</span>(<span class="at">compare_col =</span> <span class="st">'scenario'</span>, <span class="at">base_lev =</span> <span class="st">'SimR0'</span>, </span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>                   <span class="at">values_col =</span> <span class="st">'mean'</span>, </span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>                   <span class="at">comp_fun =</span> <span class="st">`</span><span class="at">/</span><span class="st">`</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="at">scenario =</span> scenario.x, <span class="fu">everything</span>(), </span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>         <span class="at">relative_change =</span> <span class="st">`</span><span class="at">/_mean</span><span class="st">`</span>, </span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>         <span class="sc">-</span>scenario.y)</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And we scale the scenarios</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-7_b98f9d8824e008d5df7db172ed3ce6ea">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>qq_model <span class="ot">&lt;-</span> <span class="fu">get_scalings</span>(test_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'scenario', 'Month'. You can override using
the `.groups` argument.
Adding missing grouping variables: `scenario`</code></pre>
</div>
</div>
<p>Now we write a function to scale the gauge- this finds quantiles and applies the scalings from qq_model. This was again designed to <code>map</code> over all gauges in all sdl units, so is overkill here. I’ve cleaned out some of that, but didn’t want to spend too much time cleaning up the simple case.</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-8_f5561b821b91e83ff6d34f3653021dd6">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>scale_gauges <span class="ot">&lt;-</span> <span class="cf">function</span>(gaugedata, scaled_model, <span class="at">qc_limit =</span> <span class="dv">150</span>) {</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Set bad data to NA</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  gaugedata[gaugedata<span class="sc">$</span>quality_codes_id <span class="sc">&gt;</span> qc_limit, <span class="st">'value'</span>] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># make an NA quantile for each scenario so the join works properly</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">any</span>(<span class="fu">is.na</span>(gaugedata<span class="sc">$</span>value))) {</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    nafill <span class="ot">&lt;-</span> scaled_model <span class="sc">%&gt;%</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">distinct</span>(scenario, Month) <span class="sc">%&gt;%</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">quantile =</span> <span class="cn">NA</span>, <span class="at">mean =</span> <span class="cn">NA</span>, <span class="at">ref_mean =</span> <span class="cn">NA</span>, <span class="at">relative_change =</span> <span class="cn">NA</span>)</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    scaled_model <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(scaled_model, nafill)</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># do the transforms</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>  gaugedata <span class="ot">&lt;-</span> gaugedata <span class="sc">%&gt;%</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># get the time units right</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Month =</span> lubridate<span class="sc">::</span><span class="fu">month</span>(time)) <span class="sc">%&gt;%</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">Date =</span> time) <span class="sc">%&gt;%</span>  <span class="co"># To match other inputs</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(Month) <span class="sc">%&gt;%</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># get quantiles- make a dummy so NA quantiles exist and get join-crossed with scenarios</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">quantile =</span> <span class="fu">get_q</span>(value, <span class="at">q_perc =</span> <span class="fl">0.02</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># join to scalings</span></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(scaled_model,</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>              <span class="at">by =</span> <span class="fu">c</span>(<span class="st">'Month'</span>, <span class="st">'quantile'</span>),</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>              <span class="at">multiple =</span> <span class="st">'all'</span>) <span class="sc">%&gt;%</span> <span class="co"># Says it's OK to duplicate rows x scenarios</span></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># get the adjusted levels</span></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">adj_val =</span> value<span class="sc">*</span>relative_change) <span class="sc">%&gt;%</span></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Just the needed cols</span></span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(scenario, site, Date, adj_val) <span class="sc">%&gt;%</span></span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># pivot so the gauge name is col name</span></span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_wider</span>(<span class="at">names_from =</span> site, <span class="at">values_from =</span> adj_val) <span class="sc">%&gt;%</span></span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># collapse to a list-tibble with one row per scenario</span></span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">nest</span>(<span class="at">sc =</span> scenario) <span class="sc">%&gt;%</span> </span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">unnest</span>(<span class="at">cols =</span> sc)</span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(gaugedata)</span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we scale the gauge data</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-9_56984b1ecf81e02a06646653c8d61a26">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>qq_hydro <span class="ot">&lt;-</span> <span class="fu">scale_gauges</span>(test_hydro, <span class="at">scaled_model =</span> qq_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>That was meant to have gauge-name-cols, but here we just have one so change the name to syntactic</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-10_4f3c458f60dd14b0f280733f0c3ea44d">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(qq_hydro)[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="st">'value'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="outcome-distributions" class="level2">
<h2 class="anchored" data-anchor-id="outcome-distributions">Outcome distributions</h2>
<section id="compare-baselines" class="level3">
<h3 class="anchored" data-anchor-id="compare-baselines">Compare baselines</h3>
<p>Since we don’t actually <em>shift</em> anything at baseline here, unlike the other methods, this is just looking at the input data.</p>
<p>Sequences. The time period differs, and that’s fine.</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-11_4af142c5b440e5afb38c61d0e53216c9">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>hyd_base <span class="ot">&lt;-</span> qq_hydro <span class="sc">%&gt;%</span> </span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(scenario <span class="sc">==</span> <span class="st">'SimR0'</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Date, <span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>()</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>mod_base <span class="ot">&lt;-</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(test_model, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> SimR0)) <span class="sc">+</span> </span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>()</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>hyd_base <span class="sc">+</span> mod_base</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1 row containing missing values (`geom_line()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="flow_scaling_methods_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>CDFs- comparing to the model data, not the qq-scaled model, which is just used to transform. Top is on the raw scale, bottom is logged. This will be more relevant later, but it sets the stage of how the baseline distributions work.</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-12_07354bd817eeaa08068e8e13fd5dd333">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>hyd_cdf <span class="ot">&lt;-</span> qq_hydro <span class="sc">%&gt;%</span> </span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(scenario <span class="sc">==</span> <span class="st">'SimR0'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value)) <span class="sc">+</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ecdf</span>()</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>mod_cdf <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(test_model, <span class="fu">aes</span>(<span class="at">x =</span> SimR0)) <span class="sc">+</span> </span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ecdf</span>()</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>hyd_cdf_ln <span class="ot">&lt;-</span> qq_hydro <span class="sc">%&gt;%</span> </span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(scenario <span class="sc">==</span> <span class="st">'SimR0'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(value))) <span class="sc">+</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ecdf</span>()</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>mod_cdf_ln <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(test_model, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(SimR0))) <span class="sc">+</span> </span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ecdf</span>()</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>(hyd_cdf <span class="sc">+</span> mod_cdf) <span class="sc">/</span> (hyd_cdf_ln <span class="sc">+</span> mod_cdf_ln)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1564 rows containing non-finite values (`stat_ecdf()`).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 4384 rows containing non-finite values (`stat_ecdf()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="flow_scaling_methods_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>PDFs</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-13_3c4b985067e7df502f4c611d83ef5bba">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>hyd_pdf <span class="ot">&lt;-</span> qq_hydro <span class="sc">%&gt;%</span> </span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(scenario <span class="sc">==</span> <span class="st">'SimR0'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value)) <span class="sc">+</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>()</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>mod_pdf <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(test_model, <span class="fu">aes</span>(<span class="at">x =</span> SimR0)) <span class="sc">+</span> </span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>()</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>hyd_pdf_ln <span class="ot">&lt;-</span> qq_hydro <span class="sc">%&gt;%</span> </span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(scenario <span class="sc">==</span> <span class="st">'SimR0'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(value))) <span class="sc">+</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>()</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>mod_pdf_ln <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(test_model, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(SimR0))) <span class="sc">+</span> </span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>()</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>(hyd_pdf <span class="sc">+</span> mod_pdf) <span class="sc">/</span> (hyd_pdf_ln <span class="sc">+</span> mod_pdf_ln)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1564 rows containing non-finite values (`stat_density()`).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 4384 rows containing non-finite values (`stat_density()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="flow_scaling_methods_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="compare-scenario-shifts" class="level3">
<h3 class="anchored" data-anchor-id="compare-scenario-shifts">Compare scenario shifts</h3>
<p>Modelled timeseries- too hard to see with color, so facetting.</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-14_efffdb0e1cf2e5e45eda8b6f1d9ce9bb">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>mod_timeseries <span class="ot">&lt;-</span> test_model <span class="sc">%&gt;%</span> </span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">'Sim'</span>), <span class="at">names_to =</span> <span class="st">'scenario'</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> value)) <span class="sc">+</span> </span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> <span class="fu">facet_wrap</span>(<span class="st">'scenario'</span>)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>mod_timeseries</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="flow_scaling_methods_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Shifted hydrograph timeseries</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-15_f089bae563d3000948a65d59fb95f750">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>qq_timeseries <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(qq_hydro, <span class="fu">aes</span>(<span class="at">x =</span> Date, <span class="at">y =</span> value)) <span class="sc">+</span> </span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> <span class="fu">facet_wrap</span>(<span class="st">'scenario'</span>)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>qq_timeseries</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1 row containing missing values (`geom_line()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="flow_scaling_methods_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Distributions- again, linear on top, log on bottom, hydrographs on left, modelled runoff on right.</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-16_a7474e0929d51c53183420002b35bc78">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>hyd_cdf_qq <span class="ot">&lt;-</span> qq_hydro <span class="sc">%&gt;%</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">color =</span> scenario)) <span class="sc">+</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ecdf</span>()</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>mod_cdf_qq <span class="ot">&lt;-</span> test_model <span class="sc">%&gt;%</span> </span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">'Sim'</span>), <span class="at">names_to =</span> <span class="st">'scenario'</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">color =</span> scenario)) <span class="sc">+</span> </span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ecdf</span>()</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>hyd_cdf_qq_ln <span class="ot">&lt;-</span> qq_hydro <span class="sc">%&gt;%</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(value), <span class="at">color =</span> scenario)) <span class="sc">+</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ecdf</span>()</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>mod_cdf_qq_ln <span class="ot">&lt;-</span> test_model <span class="sc">%&gt;%</span> </span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">'Sim'</span>), <span class="at">names_to =</span> <span class="st">'scenario'</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(value), <span class="at">color =</span> scenario)) <span class="sc">+</span> </span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ecdf</span>()</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>(hyd_cdf_qq <span class="sc">+</span> mod_cdf_qq) <span class="sc">/</span> (hyd_cdf_qq_ln <span class="sc">+</span> mod_cdf_qq_ln)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 12512 rows containing non-finite values (`stat_ecdf()`).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 35072 rows containing non-finite values (`stat_ecdf()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="flow_scaling_methods_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>PDFs</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-17_998c0aea02a72a2207388ca2cea9b888">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>hyd_pdf_qq <span class="ot">&lt;-</span> qq_hydro <span class="sc">%&gt;%</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">color =</span> scenario)) <span class="sc">+</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>()</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>mod_pdf_qq <span class="ot">&lt;-</span> test_model <span class="sc">%&gt;%</span> </span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">'Sim'</span>), <span class="at">names_to =</span> <span class="st">'scenario'</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">color =</span> scenario)) <span class="sc">+</span> </span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>()</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>hyd_pdf_qq_ln <span class="ot">&lt;-</span> qq_hydro <span class="sc">%&gt;%</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(value), <span class="at">color =</span> scenario)) <span class="sc">+</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>()</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>mod_pdf_qq_ln <span class="ot">&lt;-</span> test_model <span class="sc">%&gt;%</span> </span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">'Sim'</span>), <span class="at">names_to =</span> <span class="st">'scenario'</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(value), <span class="at">color =</span> scenario)) <span class="sc">+</span> </span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>()</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>(hyd_pdf_qq <span class="sc">+</span> mod_pdf_qq) <span class="sc">/</span> (hyd_pdf_qq_ln <span class="sc">+</span> mod_pdf_qq_ln)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 12512 rows containing non-finite values (`stat_density()`).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 35072 rows containing non-finite values (`stat_density()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="flow_scaling_methods_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="zeros" class="level3">
<h3 class="anchored" data-anchor-id="zeros">Zeros</h3>
<p>The number of zeros doesn’t change.</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-18_adb0c4e4c6f9b81e3d93432b422a49ad">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>qq_hydro <span class="sc">%&gt;%</span> </span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(scenario) <span class="sc">%&gt;%</span> </span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">n_zeros =</span> <span class="fu">sum</span>(value <span class="sc">==</span> <span class="dv">0</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 8 × 2
  scenario n_zeros
  &lt;chr&gt;      &lt;int&gt;
1 SimR0       2820
2 SimR1       2820
3 SimR2       2820
4 SimR3       2820
5 SimR4       2820
6 SimR5       2820
7 SimR6       2820
8 SimR7       2820</code></pre>
</div>
</div>
<p>What if we ask about lowering flows? Can we put on a threshold and increase zeros? The minimum detected is 0.001</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-19_378bd9d2c1be01643170a1082b065946">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>qq_hydro <span class="sc">%&gt;%</span> <span class="fu">filter</span>(scenario <span class="sc">==</span> <span class="st">'SimR0'</span> <span class="sc">&amp;</span> value <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">minpos =</span> <span class="fu">min</span>(value, <span class="at">na.rm =</span> <span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 1
  minpos
   &lt;dbl&gt;
1  0.001</code></pre>
</div>
</div>
<p>That gives a few but not many more zeros in the lower runoff scenarios. Still, we wouldn’t pick anything useful up there.</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-20_62ed0994e45b8a11fe94fc60f7495d12">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>qq_hydro <span class="sc">%&gt;%</span> </span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(scenario) <span class="sc">%&gt;%</span> </span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">n_pseudo_zeros =</span> <span class="fu">sum</span>(value <span class="sc">&lt;</span> <span class="fl">0.001</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 8 × 2
  scenario n_pseudo_zeros
  &lt;chr&gt;             &lt;int&gt;
1 SimR0              2820
2 SimR1              2826
3 SimR2              2826
4 SimR3              2826
5 SimR4              2826
6 SimR5              2826
7 SimR6              2820
8 SimR7              2820</code></pre>
</div>
</div>
<p>If we used a higher threshold (I’d be surprised if 0.001 is a real measurement). A bit of shifting happening here. Still pretty low proportionally, but at least we would get a bit of variation.</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-21_9e1722e5dccee0abe6a9677cdd2ff2c3">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>qq_hydro <span class="sc">%&gt;%</span> </span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(scenario) <span class="sc">%&gt;%</span> </span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">n_pseudo_zeros =</span> <span class="fu">sum</span>(value <span class="sc">&lt;</span> <span class="dv">1</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 8 × 2
  scenario n_pseudo_zeros
  &lt;chr&gt;             &lt;int&gt;
1 SimR0              2854
2 SimR1              2868
3 SimR2              2866
4 SimR3              2861
5 SimR4              2856
6 SimR5              2854
7 SimR6              2854
8 SimR7              2853</code></pre>
</div>
</div>
</section>
</section>
<section id="conclusions" class="level2">
<h2 class="anchored" data-anchor-id="conclusions">Conclusions</h2>
<p>The qq scaling does a good job creating distributions that look like hydrograph distributions, complete with funny lumps. And their shape does change, but in a similar way to the shapes of the modelled runoff distributions.</p>
<p>The catch is that the number of zeros is constant, and so any cease to flow conditions cannot change.</p>
</section>
</section>
<section id="ranked-regression" class="level1">
<h1>Ranked regression</h1>
<p>This was David’s email- we replace the sequence of hydrographs with their same-ranked model values, and then translate back to hydrographs with a hydro ~ model regression.</p>
<p>The issue here is that the model and hydrograph distributions are nowhere near linearly related on the linear or log scale, and so the resulting hydrograph distribution is squashed compared to a real one.</p>
<p>It <em>does</em> change the zeros. But it doesn’t know <em>which</em> zeros to change, so it changes all of them- e.g.&nbsp;<strong>We end up with a big probability mass at whatever number the zeros all change to, and may lose all zeros</strong>. <em>This will remain an issue even if we fix the horrible fits</em>.</p>
<section id="do-the-scaling-1" class="level2">
<h2 class="anchored" data-anchor-id="do-the-scaling-1">Do the scaling</h2>
<p>We want to rank-match, but the data is different size and there are duplicate values. So to deal with that, I wrote a slightly different quantile function that divides the <em>uniqu</em>e values into quantiles instead of all values, generating ranks, and then assigns all values to the appropriate rank to handle duplicated values. And to deal with the different-sized data, we calculate the number of quantiles from the length of the shortest dataset (hydrograph or model), so the ranks may not be exactly one value per rank.</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-22_a1f7d4d932402f107d9de3af657d9da2">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>get_q_unique <span class="ot">&lt;-</span> <span class="cf">function</span>(vals, q_perc) {</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  qs <span class="ot">&lt;-</span> <span class="fu">quantile</span>(<span class="fu">unique</span>(vals), <span class="at">probs =</span> <span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">1</span>, q_perc), <span class="at">type =</span> <span class="dv">5</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  binvec <span class="ot">&lt;-</span> <span class="fu">findInterval</span>(vals, qs, <span class="at">rightmost.closed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(binvec)</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, get the ranks. We use the function above, and for duplicated values within a rank for the model, we return the median, which is what we will use to replace the hydrograph. There are different numbers of unique values in the different scenarios, so use the minimum. We could do this separately for all the scenarios, but it becomes horrible to track the various ranks.</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-23_03ecef7a80c6667bb6afcc372f9315d8">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the number of 'ranks' (bins) as the shortest set of values</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>uniquemodel <span class="ot">&lt;-</span> test_model <span class="sc">%&gt;%</span> </span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">'Sim'</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(name) <span class="sc">%&gt;%</span> </span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">nunique =</span> <span class="fu">n_distinct</span>(value))</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>fewest <span class="ot">&lt;-</span> <span class="fu">min</span>(<span class="fu">length</span>(<span class="fu">unique</span>(test_hydro<span class="sc">$</span>hyd_vals)),</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>              <span class="fu">min</span>(uniquemodel<span class="sc">$</span>nunique))</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Rank the hydrograph</span></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>test_hydro <span class="ot">&lt;-</span> test_hydro <span class="sc">%&gt;%</span></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ranks =</span> <span class="fu">get_q_unique</span>(hyd_vals, <span class="dv">1</span><span class="sc">/</span>fewest))</span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>model_rankvals <span class="ot">&lt;-</span> test_model <span class="sc">%&gt;%</span></span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">'Sim'</span>), <span class="at">names_to =</span> <span class="st">'scenario'</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(scenario) <span class="sc">%&gt;%</span> </span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ranks =</span> <span class="fu">get_q_unique</span>(value, <span class="dv">1</span><span class="sc">/</span>fewest)) <span class="sc">%&gt;%</span> </span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(scenario, ranks) <span class="sc">%&gt;%</span></span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mod_vals =</span> <span class="fu">median</span>(value))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'scenario'. You can override using the
`.groups` argument.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># replace (really, add another column)</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>rank_hydro <span class="ot">&lt;-</span> <span class="fu">left_join</span>(test_hydro, model_rankvals, <span class="at">by =</span> <span class="st">'ranks'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="brief-diagnostics-of-the-hydro-model-replacement" class="level3">
<h3 class="anchored" data-anchor-id="brief-diagnostics-of-the-hydro-model-replacement">Brief diagnostics of the hydro-model replacement</h3>
<p>The values of the ranks follow quite clearly different distributions, even when rescaled.</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-24_3157d584306c21af30020eedef498ce4">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>rank_hydro <span class="sc">%&gt;%</span> </span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(scenario <span class="sc">==</span> <span class="st">'SimR0'</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> ranks)) <span class="sc">+</span> <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> hyd_vals), <span class="at">color =</span> <span class="st">'forestgreen'</span>) <span class="sc">+</span> <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> mod_vals<span class="sc">*</span><span class="dv">500</span>), <span class="at">color =</span> <span class="st">'dodgerblue'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="flow_scaling_methods_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>That relationship is clearly nonlinear on both the linear and log-log scales. I’ve thrown the linear fit on here, but it’s clearly a bit silly.</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-25_8894ffde6b49ce760d0a8bfc71070278">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>linrr <span class="ot">&lt;-</span> rank_hydro <span class="sc">%&gt;%</span> </span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(scenario <span class="sc">==</span> <span class="st">'SimR0'</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> mod_vals, <span class="at">y =</span> hyd_vals)) <span class="sc">+</span> </span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>()</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>bump0 <span class="ot">&lt;-</span> rank_hydro <span class="sc">%&gt;%</span> </span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(scenario <span class="sc">==</span> <span class="st">'SimR0'</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(mod_vals <span class="sc">+</span> <span class="fl">0.01</span>), <span class="at">y =</span> <span class="fu">log</span>(hyd_vals <span class="sc">+</span> <span class="fl">0.01</span>))) <span class="sc">+</span> </span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">'lm'</span>)</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>drop0 <span class="ot">&lt;-</span> rank_hydro <span class="sc">%&gt;%</span> </span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(scenario <span class="sc">==</span> <span class="st">'SimR0'</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(mod_vals), <span class="at">y =</span> <span class="fu">log</span>(hyd_vals))) <span class="sc">+</span> </span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">'lm'</span>)</span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>linrr <span class="sc">+</span> bump0 <span class="sc">+</span> drop0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using formula = 'y ~ x'
`geom_smooth()` using formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 2820 rows containing non-finite values (`stat_smooth()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="flow_scaling_methods_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="get-the-relationship" class="level3">
<h3 class="anchored" data-anchor-id="get-the-relationship">Get the relationship</h3>
<p>Let’s ignore how terrible that fit is, do the translation, and then look at what we get.</p>
<p>I’m going to build the regression relationship for log-log with 0s thrown out, rather than piling them all up at 0.01 or something arbitrary.</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-26_4562598fbf89bcdf7aeb87a05fcd6953">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>rank_log <span class="ot">&lt;-</span> rank_hydro <span class="sc">%&gt;%</span> </span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(scenario <span class="sc">==</span> <span class="st">'SimR0'</span>) <span class="sc">%&gt;%</span>  </span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(hyd_vals <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">log_hyd =</span> <span class="fu">log</span>(hyd_vals),</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">log_mod =</span> <span class="fu">log</span>(mod_vals))</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>logregression <span class="ot">&lt;-</span> <span class="fu">lm</span>(log_hyd <span class="sc">~</span> log_mod, <span class="at">data =</span> rank_log)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Apply that to regain hydrograph values from the scenario values</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-27_a42f39bc868383efeac5a7aea139e1ec">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>rank_hydro_shift <span class="ot">&lt;-</span> rank_hydro <span class="sc">%&gt;%</span> </span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">log_mod =</span> <span class="fu">log</span>(mod_vals),</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">log_hyd =</span> <span class="fu">log</span>(hyd_vals)) <span class="sc">%&gt;%</span> </span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>  modelr<span class="sc">::</span><span class="fu">add_predictions</span>(logregression, <span class="st">'pred_log_hyd'</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pred_hyd =</span> <span class="fu">exp</span>(pred_log_hyd))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In theory, we’d have to decide now where to put the zero point, since <code>pred_hyd</code> here will get very small but never zero, since it’s predicted on the log scale. An obvious choice would be anything below the minumum in the original data <code>min(rank_hydro_shift$hyd_vals[rank_hydro_shift$hyd_vals &gt; 0], na.rm = TRUE)</code>. That number is 0.001, though that seems to be an artifact of something, and 1 is probably reasonable. But the predictions never get close- the minimum predicted value is</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-28_6ce61a71f2ed020470c31e2e4bbd892d">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">min</span>(rank_hydro_shift<span class="sc">$</span>pred_hyd, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 22.34629</code></pre>
</div>
</div>
<p>which is unsurprising, from looking at those linear fits above. But it means we never predict zeros.</p>
</section>
</section>
<section id="outcome-distributions-1" class="level2">
<h2 class="anchored" data-anchor-id="outcome-distributions-1">Outcome distributions</h2>
<section id="compare-baselines-1" class="level3">
<h3 class="anchored" data-anchor-id="compare-baselines-1">Compare baselines</h3>
<p>We’ve compared the hydrograph to the baseline model data above, but here I want to look at hydrograph data to generated ‘hydrograph data’ out of the transform with SimR0.</p>
<p>Timeseries. The massive overestimates are really blowing things up here.</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-29_f115e27fecd85ebcaba5871403d9ae75">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>orig_time <span class="ot">&lt;-</span> rank_hydro_shift <span class="sc">%&gt;%</span> </span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(scenario <span class="sc">==</span> <span class="st">'SimR0'</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> hyd_vals)) <span class="sc">+</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">'forestgreen'</span>) </span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>pred_time <span class="ot">&lt;-</span> rank_hydro_shift <span class="sc">%&gt;%</span> </span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(scenario <span class="sc">==</span> <span class="st">'SimR0'</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> pred_hyd)) <span class="sc">+</span></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">'dodgerblue'</span>) </span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>orig_time <span class="sc">+</span> pred_time</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="flow_scaling_methods_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>CDFs of the original data to the regression-predicted. Top is on the raw scale, bottom is logged.</p>
<p>Note the big probability mass at the bottom- this is because all the zeros have the same rank, and so get the same predicted value. This will occur no matter what- even if we find a better regression. This mass is not htere in the data because the zeros are just dropped. If we had data + 0.01, it’d show up.</p>
<p>Note the massive difference in x-axes here</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-30_24e9fea69096bca9fc8ba518fdb5c21a">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>hyd_cdf <span class="ot">&lt;-</span> rank_hydro_shift <span class="sc">%&gt;%</span> </span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(scenario <span class="sc">==</span> <span class="st">'SimR0'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> hyd_vals)) <span class="sc">+</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ecdf</span>()</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>reg_cdf <span class="ot">&lt;-</span> rank_hydro_shift <span class="sc">%&gt;%</span> </span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(scenario <span class="sc">==</span> <span class="st">'SimR0'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> pred_hyd)) <span class="sc">+</span></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ecdf</span>()</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>hyd_cdf_ln <span class="ot">&lt;-</span> rank_hydro_shift <span class="sc">%&gt;%</span> </span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(scenario <span class="sc">==</span> <span class="st">'SimR0'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(hyd_vals))) <span class="sc">+</span></span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ecdf</span>()</span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>reg_cdf_ln <span class="ot">&lt;-</span> rank_hydro_shift <span class="sc">%&gt;%</span> </span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(scenario <span class="sc">==</span> <span class="st">'SimR0'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(pred_hyd))) <span class="sc">+</span></span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ecdf</span>()</span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a>(hyd_cdf <span class="sc">+</span> reg_cdf) <span class="sc">/</span> (hyd_cdf_ln <span class="sc">+</span> reg_cdf_ln)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 2820 rows containing non-finite values (`stat_ecdf()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="flow_scaling_methods_files/figure-html/unnamed-chunk-30-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>PDFs. Note the massive difference in x-axes here too, so I’ve made a version explicitly comparing them.</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-31_067cec43b2ee813a1f225f2cbdb428eb">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>hyd_pdf <span class="ot">&lt;-</span> rank_hydro_shift <span class="sc">%&gt;%</span> </span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(scenario <span class="sc">==</span> <span class="st">'SimR0'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> hyd_vals)) <span class="sc">+</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>()</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>reg_pdf <span class="ot">&lt;-</span> rank_hydro_shift <span class="sc">%&gt;%</span> </span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(scenario <span class="sc">==</span> <span class="st">'SimR0'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> pred_hyd)) <span class="sc">+</span></span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>()</span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>hyd_pdf_ln <span class="ot">&lt;-</span> rank_hydro_shift <span class="sc">%&gt;%</span> </span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(scenario <span class="sc">==</span> <span class="st">'SimR0'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(hyd_vals))) <span class="sc">+</span></span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>()</span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>reg_pdf_ln <span class="ot">&lt;-</span> rank_hydro_shift <span class="sc">%&gt;%</span> </span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(scenario <span class="sc">==</span> <span class="st">'SimR0'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(pred_hyd))) <span class="sc">+</span></span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>()</span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a>hyd_reg_comp <span class="ot">&lt;-</span> rank_hydro_shift <span class="sc">%&gt;%</span> </span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(scenario <span class="sc">==</span> <span class="st">'SimR0'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb56-23"><a href="#cb56-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb56-24"><a href="#cb56-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(hyd_vals)), <span class="at">color =</span> <span class="st">'forestgreen'</span>) <span class="sc">+</span></span>
<span id="cb56-25"><a href="#cb56-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(pred_hyd)), <span class="at">color =</span> <span class="st">'dodgerblue'</span>) <span class="sc">+</span></span>
<span id="cb56-26"><a href="#cb56-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">10</span>))</span>
<span id="cb56-27"><a href="#cb56-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-28"><a href="#cb56-28" aria-hidden="true" tabindex="-1"></a>(hyd_pdf <span class="sc">+</span> reg_pdf) <span class="sc">/</span> (hyd_pdf_ln <span class="sc">+</span> reg_pdf_ln) <span class="sc">/</span></span>
<span id="cb56-29"><a href="#cb56-29" aria-hidden="true" tabindex="-1"></a>  (hyd_reg_comp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 2820 rows containing non-finite values (`stat_density()`).
Removed 2820 rows containing non-finite values (`stat_density()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="flow_scaling_methods_files/figure-html/unnamed-chunk-31-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="compare-scenario-shifts-1" class="level3">
<h3 class="anchored" data-anchor-id="compare-scenario-shifts-1">Compare scenario shifts</h3>
<p>These contain the same lines as above, but I think it’s valuable to isolate the baseline transform before looking at the scenario shifts. These are the distributions of the ‘hydrographs’ that reflect the scenarios. I’ve included an x-limited panel on the linear scale since the values reach such absurd levels.</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-32_5302248a8249320b8fb062774ba63927">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>reg_cdf_all <span class="ot">&lt;-</span> rank_hydro_shift <span class="sc">%&gt;%</span> </span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> pred_hyd, <span class="at">color =</span> scenario)) <span class="sc">+</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ecdf</span>()</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>reg_cdf_ln_all <span class="ot">&lt;-</span> rank_hydro_shift <span class="sc">%&gt;%</span> </span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(pred_hyd), <span class="at">color =</span> scenario)) <span class="sc">+</span></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ecdf</span>()</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>(reg_cdf_all <span class="sc">+</span> reg_cdf_all <span class="sc">+</span> <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">5000</span>))) <span class="sc">/</span> reg_cdf_ln_all</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1564 rows containing non-finite values (`stat_ecdf()`).
Removed 1564 rows containing non-finite values (`stat_ecdf()`).
Removed 1564 rows containing non-finite values (`stat_ecdf()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="flow_scaling_methods_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>PDFs. Again, added an x-limited version to see what’s happening low. It’s clear the linear fits are causing major issues at both the bottom and the top of the distribution.</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-33_0f45b7d810314c186198b1166648112a">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>reg_pdf_all <span class="ot">&lt;-</span> rank_hydro_shift <span class="sc">%&gt;%</span> </span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> pred_hyd, <span class="at">color =</span> scenario)) <span class="sc">+</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>()</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>reg_pdf_ln_all <span class="ot">&lt;-</span> rank_hydro_shift <span class="sc">%&gt;%</span> </span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(pred_hyd), <span class="at">color =</span> scenario)) <span class="sc">+</span></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>()</span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>(reg_pdf_all <span class="sc">+</span> reg_pdf_all <span class="sc">+</span> <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">5000</span>))) <span class="sc">/</span> reg_pdf_ln_all</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1564 rows containing non-finite values (`stat_density()`).
Removed 1564 rows containing non-finite values (`stat_density()`).
Removed 1564 rows containing non-finite values (`stat_density()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="flow_scaling_methods_files/figure-html/unnamed-chunk-33-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="zeros-1" class="level3">
<h3 class="anchored" data-anchor-id="zeros-1">Zeros</h3>
<p>There are no zeros in the data.</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-34_5f6b0ae9cd45d335ca8aae6a93721b96">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>rank_hydro_shift <span class="sc">%&gt;%</span> </span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(scenario) <span class="sc">%&gt;%</span> </span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">n_zeros =</span> <span class="fu">sum</span>(pred_hyd <span class="sc">==</span> <span class="dv">0</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 2
  scenario n_zeros
  &lt;chr&gt;      &lt;int&gt;
1 SimR0          0
2 SimR1          0
3 SimR2          0
4 SimR3          0
5 SimR4          0
6 SimR5          0
7 SimR6          0
8 SimR7          0
9 &lt;NA&gt;           0</code></pre>
</div>
</div>
<p>The <em>number</em> of zeros is essentially arbitrary though, dependent on the zero point and the regression. So, for example if we make the zero point 25, the number changes.</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-35_71a85f3f99b693ae912dba04411a6acc">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>rank_hydro_shift <span class="sc">%&gt;%</span> </span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(scenario) <span class="sc">%&gt;%</span> </span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">n_zeros =</span> <span class="fu">sum</span>(pred_hyd <span class="sc">&lt;=</span> <span class="dv">25</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 2
  scenario n_zeros
  &lt;chr&gt;      &lt;int&gt;
1 SimR0          0
2 SimR1       2920
3 SimR2       2845
4 SimR3          0
5 SimR4          0
6 SimR5          0
7 SimR6          0
8 SimR7          0
9 &lt;NA&gt;           0</code></pre>
</div>
</div>
<p>The problem is that it’s never continuous- all the zeros always get the same value, that value just changes.</p>
<p>So, we can add zeros if we use scenarios where the <code>new_zero_val</code> here is below the one for SimR0, but it doesn’t make sense to add water to those where it’s higher. That is only two scenarios though, so maybe that’s the way to go.</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-36_ee027e860c05e3913d05a96f1d332c3e">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>rank_hydro_shift <span class="sc">%&gt;%</span> </span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(hyd_vals <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(scenario) <span class="sc">%&gt;%</span> </span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">new_zero_val =</span> <span class="fu">unique</span>(pred_hyd))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 8 × 2
  scenario new_zero_val
  &lt;chr&gt;           &lt;dbl&gt;
1 SimR0            28.4
2 SimR1            22.3
3 SimR2            23.9
4 SimR3            25.4
5 SimR4            26.4
6 SimR5            27.5
7 SimR6            28.6
8 SimR7            29.7</code></pre>
</div>
</div>
<p>Let’s say we were to make the SimR0 value the zero value. How much variation in the number of zeros would we get? 450-ish from top to bottom.</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-37_c711c83af441ff672672bdc1eddfd6b8">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>rank_hydro_shift <span class="sc">%&gt;%</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(scenario) <span class="sc">%&gt;%</span> </span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">n_pseudo_zeros =</span> <span class="fu">sum</span>(pred_hyd <span class="sc">&lt;</span> <span class="fl">28.44</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 2
  scenario n_pseudo_zeros
  &lt;chr&gt;             &lt;int&gt;
1 SimR0              2820
2 SimR1              3268
3 SimR2              2994
4 SimR3              2873
5 SimR4              2853
6 SimR5              2834
7 SimR6                 0
8 SimR7                 0
9 &lt;NA&gt;                  0</code></pre>
</div>
</div>
</section>
</section>
</section>
<section id="parametric-distributions" class="level1">
<h1>Parametric distributions</h1>
<p>If we fit lognormal distributions to both sets of data, we can then shift the hydrograph lognormal in the same way as the changes in the runoff scenarios, and then map the hydrograph values to their distributional values to regenerate hydrographs.</p>
<p>This works, sort of, but it has a similar issue to the regression with the zeros all becoming the same number because they all get the new distribution at that point. It will create more zeros, though.</p>
<p>The fits are also pretty terrible- the hydrograph is just not normal on the log scale. They’re better than the linear version, but we still have the zero-shiftup issue.</p>
<p>I’ve done this with lognormal distributions directly. I could have logged the data and then used normals, which would yield some small changes on the margins around truncating distributions rather than optimising a shift. That might be better, but I’m leaving it until we can talk about a way forward- it still wouldn’t fix the issue with raising zeros up or the data being quite clearly not lognormal.</p>
<section id="do-the-scaling-2" class="level2">
<h2 class="anchored" data-anchor-id="do-the-scaling-2">Do the scaling</h2>
<p>We fit a lognormal, but also shift the data off zero by some optimum amount. This is equivalent to saying there’s some unknown part of the distribution that extends below 0- we just have to shift up to allow the lognormal to fit it. We could do something similar by pre-logging the data and fitting a truncated normal.</p>
<p>In testing, I developed some functions that do this optimisation and fit the lognormals. This is ugly because it returns a dataframe instead of easy-to-use parameters, but I’m not going to bother changing it now. Easy enough to later if we go this way. The dataframe is handy to keep track of the shifts.</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-38_3970186c01221fb89d5f1e36c8faa9b8">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>fitshift <span class="ot">&lt;-</span> <span class="cf">function</span>(cleandata, shift_up) {</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Handle the zero shift case- we just use the next value up</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (shift_up <span class="sc">==</span> <span class="dv">0</span>) {rightlim <span class="ot">&lt;-</span> <span class="fu">min</span>(cleandata[cleandata<span class="sc">&gt;</span><span class="dv">0</span>])</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>      rightlim <span class="ot">&lt;-</span> shift_up}</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>  inshift <span class="ot">&lt;-</span> cleandata <span class="sc">+</span> shift_up</span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>    upcens <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">left =</span> <span class="fu">ifelse</span>(inshift <span class="sc">&lt;=</span> shift_up, <span class="cn">NA</span>, inshift),</span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>                <span class="at">right =</span> <span class="fu">ifelse</span>(inshift <span class="sc">&lt;=</span> shift_up, rightlim, inshift))</span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">suppressWarnings</span>(fit_up <span class="ot">&lt;-</span> fitdistrplus<span class="sc">::</span><span class="fu">fitdistcens</span>(<span class="at">censdata =</span> <span class="fu">data.frame</span>(upcens),</span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">distr =</span> <span class="st">'lnorm'</span>))</span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(fit_up)</span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-18"><a href="#cb70-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-19"><a href="#cb70-19" aria-hidden="true" tabindex="-1"></a>opt_up <span class="ot">&lt;-</span> <span class="cf">function</span>(shift_up, cleandata) {</span>
<span id="cb70-20"><a href="#cb70-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb70-21"><a href="#cb70-21" aria-hidden="true" tabindex="-1"></a>  fit_up <span class="ot">&lt;-</span> <span class="fu">fitshift</span>(cleandata, shift_up)</span>
<span id="cb70-22"><a href="#cb70-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb70-23"><a href="#cb70-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="sc">-</span>fit_up<span class="sc">$</span>loglik)</span>
<span id="cb70-24"><a href="#cb70-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb70-25"><a href="#cb70-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-26"><a href="#cb70-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-27"><a href="#cb70-27" aria-hidden="true" tabindex="-1"></a>optshift <span class="ot">&lt;-</span> <span class="cf">function</span>(rawdata) {</span>
<span id="cb70-28"><a href="#cb70-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb70-29"><a href="#cb70-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This is about distributions, NOT data order, so get rid of NAs</span></span>
<span id="cb70-30"><a href="#cb70-30" aria-hidden="true" tabindex="-1"></a>  rawna <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(rawdata<span class="sc">$</span>hyd_vals)</span>
<span id="cb70-31"><a href="#cb70-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb70-32"><a href="#cb70-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get the optimal shift</span></span>
<span id="cb70-33"><a href="#cb70-33" aria-hidden="true" tabindex="-1"></a>  shift <span class="ot">&lt;-</span> <span class="fu">optimize</span>(opt_up, <span class="at">interval =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1000</span>), <span class="at">cleandata =</span> rawna)</span>
<span id="cb70-34"><a href="#cb70-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb70-35"><a href="#cb70-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get the fit at that shift (would be nice to kick this out of opt_up somehow)</span></span>
<span id="cb70-36"><a href="#cb70-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb70-37"><a href="#cb70-37" aria-hidden="true" tabindex="-1"></a>  fit_up <span class="ot">&lt;-</span> <span class="fu">fitshift</span>(rawna, shift<span class="sc">$</span>minimum)</span>
<span id="cb70-38"><a href="#cb70-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb70-39"><a href="#cb70-39" aria-hidden="true" tabindex="-1"></a> <span class="co"># Create a df for output</span></span>
<span id="cb70-40"><a href="#cb70-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># The shifted data</span></span>
<span id="cb70-41"><a href="#cb70-41" aria-hidden="true" tabindex="-1"></a>  shiftdf <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">time =</span> rawdata<span class="sc">$</span>time,</span>
<span id="cb70-42"><a href="#cb70-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">orig_data =</span> rawdata<span class="sc">$</span>hyd_vals, </span>
<span id="cb70-43"><a href="#cb70-43" aria-hidden="true" tabindex="-1"></a>                    <span class="at">shift_data =</span> rawdata<span class="sc">$</span>hyd_vals <span class="sc">+</span> shift<span class="sc">$</span>minimum, </span>
<span id="cb70-44"><a href="#cb70-44" aria-hidden="true" tabindex="-1"></a>                    <span class="at">optimum_shift =</span> shift<span class="sc">$</span>minimum)</span>
<span id="cb70-45"><a href="#cb70-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb70-46"><a href="#cb70-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-47"><a href="#cb70-47" aria-hidden="true" tabindex="-1"></a>   <span class="co"># This isn't ideal, but we can shove the cdf on here too, it just has rows that don't mean the same thing. prevents us saving a list though.</span></span>
<span id="cb70-48"><a href="#cb70-48" aria-hidden="true" tabindex="-1"></a>  shiftdf <span class="ot">&lt;-</span> shiftdf <span class="sc">|&gt;</span> </span>
<span id="cb70-49"><a href="#cb70-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">x =</span> <span class="fu">row_number</span>()<span class="sc">/</span><span class="dv">10</span>,</span>
<span id="cb70-50"><a href="#cb70-50" aria-hidden="true" tabindex="-1"></a>           <span class="at">meanlog =</span> fit_up<span class="sc">$</span>estimate[<span class="st">'meanlog'</span>],</span>
<span id="cb70-51"><a href="#cb70-51" aria-hidden="true" tabindex="-1"></a>           <span class="at">sdlog =</span> fit_up<span class="sc">$</span>estimate[<span class="st">'sdlog'</span>],</span>
<span id="cb70-52"><a href="#cb70-52" aria-hidden="true" tabindex="-1"></a>           <span class="at">cdf_up =</span> <span class="fu">plnorm</span>(x, </span>
<span id="cb70-53"><a href="#cb70-53" aria-hidden="true" tabindex="-1"></a>                             fit_up<span class="sc">$</span>estimate[<span class="st">'meanlog'</span>],</span>
<span id="cb70-54"><a href="#cb70-54" aria-hidden="true" tabindex="-1"></a>                             fit_up<span class="sc">$</span>estimate[<span class="st">'sdlog'</span>]),</span>
<span id="cb70-55"><a href="#cb70-55" aria-hidden="true" tabindex="-1"></a>           <span class="at">pdf_up =</span> <span class="fu">dlnorm</span>(x, </span>
<span id="cb70-56"><a href="#cb70-56" aria-hidden="true" tabindex="-1"></a>                             fit_up<span class="sc">$</span>estimate[<span class="st">'meanlog'</span>],</span>
<span id="cb70-57"><a href="#cb70-57" aria-hidden="true" tabindex="-1"></a>                             fit_up<span class="sc">$</span>estimate[<span class="st">'sdlog'</span>]),</span>
<span id="cb70-58"><a href="#cb70-58" aria-hidden="true" tabindex="-1"></a>           <span class="co"># Some diagnostics</span></span>
<span id="cb70-59"><a href="#cb70-59" aria-hidden="true" tabindex="-1"></a>           <span class="at">fitloglik =</span> fit_up<span class="sc">$</span>loglik)</span>
<span id="cb70-60"><a href="#cb70-60" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb70-61"><a href="#cb70-61" aria-hidden="true" tabindex="-1"></a>  <span class="co"># and a shifted-back version of the cdf/pdf just needs a shifted x. The</span></span>
<span id="cb70-62"><a href="#cb70-62" aria-hidden="true" tabindex="-1"></a>  <span class="co"># backshift of the data is just the original `rawdata`.</span></span>
<span id="cb70-63"><a href="#cb70-63" aria-hidden="true" tabindex="-1"></a>  shiftdf <span class="ot">&lt;-</span> shiftdf <span class="sc">|&gt;</span> </span>
<span id="cb70-64"><a href="#cb70-64" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">x_back =</span> x<span class="sc">-</span>shift<span class="sc">$</span>minimum)</span>
<span id="cb70-65"><a href="#cb70-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-66"><a href="#cb70-66" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we use that to fit the data. This gives us the best lognormal fit for the input hydrograph.</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-39_49978695f56d67cbb24eda8ca119f913">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>optimal_fit <span class="ot">&lt;-</span> test_hydro <span class="sc">%&gt;%</span> </span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(time, hyd_vals) <span class="sc">%&gt;%</span> </span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">optshift</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We also need the best lognormal fit for the model runoff for all scenarios</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-40_e77b49e078b5b8b452c487f962579951">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co"># make a df from the fit so we can return it</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>fittabler <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># uncensored, but use fitdistrplus function instead of MASS for consistency</span></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>  fitout <span class="ot">&lt;-</span> fitdistrplus<span class="sc">::</span><span class="fu">fitdist</span>(x, <span class="at">distr =</span> <span class="st">'lnorm'</span>)</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>  fittable <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">meanlog =</span> fitout<span class="sc">$</span>estimate[<span class="st">'meanlog'</span>],</span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>                     <span class="at">sdlog =</span> fitout<span class="sc">$</span>estimate[<span class="st">'sdlog'</span>],</span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>                     <span class="at">loglik =</span> fitout<span class="sc">$</span>loglik)</span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(fittable)</span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a>scene_fits <span class="ot">&lt;-</span> test_model <span class="sc">%&gt;%</span> </span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">starts_with</span>(<span class="st">'Sim'</span>), <span class="at">names_to =</span> <span class="st">'scenario'</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb72-15"><a href="#cb72-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(scenario) <span class="sc">%&gt;%</span> </span>
<span id="cb72-16"><a href="#cb72-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">fit_sims =</span> <span class="fu">fittabler</span>(value)) <span class="sc">%&gt;%</span> </span>
<span id="cb72-17"><a href="#cb72-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb72-18"><a href="#cb72-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(fit_sims)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="brief-diagnostics--how-are-the-fits" class="level3">
<h3 class="anchored" data-anchor-id="brief-diagnostics--how-are-the-fits">Brief diagnostics- how are the fits?</h3>
<p>The hydrograph- the red line is the best fit curve, shifted back, so we can see what it would do below 0.</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-41_0e9873cb17e05cdff2c8e221c74d197d">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(optimal_fit) <span class="sc">+</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ecdf of the hydrograph data</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ecdf</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> orig_data), <span class="at">color =</span> <span class="st">'forestgreen'</span>) <span class="sc">+</span></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># lognormal cdf</span></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> x_back, <span class="at">y =</span> cdf_up), </span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">'firebrick'</span>, <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">10</span>, <span class="dv">1000</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1564 rows containing non-finite values (`stat_ecdf()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="flow_scaling_methods_files/figure-html/unnamed-chunk-41-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Scenarios</p>
<p>First we need to make the cdfs</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-42_73bfeb002b785fbab2b1a563020170b6">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>makecdf_df <span class="ot">&lt;-</span> <span class="cf">function</span>(scenario, meanlog, sdlog, loglik, <span class="at">x =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">30</span>, <span class="at">by =</span> <span class="fl">0.01</span>)) {</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>  cdf <span class="ot">&lt;-</span> <span class="fu">plnorm</span>(x, meanlog, sdlog)</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>  pdf <span class="ot">&lt;-</span> <span class="fu">dlnorm</span>(x, meanlog, sdlog)</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">tibble</span>(<span class="at">x =</span> x, <span class="at">cdf =</span> cdf, <span class="at">pdf =</span> pdf, <span class="at">scenario =</span> scenario))</span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a>scenecdf <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">pmap</span>(scene_fits, makecdf_df) <span class="sc">%&gt;%</span> </span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then we rearrange some data and plot</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-43_9b78504e7086eb76f768b83e62a0e078">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>model_long <span class="ot">&lt;-</span> test_model <span class="sc">%&gt;%</span> </span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">starts_with</span>(<span class="st">'Sim'</span>), <span class="at">names_to =</span> <span class="st">'scenario'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-44_b6db387a8bd535b86dee1c020bf8537d">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ecdf</span>(<span class="at">data =</span> model_long, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">color =</span> scenario)) <span class="sc">+</span></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> scenecdf, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> cdf, </span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">color =</span> scenario),</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="flow_scaling_methods_files/figure-html/unnamed-chunk-44-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>That’s really hard to see, what if we just limit it to the lowest and highest?</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-45_55389aa748c3efbfe5b686f595453123">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span>   </span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ecdf</span>(<span class="at">data =</span> <span class="fu">filter</span>(model_long, scenario <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">'SimR1'</span>, <span class="st">'SimR7'</span>)),             <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">color =</span> scenario)) <span class="sc">+</span>   </span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> <span class="fu">filter</span>(scenecdf, scenario <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">'SimR1'</span>, <span class="st">'SimR7'</span>)),             <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> cdf,</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> scenario),</span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="flow_scaling_methods_files/figure-html/unnamed-chunk-45-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="shift-the-distributions" class="level3">
<h3 class="anchored" data-anchor-id="shift-the-distributions">Shift the distributions</h3>
<p>The means and sds here are on the log scale, and so can be treated like normal parameters. AND, because they’re on the log scale, arithmetic changes in mean yield multiplicative changes in the data.</p>
<p>So, to shift NORMAL distributions, we just add means and so we need the difference from each scenario mean to the SimR0. And to shift the sds, we use a multiplicative shift.</p>
<p>Basically, the mean shift needs to be calculated as the mean_new - mean_reference and the sd shift needs to be sd_new/sd_reference, where <code>*new</code> are the SimR1...7, and <code>*reference</code> are the SimR0. And then to apply them to the hydrograph distribution, the new sd is old_sd*sd_shift and new mean is old_mean + mean_shift.</p>
<p>So, let’s get those shift values for each scenario.</p>
<p><em>I need to fix werptoolkitr to allow extra columns, but need to get this done more</em> so, do the mean and log separately and glue together.</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-46_d3ff79bf38e7277b2500a9a677363d39">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>scene_fits_mean <span class="ot">&lt;-</span> scene_fits <span class="sc">%&gt;%</span> </span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(scenario, meanlog) <span class="sc">%&gt;%</span> </span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>  werptoolkitr<span class="sc">::</span><span class="fu">baseline_compare</span>(<span class="at">compare_col =</span> <span class="st">'scenario'</span>, </span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>                   <span class="at">base_lev =</span> <span class="st">'SimR0'</span>, </span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>                   <span class="at">values_col =</span> <span class="st">'meanlog'</span>, </span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>                   <span class="at">comp_fun =</span> <span class="st">'difference'</span>)</span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>scene_fits_sd <span class="ot">&lt;-</span> scene_fits <span class="sc">%&gt;%</span> </span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(scenario, sdlog) <span class="sc">%&gt;%</span> </span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a>  werptoolkitr<span class="sc">::</span><span class="fu">baseline_compare</span>(<span class="at">compare_col =</span> <span class="st">'scenario'</span>, </span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a>                   <span class="at">base_lev =</span> <span class="st">'SimR0'</span>, </span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true" tabindex="-1"></a>                   <span class="at">values_col =</span> <span class="st">'sdlog'</span>, </span>
<span id="cb79-13"><a href="#cb79-13" aria-hidden="true" tabindex="-1"></a>                   <span class="at">comp_fun =</span> <span class="st">'relative'</span>)</span>
<span id="cb79-14"><a href="#cb79-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-15"><a href="#cb79-15" aria-hidden="true" tabindex="-1"></a>scene_fits_shift <span class="ot">&lt;-</span> scene_fits <span class="sc">%&gt;%</span> </span>
<span id="cb79-16"><a href="#cb79-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(scene_fits_mean) <span class="sc">%&gt;%</span> </span>
<span id="cb79-17"><a href="#cb79-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(scene_fits_sd)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Joining, by = c("scenario", "meanlog")
Joining, by = c("scenario", "sdlog")</code></pre>
</div>
</div>
<p>I don’t really want to be operating out of a dataframe just to get single numbers, but I think I will for the moment to keep things consistent and clean up later.</p>
<p>Shift the <em>hydrograph</em> parameters to match the shifts in the <em>runoff</em> parameters</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-47_130a7735bedd1075271394af1aaf8d0f">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>hydro_shift_dist <span class="ot">&lt;-</span> scene_fits_shift <span class="sc">%&gt;%</span> </span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">hydro_meanlog =</span> optimal_fit<span class="sc">$</span>meanlog[<span class="dv">1</span>] <span class="sc">+</span> difference_meanlog,</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">hydro_sdlog =</span> optimal_fit<span class="sc">$</span>sdlog[<span class="dv">1</span>] <span class="sc">*</span> relative_sdlog,</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">hydro_shift =</span> optimal_fit<span class="sc">$</span>optimum_shift[<span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And now we use those to translate the hydrograph to each of the distributions. We do that with a pmap over the parameters we just got. There’s a lot of extra junk in this df, so I’m tossing some (the in-built distributions, which always were weird to be in here).</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-48_5b37550b79d4e946602977d1e89c5def">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We need the empirical cdf to get the probability for each x</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>phydro <span class="ot">&lt;-</span> <span class="fu">ecdf</span>(optimal_fit<span class="sc">$</span>shift_data)</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>scene_trans <span class="ot">&lt;-</span> <span class="cf">function</span>(scenario, hydro_meanlog, hydro_sdlog, hydro_shift) {</span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>  trans_hydro <span class="ot">&lt;-</span> optimal_fit <span class="sc">%&gt;%</span> </span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">scenario =</span> scenario,</span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">p_shift =</span> <span class="fu">phydro</span>(shift_data),</span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">q_shiftln =</span> <span class="fu">qlnorm</span>(p_shift, </span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a>                            hydro_meanlog,</span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a>                            hydro_sdlog),</span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true" tabindex="-1"></a>         <span class="at">q_back =</span> q_shiftln<span class="sc">-</span>hydro_shift)</span>
<span id="cb82-12"><a href="#cb82-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb82-13"><a href="#cb82-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb82-14"><a href="#cb82-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-15"><a href="#cb82-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-16"><a href="#cb82-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-17"><a href="#cb82-17" aria-hidden="true" tabindex="-1"></a>hydro_trans <span class="ot">&lt;-</span> hydro_shift_dist <span class="sc">%&gt;%</span> </span>
<span id="cb82-18"><a href="#cb82-18" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(scenario, hydro_meanlog, hydro_sdlog, hydro_shift) <span class="sc">%&gt;%</span> </span>
<span id="cb82-19"><a href="#cb82-19" aria-hidden="true" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">pmap</span>(scene_trans) <span class="sc">%&gt;%</span> </span>
<span id="cb82-20"><a href="#cb82-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb82-21"><a href="#cb82-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(scenario, time, orig_data, shift_data, q_back, q_shiftln, optimum_shift)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="outcome-distributions-2" class="level2">
<h2 class="anchored" data-anchor-id="outcome-distributions-2">Outcome distributions</h2>
<section id="compare-baselines-2" class="level3">
<h3 class="anchored" data-anchor-id="compare-baselines-2">Compare baselines</h3>
<p>Timeseries- there are some very high values, but if we clip them off (bottom panel), it actually looks pretty good.</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-49_812ba235edc117411b8b10938576c624">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>orig_time <span class="ot">&lt;-</span> hydro_trans <span class="sc">%&gt;%</span> </span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(scenario <span class="sc">==</span> <span class="st">'SimR0'</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> orig_data)) <span class="sc">+</span></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">'forestgreen'</span>) </span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>pred_time <span class="ot">&lt;-</span> hydro_trans <span class="sc">%&gt;%</span> </span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(scenario <span class="sc">==</span> <span class="st">'SimR0'</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> q_back)) <span class="sc">+</span></span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">'dodgerblue'</span>) </span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a>orig_time <span class="sc">/</span> pred_time <span class="sc">/</span> (pred_time <span class="sc">+</span> <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">10000</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1 row containing missing values (`geom_line()`).
Removed 1 row containing missing values (`geom_line()`).
Removed 1 row containing missing values (`geom_line()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="flow_scaling_methods_files/figure-html/unnamed-chunk-49-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>CDF. The fit for the baseline matches 0 in the data to 4.54 in the fit distribution, and so we end up with the probability spike from all those zeros right at the beginning. IFor this baseline case, we want to check the fit and the spike makes that difficult. So I also create a ‘corrected’ version that brings the 0s back to 0, and look at it on the log scale where it’s easier to see. This is fudging a bit, and we probably should think carefully about whether to do this if we move forward with this approach.</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-50_323d2b4954b5430aeab137fbadc9d3ca">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>trans_cdf <span class="ot">&lt;-</span> hydro_trans <span class="sc">%&gt;%</span> </span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(scenario <span class="sc">==</span> <span class="st">'SimR0'</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ecdf</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> orig_data), <span class="at">color =</span> <span class="st">'forestgreen'</span>) <span class="sc">+</span></span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ecdf</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> q_back), <span class="at">color =</span> <span class="st">'dodgerblue'</span>)</span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a>trans_cdf_ln <span class="ot">&lt;-</span> hydro_trans <span class="sc">%&gt;%</span> </span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(scenario <span class="sc">==</span> <span class="st">'SimR0'</span>) <span class="sc">%&gt;%</span>  </span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ecdf</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(orig_data)), <span class="at">color =</span> <span class="st">'forestgreen'</span>) <span class="sc">+</span></span>
<span id="cb85-11"><a href="#cb85-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ecdf</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(q_back)), <span class="at">color =</span> <span class="st">'dodgerblue'</span>)</span>
<span id="cb85-12"><a href="#cb85-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-13"><a href="#cb85-13" aria-hidden="true" tabindex="-1"></a>trans_cdf_ln_corrected <span class="ot">&lt;-</span> hydro_trans <span class="sc">%&gt;%</span> </span>
<span id="cb85-14"><a href="#cb85-14" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(scenario <span class="sc">==</span> <span class="st">'SimR0'</span>) <span class="sc">%&gt;%</span>  </span>
<span id="cb85-15"><a href="#cb85-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb85-16"><a href="#cb85-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ecdf</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(orig_data)), <span class="at">color =</span> <span class="st">'forestgreen'</span>) <span class="sc">+</span></span>
<span id="cb85-17"><a href="#cb85-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ecdf</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(q_back<span class="sc">-</span><span class="fu">min</span>(q_back, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))), <span class="at">color =</span> <span class="st">'dodgerblue'</span>)</span>
<span id="cb85-18"><a href="#cb85-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-19"><a href="#cb85-19" aria-hidden="true" tabindex="-1"></a>((trans_cdf <span class="sc">+</span> <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">2000</span>))) <span class="sc">+</span>  trans_cdf_ln) <span class="sc">/</span> trans_cdf_ln_corrected</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1564 rows containing non-finite values (`stat_ecdf()`).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1565 rows containing non-finite values (`stat_ecdf()`).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 4384 rows containing non-finite values (`stat_ecdf()`).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1565 rows containing non-finite values (`stat_ecdf()`).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 4384 rows containing non-finite values (`stat_ecdf()`).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 4385 rows containing non-finite values (`stat_ecdf()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="flow_scaling_methods_files/figure-html/unnamed-chunk-50-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>PDF. The probability spike shows up even more strongly in the log-scale pdf. We also see pretty clearly that this distribution is just fundamentally not lognormal- it is too peaky and asymmetric and multimodal. The multimodality really makes it unlikely that just changing distribution would fix things.</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-51_5a25097dbdade7209307ae11c99b2719">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>trans_pdf <span class="ot">&lt;-</span> hydro_trans <span class="sc">%&gt;%</span> </span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(scenario <span class="sc">==</span> <span class="st">'SimR0'</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> orig_data), <span class="at">color =</span> <span class="st">'forestgreen'</span>) <span class="sc">+</span></span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a> <span class="fu">geom_density</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> q_back), <span class="at">color =</span> <span class="st">'dodgerblue'</span>)</span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a>trans_pdf_ln <span class="ot">&lt;-</span> hydro_trans <span class="sc">%&gt;%</span> </span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(scenario <span class="sc">==</span> <span class="st">'SimR0'</span>) <span class="sc">%&gt;%</span>  </span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb92-10"><a href="#cb92-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(orig_data)), <span class="at">color =</span> <span class="st">'forestgreen'</span>) <span class="sc">+</span></span>
<span id="cb92-11"><a href="#cb92-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(q_back)), <span class="at">color =</span> <span class="st">'dodgerblue'</span>)</span>
<span id="cb92-12"><a href="#cb92-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-13"><a href="#cb92-13" aria-hidden="true" tabindex="-1"></a>trans_pdf_ln_corrected <span class="ot">&lt;-</span> hydro_trans <span class="sc">%&gt;%</span> </span>
<span id="cb92-14"><a href="#cb92-14" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(scenario <span class="sc">==</span> <span class="st">'SimR0'</span>) <span class="sc">%&gt;%</span>  </span>
<span id="cb92-15"><a href="#cb92-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb92-16"><a href="#cb92-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(orig_data)), <span class="at">color =</span> <span class="st">'forestgreen'</span>) <span class="sc">+</span></span>
<span id="cb92-17"><a href="#cb92-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(q_back<span class="sc">-</span><span class="fu">min</span>(q_back, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))), <span class="at">color =</span> <span class="st">'dodgerblue'</span>)</span>
<span id="cb92-18"><a href="#cb92-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-19"><a href="#cb92-19" aria-hidden="true" tabindex="-1"></a>((trans_pdf <span class="sc">+</span> <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">2000</span>))) <span class="sc">+</span>  trans_pdf_ln) <span class="sc">/</span> trans_pdf_ln_corrected</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1564 rows containing non-finite values (`stat_density()`).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1565 rows containing non-finite values (`stat_density()`).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 4384 rows containing non-finite values (`stat_density()`).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1565 rows containing non-finite values (`stat_density()`).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 4384 rows containing non-finite values (`stat_density()`).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 4385 rows containing non-finite values (`stat_density()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="flow_scaling_methods_files/figure-html/unnamed-chunk-51-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="compare-scenario-shifts-2" class="level3">
<h3 class="anchored" data-anchor-id="compare-scenario-shifts-2">Compare scenario shifts</h3>
<p>Timeseries. I’ve clipped y at 10000 again, just because the tail really blows out.</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-52_fce7da065f3fb60c1a67a474c34c6a86">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>pred_scene_time <span class="ot">&lt;-</span> hydro_trans <span class="sc">%&gt;%</span> </span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> q_back)) <span class="sc">+</span></span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> <span class="fu">facet_wrap</span>(<span class="st">'scenario'</span>) </span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a>pred_scene_time <span class="sc">+</span> <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">10000</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1 row containing missing values (`geom_line()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="flow_scaling_methods_files/figure-html/unnamed-chunk-52-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>CDF- Notice the issues with all the 0s being given the same positive number for the increased water scenarios. And perhaps most concerning, the real hydrograph distribution is more different than any of the fit distributions than they are from each other.</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-53_623c5a3dfb0997dfd93d9408d0984a68">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>trans_cdf_all <span class="ot">&lt;-</span> hydro_trans <span class="sc">%&gt;%</span> </span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> q_back, <span class="at">color =</span> scenario)) <span class="sc">+</span></span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ecdf</span>() <span class="sc">+</span></span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ecdf</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> orig_data), <span class="at">color =</span> <span class="st">'black'</span>)</span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a>trans_cdf_ln_all <span class="ot">&lt;-</span> hydro_trans <span class="sc">%&gt;%</span> </span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(q_back), <span class="at">color =</span> scenario)) <span class="sc">+</span></span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ecdf</span>() <span class="sc">+</span></span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ecdf</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(orig_data)), <span class="at">color =</span> <span class="st">'black'</span>)</span>
<span id="cb101-10"><a href="#cb101-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-11"><a href="#cb101-11" aria-hidden="true" tabindex="-1"></a>trans_cdf_all <span class="sc">+</span> trans_cdf_ln_all</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 12520 rows containing non-finite values (`stat_ecdf()`).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 12512 rows containing non-finite values (`stat_ecdf()`).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in log(q_back): NaNs produced

Warning in log(q_back): NaNs produced</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 35705 rows containing non-finite values (`stat_ecdf()`).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 35072 rows containing non-finite values (`stat_ecdf()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="flow_scaling_methods_files/figure-html/unnamed-chunk-53-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>PDFs. Again, the increased water scenarios have a massive density spike because all zeros get the same number. Here, we can really see clearly that the real hydrograph distribution in black differs from all the transformed distributions (including the R0) much more than the scenario transforms differ from each other. So the act of making the hydrograph a lognormal is a bigger shift than the scenarios are.</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-54_39f4eae7d19bc05b4b81bf79fc97d3c4">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>trans_pdf_all <span class="ot">&lt;-</span> hydro_trans <span class="sc">%&gt;%</span> </span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> q_back, <span class="at">color =</span> scenario)) <span class="sc">+</span></span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>() <span class="sc">+</span></span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> orig_data), <span class="at">color =</span> <span class="st">'black'</span>)</span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a>trans_pdf_ln_all <span class="ot">&lt;-</span> hydro_trans <span class="sc">%&gt;%</span> </span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(q_back), <span class="at">color =</span> scenario)) <span class="sc">+</span></span>
<span id="cb107-8"><a href="#cb107-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>() <span class="sc">+</span></span>
<span id="cb107-9"><a href="#cb107-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(orig_data)), <span class="at">color =</span> <span class="st">'black'</span>)</span>
<span id="cb107-10"><a href="#cb107-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-11"><a href="#cb107-11" aria-hidden="true" tabindex="-1"></a>trans_pdf_all <span class="sc">+</span> trans_pdf_ln_all</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 12520 rows containing non-finite values (`stat_density()`).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 12512 rows containing non-finite values (`stat_density()`).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in log(q_back): NaNs produced

Warning in log(q_back): NaNs produced</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 35705 rows containing non-finite values (`stat_density()`).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 35072 rows containing non-finite values (`stat_density()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="flow_scaling_methods_files/figure-html/unnamed-chunk-54-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
</section>
<section id="conclusions-1" class="level1">
<h1>Conclusions</h1>
<p>The q-q does the best job of preserving the shape of the hydrograph.</p>
<p>All approaches have an issue with zeros. The q-q leaves them unchanged, while the regression and parametric lognormals end up with probability spikes, and so really only make sense to use if we’re reducing flows (increasing zeros probably OK, decreasing them fraught).</p>
<p>If we’re just going to increase zeros, can we put a threshold on the q-q, and drop to 0 when below? Maybe- it doesn’t change the zeros much, but it’s not nothing</p>
<p>What if we ask about lowering flows? Can we put on a threshold and increase zeros? The minimum detected is 0.001</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-55_5c79779aef0c9adb581593f4538b4614">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>qq_hydro <span class="sc">%&gt;%</span> </span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(scenario <span class="sc">==</span> <span class="st">'SimR0'</span> <span class="sc">&amp;</span> value <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">minpos =</span> <span class="fu">min</span>(value, <span class="at">na.rm =</span> <span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 1
  minpos
   &lt;dbl&gt;
1  0.001</code></pre>
</div>
</div>
<p>That gives a few but not many more zeros in the lower runoff scenarios. Still, we wouldn’t pick anything useful up there.</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-56_f532422f9ecb2a80070481dffa351f49">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>qq_hydro <span class="sc">%&gt;%</span>    </span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(scenario) <span class="sc">%&gt;%</span>    </span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">n_pseudo_zeros =</span> <span class="fu">sum</span>(value <span class="sc">&lt;</span> <span class="fl">0.001</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 8 × 2
  scenario n_pseudo_zeros
  &lt;chr&gt;             &lt;int&gt;
1 SimR0              2820
2 SimR1              2826
3 SimR2              2826
4 SimR3              2826
5 SimR4              2826
6 SimR5              2826
7 SimR6              2820
8 SimR7              2820</code></pre>
</div>
</div>
<p>If we used a higher threshold (I’d be surprised if 0.001 is a real measurement). A bit of shifting happening here. Still pretty low proportionally, but at least we would get a bit of variation. 15 top-bottom though is much less than the 450ish we get for the regression version.</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-57_2868c4e3e8aa94667b2669c752a60fb8">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>qq_hydro <span class="sc">%&gt;%</span>    </span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(scenario) <span class="sc">%&gt;%</span>    </span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">n_pseudo_zeros =</span> <span class="fu">sum</span>(value <span class="sc">&lt;</span> <span class="dv">1</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 8 × 2
  scenario n_pseudo_zeros
  &lt;chr&gt;             &lt;int&gt;
1 SimR0              2854
2 SimR1              2868
3 SimR2              2866
4 SimR3              2861
5 SimR4              2856
6 SimR5              2854
7 SimR6              2854
8 SimR7              2853</code></pre>
</div>
</div>
</section>
<section id="further-approaches" class="level1">
<h1>Further approaches</h1>
<p>We could use q-q or parametric or ?? to shift most of the distribution, and linearize the bottom 10% or something to handle the zero problem. But we’d be left with the issue that all zeros become the same number, and so it’s really not appropriate to shift them up. Could then stick with declines (should be all but 7 &amp; 8).</p>
<p>We could group the regression and lognormal methods by Month or other timespan (as we do for q-q), which probably would improve fits. But it won’t deal with the fundamental issue of the mass spike at the value matching 0, and it’s certainly not going to linearize the regression comparison or make the data truly lognormal.</p>
<p>We could try other distributions, (or fit manually-logged data on the normal scale, which would allow us to treat the shifts a bit differently), but that wouldn’t fix the underlying problem that the data is just not normal on that scale or that when we map values we still have a big probability mass at 0 in the hydrograph itself, and we can’t know which of those values to replace.</p>
<p>For the probability mass from all the zeros that we get no matter what with increased water, we could get fancy with finding the autocorrelation, and then generating AC sequences through each section of ex-zeros that have the right number of realised zeros for the scenario. That’s farther than I think we want to go though.</p>
</section>
<section id="q-q-regression" class="level1">
<h1>Q-Q + regression</h1>
<p>The q-q + regression seems like it might have the best chance.</p>
<p>I’m going to throw this together a bit from the things above- if we move forward it’ll need to be cleaned up, and things like months respected in the regression or tossed from q-q.</p>
<p>We’ll build the regression just like before, but only on the lowest x% of values. See what that looks like. 5% seems reasonable? Those few values at the bottom really fall off the world, but there aren’t many of them, and we hit the main trend pretty OK.</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-58_0a51df46e9b1b3fbadea84408e266977">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a>bottom_ranks <span class="ot">&lt;-</span> <span class="fu">max</span>(rank_log<span class="sc">$</span>ranks)<span class="sc">*</span><span class="fl">0.05</span></span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a>drop0_bottom <span class="ot">&lt;-</span> rank_hydro <span class="sc">%&gt;%</span> </span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(scenario <span class="sc">==</span> <span class="st">'SimR0'</span> <span class="sc">&amp;</span> ranks <span class="sc">&lt;</span> bottom_ranks) <span class="sc">%&gt;%</span> </span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(mod_vals), <span class="at">y =</span> <span class="fu">log</span>(hyd_vals))) <span class="sc">+</span> </span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb119-7"><a href="#cb119-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">'lm'</span>)</span>
<span id="cb119-8"><a href="#cb119-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-9"><a href="#cb119-9" aria-hidden="true" tabindex="-1"></a>drop0_bottom</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 2820 rows containing non-finite values (`stat_smooth()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="flow_scaling_methods_files/figure-html/unnamed-chunk-58-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Get the fit</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-59_5ad89b51ca3599dcff8d59336dc2727e">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>logregression_bottom <span class="ot">&lt;-</span> <span class="fu">lm</span>(log_hyd <span class="sc">~</span> log_mod, <span class="at">data =</span> rank_log[rank_log<span class="sc">$</span>ranks <span class="sc">&lt;</span> bottom_ranks, ])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Apply that, but only to values below that rank.</p>
<p>This is a bit roundabout, if we go this way I’ll do it when we make the qq so the data’s actually there to work with and we don’t have to make another df and replace values.</p>
<p>Let’s say anything below 1 is a 0, it sure looks like that’s where the graph above gets weird.</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-60_1907e416ca4fb85a7c9f6d5165c15913">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>bottom_rank_fit <span class="ot">&lt;-</span> rank_hydro <span class="sc">%&gt;%</span> </span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(ranks <span class="sc">&lt;</span> bottom_ranks) <span class="sc">%&gt;%</span> </span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">log_mod =</span> <span class="fu">log</span>(mod_vals),</span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">log_hyd =</span> <span class="fu">log</span>(hyd_vals)) <span class="sc">%&gt;%</span> </span>
<span id="cb123-5"><a href="#cb123-5" aria-hidden="true" tabindex="-1"></a>  modelr<span class="sc">::</span><span class="fu">add_predictions</span>(logregression_bottom, <span class="st">'pred_log_hyd'</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb123-6"><a href="#cb123-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pred_hyd =</span> <span class="fu">exp</span>(pred_log_hyd)) <span class="sc">%&gt;%</span> </span>
<span id="cb123-7"><a href="#cb123-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Threshold for 0</span></span>
<span id="cb123-8"><a href="#cb123-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pred_hyd =</span> <span class="fu">ifelse</span>(pred_hyd <span class="sc">&gt;</span> <span class="dv">1</span>, pred_hyd, <span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, this is a goofy way to do this, but it avoids rebuilding the qq</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-61_35922704068892c7ed9d3cc13122dadf">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a>brf <span class="ot">&lt;-</span> bottom_rank_fit <span class="sc">%&gt;%</span> </span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="at">Date =</span> time, scenario, pred_hyd)</span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a>qq_reg <span class="ot">&lt;-</span> qq_hydro <span class="sc">%&gt;%</span> </span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(brf, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">'Date'</span>, <span class="st">'scenario'</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">value =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(pred_hyd), value, pred_hyd)) <span class="sc">%&gt;%</span> </span>
<span id="cb124-7"><a href="#cb124-7" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>pred_hyd)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="compare-scenarios" class="level2">
<h2 class="anchored" data-anchor-id="compare-scenarios">Compare scenarios</h2>
<p>TImeseries- I’ve marked the zeros with cyan.</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-62_1ae4e7ca22787b6f0050c8081a0d98bd">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>qq_reg_timeseries <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(qq_reg, <span class="fu">aes</span>(<span class="at">x =</span> Date, <span class="at">y =</span> value)) <span class="sc">+</span> </span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> <span class="fu">facet_wrap</span>(<span class="st">'scenario'</span>) <span class="sc">+</span></span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> <span class="fu">filter</span>(qq_reg, value <span class="sc">==</span> <span class="dv">0</span>), <span class="at">color =</span> <span class="st">'cyan3'</span>)</span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a>qq_reg_timeseries</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1 row containing missing values (`geom_line()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="flow_scaling_methods_files/figure-html/unnamed-chunk-62-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>CDF</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-63_252171e8bb25ef8f72a12fd0f51c2c0e">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a>hyd_cdf_qq_reg <span class="ot">&lt;-</span> qq_reg <span class="sc">%&gt;%</span></span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">color =</span> scenario)) <span class="sc">+</span></span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ecdf</span>()</span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a>hyd_cdf_qq_reg_ln <span class="ot">&lt;-</span> qq_reg <span class="sc">%&gt;%</span></span>
<span id="cb127-6"><a href="#cb127-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(value), <span class="at">color =</span> scenario)) <span class="sc">+</span></span>
<span id="cb127-7"><a href="#cb127-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ecdf</span>()</span>
<span id="cb127-8"><a href="#cb127-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-9"><a href="#cb127-9" aria-hidden="true" tabindex="-1"></a>hyd_cdf_qq_reg <span class="sc">+</span> hyd_cdf_qq_reg_ln</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 12512 rows containing non-finite values (`stat_ecdf()`).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 33170 rows containing non-finite values (`stat_ecdf()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="flow_scaling_methods_files/figure-html/unnamed-chunk-63-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>PDF. This is yielding weird spikes just above zero, and I’m not a huge fan of introducing nonmonotonicity. Could we fix that with a different cutoff? It <em>is</em> shifting the zeros. Will need to think more about it. I’ve provided a bottom panel to zoom in to the linear scale near zero to see what kind of flows we’re talking about.</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-64_5c3240a4c871d2a82801bb17b7599be4">
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>hyd_pdf_qq_reg <span class="ot">&lt;-</span> qq_reg <span class="sc">%&gt;%</span></span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">color =</span> scenario)) <span class="sc">+</span></span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>()</span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-5"><a href="#cb130-5" aria-hidden="true" tabindex="-1"></a>hyd_pdf_qq_reg_ln <span class="ot">&lt;-</span> qq_reg <span class="sc">%&gt;%</span></span>
<span id="cb130-6"><a href="#cb130-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(value), <span class="at">color =</span> scenario)) <span class="sc">+</span></span>
<span id="cb130-7"><a href="#cb130-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>()</span>
<span id="cb130-8"><a href="#cb130-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-9"><a href="#cb130-9" aria-hidden="true" tabindex="-1"></a>(hyd_pdf_qq_reg <span class="sc">+</span> hyd_pdf_qq_reg_ln) <span class="sc">/</span>  (hyd_pdf_qq_reg <span class="sc">+</span> <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">500</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 12512 rows containing non-finite values (`stat_density()`).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 33170 rows containing non-finite values (`stat_density()`).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 12512 rows containing non-finite values (`stat_density()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="flow_scaling_methods_files/figure-html/unnamed-chunk-64-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="zeros-2" class="level2">
<h2 class="anchored" data-anchor-id="zeros-2">Zeros</h2>
<p>Now we get almost 500 difference in the number of zeros across the distribution. That’s on par with the regression method, and the overall distribution looks much more like a hydrograph, even with the weird nonmonotonicity at the bottom..</p>
<div class="cell" data-hash="flow_scaling_methods_cache/html/unnamed-chunk-65_cf23e69522a407d65511170a7e9b1dd9">
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a>qq_reg <span class="sc">%&gt;%</span> </span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(scenario) <span class="sc">%&gt;%</span> </span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">n_zeros =</span> <span class="fu">sum</span>(value <span class="sc">==</span> <span class="dv">0</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 8 × 2
  scenario n_zeros
  &lt;chr&gt;      &lt;int&gt;
1 SimR0       2832
2 SimR1       3324
3 SimR2       3079
4 SimR3       2890
5 SimR4       2864
6 SimR5       2843
7 SimR6       2826
8 SimR7          0</code></pre>
</div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">Website, documentation, and toolkit work in progress. Not to be distributed outside QAEL, MDBA, CSIRO</div>   
  </div>
</footer>



</body></html>